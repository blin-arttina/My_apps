<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Book Animator</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  :root{ --bg:#0c0c0c; --panel:#141414; --card:#1a1a1a; --text:#ffffff; --muted:#b9b9b9; --accent:#cc2222; --accent-2:#e24444; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  *{box-sizing:border-box}
  h1{font-weight:800;letter-spacing:.5px;margin:1.5rem 0;text-align:center}
  .wrap{max-width:980px;margin:0 auto;padding:0 1rem 6rem}
  .btn{background:#1b1b1b;color:#fff;border:2px solid var(--accent);border-radius:.8rem;padding:.8rem 1.1rem;cursor:pointer}
  .btn.secondary{border-color:#5a5a5a;color:#ddd}
  .btn:hover{background:var(--accent);border-color:var(--accent-2)}
  .btn.ghost{border-color:#5a5a5a;background:transparent}
  .row{display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
  textarea{width:100%;min-height:300px;background:#0f0f0f;color:#ddd;border:1px solid #333;border-radius:.8rem;padding:1rem;font-size:1rem}
  label{display:block;margin:.75rem 0 .35rem;color:#ddd}
  .topbar{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(0,0,0,.65),transparent);backdrop-filter:saturate(1.2) blur(6px);padding:.5rem .75rem}
  .badges{display:flex;gap:.75rem;justify-content:center;margin:.25rem 0 1rem}
  .badge{padding:.25rem .7rem;border:1px solid #333;border-radius:999px;color:#bbb;font-size:.9rem}
  .hambox{position:fixed;top:.75rem;width:64px;height:64px;border-radius:14px;background:var(--panel);border:1px solid #2a2a2a;display:grid;place-items:center;cursor:pointer;z-index:50}
  .hambox.left{left:.75rem}
  .hambox.right{right:.75rem}
  .ham{width:30px;height:22px;position:relative}
  .ham span{position:absolute;left:0;right:0;height:3px;background:#eee;border-radius:3px;transition:.25s}
  .ham span:nth-child(1){top:0}
  .ham span:nth-child(2){top:9px}
  .ham span:nth-child(3){bottom:0}
  .drawer{position:fixed;inset:0;z-index:60;display:none}
  .drawer.open{display:block}
  .scrim{position:absolute;inset:0;background:rgba(0,0,0,.6)}
  .sheet{position:absolute;top:0;bottom:0;width:min(92vw,440px);background:var(--panel);border-right:1px solid #2a2a2a;overflow:auto}
  .sheet.right{right:0;border-left:1px solid #2a2a2a;border-right:none}
  .sheet h2{margin:1rem 1rem .5rem}
  .list{padding:.25rem 1rem 2rem}
  .item{display:flex;align-items:center;justify-content:space-between;padding:1rem;background:var(--card);border:1px solid #2a2a2a;border-radius:.8rem;margin:.5rem 0}
  .item .title{font-weight:600}
  .small{font-size:.9rem;color:#b9b9b9}
  .subtle{color:#aaa}
  .modal{position:fixed;inset:0;display:none;z-index:80}
  .modal.open{display:grid;place-items:center}
  .modal .bg{position:absolute;inset:0;background:rgba(0,0,0,.55)}
  .modal .box{position:relative;width:min(92vw,900px);max-height:86vh;overflow:auto;background:var(--panel);border:1px solid #303030;border-radius:1rem;padding:1rem}
  .box h3{margin:.25rem 0 1rem}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  @media (max-width:760px){.grid{grid-template-columns:1fr}}
  .footer{position:fixed;left:0;right:0;bottom:0;padding:.6rem .75rem;background:linear-gradient(0deg,rgba(0,0,0,.65),transparent 70%);display:flex;gap:.75rem;align-items:center;z-index:40}
  .meter{flex:1;height:12px;background:#191919;border:1px solid #2f2f2f;border-radius:999px;position:relative;overflow:hidden}
  .meter > i{position:absolute;left:0;top:0;bottom:0;width:0%;background:#fff;transition:width .25s ease}
  .pct{min-width:3ch;text-align:right;color:#999;font-variant-numeric:tabular-nums}
  .thumbs{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.75rem}
  .thumb{width:96px;height:64px;background:#111;border:1px solid #333;border-radius:.5rem;display:grid;place-items:center;color:#777;font-size:.8rem}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.75rem}
  .card{background:#121212;border:1px solid #2a2a2a;border-radius:.8rem;overflow:hidden}
  .card .pic{aspect-ratio:1/1;display:grid;place-items:center;background:#0e0e0e;color:#666;font-size:.9rem}
  .card .body{padding:.6rem .75rem}
  .chip{display:inline-block;padding:.2rem .5rem;border:1px solid #333;border-radius:999px;font-size:.78rem;color:#bbb}
  input,select,textarea{width:100%;padding:.75rem;border:1px solid #333;border-radius:.6rem;background:#0f0f0f;color:#fff}
</style>
</head>
<body>

<!-- Embedded characters JSON for offline use -->
<script id="embedded-characters" type="application/json">[{"name":"Zen Zena \u2013 Guardian of Balance","voice":"Shimmer","age":32,"style":"Semi-realistic fantasy, tranquil and ethereal","image":"./Zen_Zena.png","gallery":[],"appearance":["Long, flowing silver-white hair and calm glowing eyes (blind but perceptive)","Wears layered blue and silver robes, representing harmony and wisdom","Carries a specially crafted blind cane made of white ash wood with glowing runes","Often surrounded by drifting leaves and soft beams of light"],"personality":["Wise, gentle, and grounded \u2014 the moral center of the group","Speaks in calm, thoughtful tones, guiding others to balance","Sees through emotion rather than sight, finding peace in chaos"],"abilities":["Echo Sense: Detects movement and energy through sound and air vibrations","Nature\u2019s Harmony: Calms corrupted or chaotic environments","Spirit Communion: Communicates with natural spirits for protection or insight"],"background":"Born into the Order of the Whispering Grove, Zena lost her vision at birth but gained spiritual perception. Her empathy made her the chosen protector of balance across realms."},{"name":"Darling Danielle \u2013 The Compassionate Knight","voice":"Juniper","age":28,"style":"Noble fantasy realism, radiant and warm","image":"./Darling_Danielle.png","gallery":[],"appearance":["Wavy blonde-brown hair and gentle blue eyes behind round glasses","Wears silver armor over a flowing lavender gown","Visibly pregnant, resting a hand proudly on her belly","Radiates calm strength and maternal warmth"],"personality":["Nurturing, patient, and endlessly brave","Protects not just with her sword but with her heart","Acts as the moral and emotional leader of the group"],"abilities":["Aura of Courage: Inspires allies with unshakable resolve","Guardian\u2019s Blessing: Shields others with divine energy","Light of Life: Her child represents prophecy and renewal"],"background":"A knight of the Silver Banner Order, Danielle left battle to seek peace. Her pregnancy marks the dawn of a new age she vows to protect."},{"name":"Creative Callie \u2013 The Painter of Worlds","voice":"Vale","age":25,"style":"Dreamlike fantasy, artistic and luminous","image":"./Creative_Callie.png","gallery":[],"appearance":["Very long light brown hair, expressive eyes, and paint-stained fingers","Wears robes in teal, gold, and cream with swirling magical patterns","Carries a glowing paintbrush that leaves trails of light in the air"],"personality":["Imaginative, passionate, and a bit scatterbrained","Sees potential and beauty in everything","Loves to create, even when chaos follows"],"abilities":["Reality Brush: Paints objects or landscapes into existence","Chromatic Ward: Creates barriers of color and emotion","Artisan\u2019s Vision: Sees the story behind every object or being"],"background":"A student of the Grand Academy of Artistry and Magic, Callie opened a portal to her own imagination \u2014 and now wields its creative power."},{"name":"Skater Skip \u2013 The Sky Racer","voice":"Breeze","age":22,"style":"Modern fantasy, energetic and confident","image":"./Skater_Skip.png","gallery":["./Skater_Skip_ManBun.png"],"appearance":["Tan, athletic build with long blonde hair tied in a man bun","Wears rune-powered rollerblades and a sleek racing vest","Bright blue eyes and a perpetual grin"],"personality":["Fearless, funny, and endlessly polite","Loves competition but values fairness","A thrill-seeker with a golden heart"],"abilities":["Rift Glide: Skates across dimensional rifts and energy waves","Runic Boost: Enhances speed and reflexes with magic sigils","Time Skip: Briefly slows time to outmaneuver enemies"],"background":"A champion racer from the Neon Spires who competes in magical tournaments across realms, always chasing adventure and helping those left behind."},{"name":"Dark Dan \u2013 The Cursed Bard","voice":"Spruce","age":30,"style":"Gothic fantasy, brooding but magnetic","image":"./Dark_Dan.png","gallery":["./Dark_Dan_Bright.png"],"appearance":["Dark brown hair, shaved sides, long in front over one eye","Gauged ears, nose ring, lip piercing, and sharp blue eyes","Wears dark leather armor with glowing blue runes","Carries his enchanted guitar that channels spectral fire"],"personality":["Sarcastic but loyal, carrying deep emotional scars","Expresses truth through music more than words","Protective of his team, especially the broken-hearted"],"abilities":["Song of Shadows: Summons spectral flames with melody","Harmony of the Dead: Calms or binds restless spirits","Crescendo: Unleashes devastating power through sound"],"background":"Once a famed musician of the Midnight Kingdom, Dan\u2019s music awakened forbidden magic. Now cursed, he roams seeking redemption."},{"name":"Ambush Annie \u2013 The Street Rogue","voice":"Sol","age":23,"style":"Urban fantasy, bold and quick-witted","image":"./Ambush_Annie.png","gallery":[],"appearance":["Short curly red hair, round face, and sharp blue eyes","Curvy, athletic build; wears light leather gear and daggers","Always ready with a smirk or sly grin"],"personality":["Cunning, witty, and fearless","Hides compassion behind sarcasm","Always up for a challenge"],"abilities":["Shadow Step: Teleports short distances between shadows","Quick Trick: Disarms or confuses enemies instantly","Echo Blades: Daggers return when thrown, striking twice"],"background":"A bounty hunter from Sunreach Outskirts who learned survival the hard way, now fights for honor and loyalty over gold."},{"name":"Sidetrack Sally \u2013 The Curious Explorer","voice":"Maple","age":24,"style":"Bright fantasy, lighthearted and hopeful","image":"./Sidetrack_Sally.png","gallery":[],"appearance":["Long blonde hair, bright blue eyes, soft pink outfit","Carries a glowing lantern and travel pack","Cheerful and radiant, always looking for hidden paths"],"personality":["Curious and kind-hearted","Easily distracted but always finds something valuable","Believes every detour leads to destiny"],"abilities":["Lantern of Whispers: Reveals hidden paths or secrets","Echo Memory: Hears lingering voices of history","Serendipity: Luck subtly alters fate in her favor"],"background":"From the quiet village of Fernhollow, Sally discovered the secret tunnels of the Order of the Echoes, setting her on a lifelong adventure."},{"name":"Grumpy Gus \u2013 The Iron Veteran","voice":"Cove","age":48,"style":"Classic dark fantasy, grim yet noble","image":"./Grumpy_Gus.png","gallery":[],"appearance":["Light brown cropped hair, long gray goatee, rugged build","Wears dented steel armor and carries a massive sword","Blue-gray eyes and a weathered, stern face"],"personality":["Gruff but loyal","Short-tempered, secretly caring","Believes in discipline, not speeches"],"abilities":["Iron Will: Immune to fear and mental magic","Shieldbreaker: Destroys enemy defenses","Veteran\u2019s Instinct: Predicts attacks through experience"],"background":"A retired commander of Ironhold Fortress, Gus returned to battle when his homeland was threatened again, grumbling all the way."}]</script>

<div class="hambox left" id="openLeft" aria-label="Open left menu">
  <div class="ham" aria-hidden="true"><span></span><span></span><span></span></div>
</div>
<div class="hambox right" id="openRight" aria-label="Open right menu">
  <div class="ham" aria-hidden="true"><span></span><span></span><span></span></div>
</div>

<div class="topbar">
  <h1>Book Animator</h1>
  <div class="badges">
    <div class="badge" id="modeBadge">Mode: Simple</div>
    <div class="badge" id="scenesBadge">Scenes: 0</div>
  </div>
</div>

<div class="wrap">
  <label for="bookText">Paste your book text:</label>
  <textarea id="bookText" placeholder="Paste text here…"></textarea>

  <div class="row" style="margin-top:1rem">
    <button class="btn" id="startBtn">Start Animation</button>
    <button class="btn ghost" id="previewBtn">Preview Scenes</button>
  </div>

  <div id="thumbStrip" class="thumbs" aria-live="polite"></div>
</div>

<div class="footer">
  <button class="btn secondary" id="saveBtn">Save</button>
  <button class="btn" id="exportBtn">Export Finished (ZIP)</button>
  <div class="meter"><i id="meterFill"></i></div>
  <div class="pct" id="pct">0%</div>
</div>

<div class="drawer" id="leftDrawer" aria-modal="true">
  <div class="scrim" data-close="left"></div>
  <aside class="sheet">
    <h2>Menu</h2>
    <div class="list">
      <div class="item"><div><div class="title">Characters</div><div class="small">Create & edit profiles</div></div><button class="btn ghost" data-open="characters">Open</button></div>
      <div class="item"><div><div class="title">Voices</div><div class="small">Select TTS / map to characters</div></div><button class="btn ghost" data-open="voices">Open</button></div>
      <div class="item"><div><div class="title">Settings</div><div class="small">Animation type, art style, audience</div></div><button class="btn ghost" data-open="settings">Open</button></div>
      <div class="item"><div><div class="title">Secrets (API Keys)</div><div class="small">Store provider keys locally</div></div><button class="btn ghost" data-open="secrets">Open</button></div>
      <div class="item"><div><div class="title">Help</div><div class="small">Short guide</div></div><button class="btn ghost" data-open="help">Open</button></div>
    </div>
  </aside>
</div>

<div class="drawer" id="rightDrawer" aria-modal="true">
  <div class="scrim" data-close="right"></div>
  <aside class="sheet right">
    <h2>Project</h2>
    <div class="list">
      <div class="item"><div class="title">New Project</div><button class="btn ghost" id="newBtn">New</button></div>
      <div class="item"><div class="title">Open Project (JSON)</div><button class="btn ghost" id="openBtn">Open</button></div>
      <div class="item"><div class="title">Save</div><button class="btn ghost" id="saveBtn2">Save</button></div>
      <div class="item"><div class="title">Upload Files (txt/doc/pdf/img)</div><button class="btn ghost" id="uploadBtn">Upload</button></div>
      <div class="item"><div class="title">Export Finished (ZIP)</div><button class="btn ghost" id="exportBtn2">Export</button></div>
      <div class="item"><div class="title subtle">Exit</div><button class="btn ghost" id="exitBtn">Close</button></div>
    </div>
  </aside>
</div>

<div class="modal" id="charactersModal">
  <div class="bg" data-close="characters"></div>
  <div class="box">
    <h3>Characters</h3>
    <div class="row" style="justify-content:space-between;margin-bottom:.5rem">
      <div class="small">Click a card image to open the character’s bio.</div>
      <div>
        <button class="btn ghost" id="importCharJsonBtn">Import Characters JSON</button>
        <input id="charJsonFile" type="file" accept="application/json" hidden>
      </div>
    </div>
    <div id="charGallery" class="cards" style="margin-bottom:1rem;"></div>
    <div id="charList"></div>
    <hr style="border-color:#2b2b2b;margin:1rem 0">
    <button class="btn" id="addChar">Add Character</button>
  </div>
</div>

<div class="modal" id="bioModal">
  <div class="bg" data-close="bio"></div>
  <div class="box" id="bioBox"></div>
</div>

<div class="modal" id="editCharModal">
  <div class="bg" data-close="editChar"></div>
  <div class="box">
    <h3 id="editCharTitle">Edit Character</h3>
    <div class="grid">
      <div>
        <label>Name</label>
        <input id="charName" type="text">
        <label style="margin-top:.6rem">Voice (OpenAI id)</label>
        <input id="charVoice" type="text" placeholder="e.g., ember, nova, shimmer">
        <label style="margin-top:.6rem">Age</label>
        <input id="charAge" type="number" min="0">
        <label style="margin-top:.6rem">Thumbnail</label>
        <input id="charImg" type="file" accept="image/*,application/pdf" />
        <div id="charImgPreview" class="thumb" style="margin-top:.5rem">thumbnail</div>
      </div>
      <div>
        <label>Traits / Backstory</label>
        <textarea id="charNotes" style="min-height:260px"></textarea>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:1rem">
      <button class="btn secondary" data-close="editChar">Cancel</button>
      <button class="btn" id="saveChar">Save</button>
    </div>
  </div>
</div>

<div class="modal" id="voicesModal">
  <div class="bg" data-close="voices"></div>
  <div class="box">
    <h3>Voices</h3>
    <p class="small">Assign OpenAI-style voice ids to characters. (Stored locally.)</p>
    <div id="voiceList"></div>
    <div class="row" style="justify-content:flex-end;margin-top:1rem">
      <button class="btn" data-close="voices">Close</button>
    </div>
  </div>
</div>

<div class="modal" id="settingsModal">
  <div class="bg" data-close="settings"></div>
  <div class="box">
    <h3>Settings</h3>
    <div class="grid">
      <div>
        <label>Animation Type</label>
        <select id="optAnim">
          <option>Cartoon (Ken Burns)</option>
          <option>Flip-Book (Low FPS)</option>
          <option>Comic Panels</option>
          <option>Anime Portraits</option>
          <option>Dark Fantasy</option>
          <option>Cinematic Photoreal</option>
          <option>Sketch / Pencil</option>
          <option>Watercolor</option>
          <option>Pixel Art</option>
        </select>
        <label style="margin-top:.6rem">Art Style</label>
        <select id="optArt">
          <option>Clean Lines</option>
          <option>Ink & Wash</option>
          <option>Painterly Brush</option>
          <option>Cel Shaded</option>
          <option>Grainy Film</option>
          <option>Comic Halftone</option>
          <option>Crayon / Children’s Book</option>
        </select>
        <label style="margin-top:.6rem">Target Audience (Age)</label>
        <select id="optAge">
          <option>4–7</option><option>8–12</option><option>13–17</option><option>18+</option>
        </select>
      </div>
      <div>
        <label>Aspect Ratio</label>
        <select id="optAspect"><option>16:9</option><option>9:16</option><option>1:1</option></select>
        <label style="margin-top:.6rem">FPS</label>
        <select id="optFps"><option>12</option><option>24</option><option>30</option></select>
        <label style="margin-top:.6rem">Accent Color</label>
        <input id="optColor" type="color" value="#cc2222" style="height:44px">
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:1rem">
      <button class="btn secondary" data-close="settings">Close</button>
      <button class="btn" id="saveSettings">Save</button>
    </div>
  </div>
</div>

<div class="modal" id="secretsModal">
  <div class="bg" data-close="secrets"></div>
  <div class="box">
    <h3>Secrets (API Keys)</h3>
    <div class="grid">
      <div>
        <label>OpenAI (TTS / images)</label>
        <input id="kOpenAI" placeholder="sk-...">
        <label style="margin-top:.6rem">ElevenLabs (optional)</label>
        <input id="k11" placeholder="elevenlabs_...">
        <label style="margin-top:.6rem">Other API (name=value lines)</label>
        <textarea id="kOther" style="min-height:120px"></textarea>
      </div>
      <div>
        <p class="small">Keys are saved locally in your browser (localStorage). Do not share this device if you need confidentiality.</p>
        <button class="btn" id="saveKeys">Save Keys</button>
        <button class="btn secondary" id="clearKeys" style="margin-left:.5rem">Clear</button>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:1rem">
      <button class="btn secondary" data-close="secrets">Close</button>
    </div>
  </div>
</div>

<div class="modal" id="helpModal">
  <div class="bg" data-close="help"></div>
  <div class="box">
    <h3>Help</h3>
    <ol class="small">
      <li>Paste your book text.</li>
      <li>Open <b>Characters</b> → add/edit characters, set voice, age, traits, thumbnail. Clicking a character card opens their bio.</li>
      <li>Open <b>Settings</b> → choose Animation Type, Art Style, Audience, Aspect, FPS.</li>
      <li>Click <b>Start Animation</b>. You’ll see scene thumbnails and a white progress bar with %.</li>
      <li>Use <b>Export ZIP</b> to download project data.</li>
    </ol>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" data-close="help">Close</button>
    </div>
  </div>
</div>

<input id="fileOpen" type="file" accept="application/json" hidden>
<input id="fileUpload" type="file" accept=".txt,.doc,.docx,.pdf,.png,.jpg,.jpeg,.webp" multiple hidden>
<input id="charJsonLocal" type="file" accept="application/json" hidden>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);
  const LS = { load:(k,d)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? d}catch{return d} }, save:(k,v)=>localStorage.setItem(k, JSON.stringify(v)) };

  // ---------- State ----------
  let state = LS.load('ba_state', {
    text:"",
    scenes:[],
    settings:{ anim:'Cartoon (Ken Burns)', art:'Clean Lines', age:'8–12', aspect:'16:9', fps:24, color:'#cc2222' },
    voices:[{id:'ember', name:'Ember'},{id:'nova', name:'Nova'},{id:'shimmer',name:'Shimmer'},{id:'coral',name:'Coral'},{id:'verse',name:'Verse'},{id:'canyon',name:'Canyon'},{id:'flux',name:'Flux'},{id:'mono',name:'Mono'},{id:'alloy',name:'Alloy'},{id:'maple',name:'Maple'},{id:'juniper',name:'Juniper'},{id:'spruce',name:'Spruce'},{id:'vale',name:'Vale'},{id:'cove',name:'Cove'},{id:'sol',name:'Sol'},{id:'breeze',name:'Breeze'}],
    characters:[],
    secrets: LS.load('ba_secrets',{openai:'', eleven:'', other:''})
  });

  const elText = $('#bookText'); const meter = $('#meterFill'); const pct = $('#pct'); const strip = $('#thumbStrip');
  elText.value = state.text || '';
  applyThemeColor(state.settings.color || '#cc2222');
  updateBadges();

  // Load embedded characters JSON (offline) first, then try network Character.json (optional override)
  try {
    const embedded = document.getElementById('embedded-characters')?.textContent || '[]';
    const raw = JSON.parse(embedded);
    const chars = transformCharacterJSON(raw);
    if(chars.length && (!state.characters || !state.characters.length)){
      state.characters = chars; saveState();
    } else if(chars.length){
      // Merge on name if new
      const byName = new Map(state.characters.map(c=>[c.name.toLowerCase(), c]));
      for(const c of chars){
        const key=(c.name||'').toLowerCase();
        if(key && !byName.has(key)) state.characters.push(c);
      }
      saveState();
    }
  } catch(e){ /* ignore */ }

  // Try to auto-load Character.json from network (if provided)
  (async function tryAutoLoad(){
    try{
      const res = await fetch('Character.json', { cache:'no-store' });
      if(res.ok){
        const data = await res.json();
        const chars = transformCharacterJSON(data);
        if(chars.length){ state.characters = chars; saveState(); }
      }
    }catch(e){ /* ignore */ }
  })();

  // ---------- Drawers ----------
  $('#openLeft').onclick = ()=> openDrawer('left');
  $('#openRight').onclick = ()=> openDrawer('right');
  $$('#leftDrawer .scrim, #rightDrawer .scrim').forEach(s => s.onclick = e => closeDrawer(e.target.dataset.close));
  $('#leftDrawer').addEventListener('click', e=>{
    const btn = e.target.closest('[data-open]'); if(!btn) return;
    const name = btn.dataset.open; closeDrawer('left'); openModal('#'+name+'Modal');
    if(name==='characters'){ renderCharacterGallery(); renderCharacters(); }
    if(name==='voices'){ renderVoices(); }
    if(name==='settings'){ loadSettingsIntoUI(); }
    if(name==='secrets'){ loadSecretsIntoUI(); }
  });

  // Right drawer actions
  $('#newBtn').onclick = ()=>{ if(confirm('Clear current project?')){ state.scenes=[]; state.text=''; elText.value=''; strip.innerHTML=''; updateBadges(); saveState(); } };
  $('#openBtn').onclick = ()=> $('#fileOpen').click();
  $('#saveBtn2').onclick = ()=> $('#saveBtn').click();
  $('#uploadBtn').onclick = ()=> $('#fileUpload').click();
  $('#exportBtn2').onclick = ()=> $('#exportBtn').click();
  $('#exitBtn').onclick = ()=> closeDrawer('right');
  $('#fileOpen').onchange = e => { const f=e.target.files[0]; if(!f) return; f.text().then(t=>{ try{ state=JSON.parse(t); LS.save('ba_state',state); location.reload(); }catch{ alert('Invalid project JSON') } }); };
  $('#fileUpload').onchange = e => { if(!e.target.files.length) return; alert(`${e.target.files.length} file(s) selected.`); };

  function openDrawer(side){ (side==='left'?$('#leftDrawer'):$('#rightDrawer')).classList.add('open') }
  function closeDrawer(side){ (side==='left'?$('#leftDrawer'):$('#rightDrawer')).classList.remove('open') }

  // ---------- Modals helpers ----------
  function openModal(id){ $(id).classList.add('open') }
  function closeModal(id){ $(id).classList.remove('open') }
  document.body.addEventListener('click', e=>{
    const id = e.target.dataset.close;
    if(!id) return;
    if(id==='left'||id==='right'){ closeDrawer(id); return; }
    closeModal('#'+id+'Modal');
  });

  // ---------- Characters ----------
  function renderCharacterGallery(){
    const g = $('#charGallery'); g.innerHTML='';
    (state.characters||[]).forEach((c,i)=>{
      const card = document.createElement('div'); card.className='card';
      const pic = document.createElement('div'); pic.className='pic'; pic.textContent='image';
      if(c.img){ pic.style.backgroundImage=`url(${c.img})`; pic.style.backgroundSize='cover'; pic.textContent=''; }
      pic.style.cursor='pointer'; pic.title='Open Bio'; pic.onclick=()=> openBio(i);
      const body = document.createElement('div'); body.className='body';
      body.innerHTML = `<div style="font-weight:700">${escapeHTML(c.name)}</div>
                        <div style="margin:.35rem 0" class="chip">${escapeHTML(c.voice||'?')}</div>
                        <div class="small">Age ${c.age??'?'}</div>`;
      card.append(pic, body); g.append(card);
    });
  }
  function openBio(i){
    const c = state.characters[i]; if(!c) return;
    const gallery = (c.gallery && Array.isArray(c.gallery)) ? c.gallery : [];
    const galleryHTML = gallery.map((u,ix)=>`<div class="thumb" style="width:120px;height:80px;background:url('${u}') center/cover no-repeat" title="Image ${ix+1}"></div>`).join('');
    const box = $('#bioBox'); box.innerHTML = `
      <h3>${escapeHTML(c.name)}</h3>
      <div class="grid">
        <div>
          <div class="thumb" style="width:100%;height:220px;${c.img?`background:url(${c.img}) center/cover no-repeat;`:'display:grid;place-items:center' }">${c.img?'':'no image'}</div>
          <p style="margin-top:.5rem"><span class="chip">Voice: ${escapeHTML(c.voice||'?')}</span> &nbsp; <span class="chip">Age: ${c.age??'?'}</span></p>
          ${galleryHTML?`<div class="row" style="margin-top:.5rem;flex-wrap:wrap">${galleryHTML}</div>`:''}
        </div>
        <div>
          <label>Style</label>
          <div style="white-space:pre-wrap;background:#0f0f0f;border:1px solid #333;border-radius:.6rem;padding:.7rem">${escapeHTML(c.style||'—')}</div>
          <label style="margin-top:.6rem">Appearance</label>
          <div style="white-space:pre-wrap;background:#0f0f0f;border:1px solid #333;border-radius:.6rem;padding:.7rem">${escapeHTML((Array.isArray(c.appearance)?c.appearance.join('\n'):(c.appearance||''))||'—')}</div>
          <label style="margin-top:.6rem">Personality</label>
          <div style="white-space:pre-wrap;background:#0f0f0f;border:1px solid #333;border-radius:.6rem;padding:.7rem">${escapeHTML((Array.isArray(c.personality)?c.personality.join('\n'):(c.personality||''))||'—')}</div>
          <label style="margin-top:.6rem">Abilities</label>
          <div style="white-space:pre-wrap;background:#0f0f0f;border:1px solid #333;border-radius:.6rem;padding:.7rem">${escapeHTML((Array.isArray(c.abilities)?c.abilities.join('\n'):(c.abilities||''))||'—')}</div>
          <label style="margin-top:.6rem">Background</label>
          <div style="white-space:pre-wrap;background:#0f0f0f;border:1px solid #333;border-radius:.6rem;padding:.7rem">${escapeHTML((Array.isArray(c.background)?c.background.join('\n'):(c.background||''))||'—')}</div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:1rem">
        <button class="btn" data-close="bio">Close</button>
      </div>`;
    openModal('#bioModal');
  }
  function renderCharacters(){
    const host = $('#charList'); host.innerHTML='';
    (state.characters||[]).forEach((c,idx)=>{
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `
        <div>
          <div class="title">${escapeHTML(c.name)}</div>
          <div class="small">${c.voice || 'voice ?'} · Age ${c.age??'?'}</div>
        </div>
        <div class="row">
          <button class="btn ghost" data-bio="${idx}">Bio</button>
          <button class="btn ghost" data-edit="${idx}">Edit</button>
        </div>`;
      host.appendChild(row);
    });
    host.onclick = e=>{
      const b = e.target.closest('[data-edit]'); const d=e.target.closest('[data-bio]');
      if(b) openEditCharacter(+b.dataset.edit);
      if(d) openBio(+d.dataset.bio);
    };
    $('#addChar').onclick = ()=>{ state.characters.push({id:crypto.randomUUID(),name:'New Character',voice:'',age:0,notes:'',img:''}); renderCharacterGallery(); renderCharacters(); saveState(); };
  }
  function openEditCharacter(i){
    const c = state.characters[i]; if(!c) return;
    $('#editCharTitle').textContent = `Edit Character`;
    $('#charName').value = c.name || '';
    $('#charAge').value = c.age || 0;
    $('#charNotes').value = c.notes || '';
    $('#charVoice').value = c.voice || '';
    const prev = $('#charImgPreview');
    prev.textContent='thumbnail'; prev.style.background=''; prev.style.backgroundSize='cover';
    if(c.img){ prev.style.background=`url(${c.img}) center/cover no-repeat`; prev.textContent=''; }
    $('#charImg').value='';
    $('#charImg').onchange = e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ prev.style.background=`url(${r.result}) center/cover no-repeat`; prev.textContent=''; prev.dataset.dataUrl=r.result; };
      r.readAsDataURL(f);
    };
    $('#saveChar').onclick = ()=>{
      c.name = $('#charName').value.trim() || c.name;
      c.age = +($('#charAge').value||0);
      c.notes = $('#charNotes').value;
      c.voice = $('#charVoice').value.trim();
      if($('#charImgPreview').dataset.dataUrl){ c.img = $('#charImgPreview').dataset.dataUrl; }
      saveState(); renderCharacterGallery(); renderCharacters(); closeModal('#editCharModal');
    };
    $('[data-close="editChar"]').onclick = ()=> closeModal('#editCharModal');
    openModal('#editCharModal');
  }

  // Import Characters JSON (manual)
  $('#importCharJsonBtn').onclick = ()=> $('#charJsonFile').click();
  $('#charJsonFile').onchange = e=>{
    const f = e.target.files[0]; if(!f) return;
    f.text().then(t=>{
      try{
        const data = JSON.parse(t);
        const chars = transformCharacterJSON(data);
        if(chars.length){ state.characters = chars; saveState(); renderCharacterGallery(); renderCharacters(); alert('Characters imported.'); }
        else{ alert('Could not find characters in this JSON.'); }
      }catch{ alert('Invalid JSON file.'); }
    });
  };

  // Voices
  function renderVoices(){
    const host = $('#voiceList'); host.innerHTML='';
    (state.characters||[]).forEach((c,i)=>{
      const row = document.createElement('div'); row.className='item';
      const sel = document.createElement('select'); sel.style.padding='.5rem'; sel.style.background='#0f0f0f'; sel.style.color='#fff'; sel.style.border='1px solid #333';
      state.voices.forEach(v=>{
        const o=document.createElement('option'); o.value=v.id; o.textContent=`${v.name} (${v.id})`; if((c.voice||'')===v.id) o.selected=true; sel.appendChild(o);
      });
      sel.onchange = ()=>{ state.characters[i].voice = sel.value; saveState(); renderCharacters(); renderCharacterGallery(); };
      row.innerHTML = `<div><div class="title">${escapeHTML(c.name)}</div><div class="small">Current: ${escapeHTML(c.voice||'?')}</div></div>`;
      row.appendChild(sel); host.appendChild(row);
    });
  }

  // Settings & Secrets
  function loadSettingsIntoUI(){
    $('#optAnim').value = state.settings.anim;
    $('#optArt').value = state.settings.art;
    $('#optAge').value = state.settings.age;
    $('#optAspect').value = state.settings.aspect;
    $('#optFps').value = String(state.settings.fps);
    $('#optColor').value = state.settings.color || '#cc2222';
  }
  $('#saveSettings').onclick = ()=>{
    state.settings.anim = $('#optAnim').value;
    state.settings.art  = $('#optArt').value;
    state.settings.age  = $('#optAge').value;
    state.settings.aspect = $('#optAspect').value;
    state.settings.fps = +$('#optFps').value;
    state.settings.color = $('#optColor').value;
    applyThemeColor(state.settings.color);
    saveState(); closeModal('#settingsModal');
  };
  function loadSecretsIntoUI(){ const s=state.secrets||{}; $('#kOpenAI').value=s.openai||''; $('#k11').value=s.eleven||''; $('#kOther').value=s.other||''; }
  $('#saveKeys').onclick = ()=>{ state.secrets={openai:$('#kOpenAI').value.trim(), eleven:$('#k11').value.trim(), other:$('#kOther').value}; LS.save('ba_secrets',state.secrets); saveState(); alert('Keys saved locally.'); };
  $('#clearKeys').onclick = ()=>{ if(confirm('Clear stored keys?')){ state.secrets={openai:'',eleven:'',other:''}; LS.save('ba_secrets',state.secrets); saveState(); loadSecretsIntoUI(); } };

  // Start / Preview
  $('#startBtn').onclick = ()=>{
    const text = elText.value.trim(); if(!text){ alert('Paste some text first.'); return; }
    state.text = text;
    state.scenes = text.split(/\n\s*\n/).filter(x=>x.trim()).map((t,i)=>({i, text:t.trim()}));
    updateBadges(); saveState();
    strip.innerHTML='';
    let i=0, total=state.scenes.length||1;
    const tick=()=>{
      if(i>=total) return;
      const th=document.createElement('div'); th.className='thumb'; th.textContent='…'; th.title=`Scene ${i+1}`; strip.appendChild(th);
      setTimeout(()=>{
        th.textContent='';
        th.style.background=`#111 url('data:image/svg+xml;utf8,${encodeURIComponent(svgThumb(i+1,state.scenes[i].text))}') center/cover no-repeat`;
        i++; const p=Math.round(i/total*100); meter.style.width=p+'%'; pct.textContent=p+'%';
        if(i<total) tick();
      },350);
    };
    meter.style.width='0%'; pct.textContent='0%'; tick();
  };
  $('#previewBtn').onclick = ()=> alert(`Scenes detected: ${state.scenes.length}\n(Thumbnails show as scenes are processed.)`);

  // Save / Export
  function saveState(){ state.text = elText.value; LS.save('ba_state', state); }
  $('#saveBtn').onclick = ()=>{ saveState(); alert('Saved locally.'); };
  $('#exportBtn').onclick = async ()=>{
    saveState();
    const zip = new JSZip();
    zip.file('project.json', JSON.stringify(state,null,2));
    (state.characters||[]).forEach((c,idx)=>{
      if(c.img && /^data:image\//.test(c.img)){
        zip.file(`images/char_${idx+1}_${(c.name||'').replace(/\W+/g,'_')}.png`, c.img.split(',')[1], {base64:true});
      }
    });
    const blob = await zip.generateAsync({type:'blob'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='BookAnimator_Project.zip'; a.click(); URL.revokeObjectURL(a.href);
  };

  // Utils
  function updateBadges(){ $('#scenesBadge').textContent = `Scenes: ${state.scenes.length||0}`; }
  function applyThemeColor(hex){ document.documentElement.style.setProperty('--accent', hex||'#cc2222'); }
  function escapeHTML(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function svgThumb(n, text){
    const words=(text||'').toLowerCase().match(/[a-z]{4,}/g)||[];
    const key=(words.slice(0,3).join(' ')||'scene').replace(/&/g,'&amp;');
    return `
      <svg xmlns='http://www.w3.org/2000/svg' width='240' height='160'>
        <defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0' stop-color='%23141414'/><stop offset='1' stop-color='%23101010'/></linearGradient></defs>
        <rect width='100%' height='100%' fill='url(#g)'/>
        <rect x='10' y='10' width='220' height='140' rx='10' ry='10' fill='none' stroke='%23ffffff' stroke-opacity='.65'/>
        <text x='16' y='32' font-family='monospace' font-size='14' fill='%23fff'>Scene ${n}</text>
        <text x='16' y='56' font-family='monospace' font-size='12' fill='%23bbbbbb'>${key}</text>
      </svg>`;
  }

  // Character.json transformer for your schema
  function transformCharacterJSON(raw){ 
    let arr = [];
    if(Array.isArray(raw)) arr = raw;
    else if(raw && Array.isArray(raw.characters)) arr = raw.characters;
    else if(raw && Array.isArray(raw.data)) arr = raw.data;
    else if(raw && typeof raw === 'object') arr = Object.values(raw);

    return arr.map((x,idx)=>({
      id: x.id || crypto.randomUUID(),
      name: x.name || x.fullName || x.title || `Character ${idx+1}`,
      voice: x.voice || x.voiceId || x.voice_id || '',
      age: x.age ?? x.years ?? '',
      style: x.style || '',
      notes: x.notes || x.description || x.bio || x.backstory || '',
      appearance: x.appearance || [],
      personality: x.personality || [],
      abilities: x.abilities || [],
      background: x.background || [],
      gallery: x.gallery || [],
      img: x.image || x.img || x.thumbnail || x.picture || x.path || ''
    }));
  }

})();
</script>
</body>
</html>
