<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Book Animator</title>
<style>
  :root{ --bg:#0b0b0b; --panel:#111; --ink:#eee; --muted:#bbb; --line:#333; --accent:#ef4444; --ok:#34d399; --warn:#f59e0b; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;}
  h1{font-size:2.2rem;margin:.6rem 0;text-align:center;display:flex;align-items:center;justify-content:center;gap:.6rem}
  .wrap{max-width:1200px;margin:0 auto;padding:1rem;}
  .panel{background:var(--panel);border:1px solid var(--line);padding:1rem;border-radius:1rem;margin-bottom:1rem;}
  .item{margin-bottom:.8rem;display:flex;flex-direction:column;}
  .item span{font-weight:600;margin-bottom:.4rem;}
  button{background:var(--accent);border:none;color:var(--ink);padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;font-size:1rem;}
  button:hover{opacity:.9;}
  select,input,textarea{background:#222;color:var(--ink);border:1px solid var(--line);border-radius:.4rem;padding:.45rem;}
  textarea{resize:vertical;}
  #charList{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:.8rem;}
  .charCard{background:#1a1a1a;border:1px solid var(--line); border-radius:.8rem;padding:.6rem;text-align:center;cursor:pointer;position:relative;}
  .charCard:hover{border-color:var(--accent);}
  .charVoice{font-size:.9rem;color:var(--muted);}
  .playBtn{position:absolute;top:.4rem;right:.5rem;background:var(--ok); color:#000;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-weight:bold;}
  .status{margin-top:.5rem;font-size:.9rem;color:var(--muted);}
  #autosaveStatus{font-size:.85rem;color:var(--muted);text-align:center;margin-top:.5rem;}
  footer{text-align:center;color:var(--muted);margin:1rem 0;font-size:.85rem;}
  .topbar{position:sticky;top:0;background:var(--bg);z-index:20;border-bottom:1px solid var(--line);padding:.4rem .6rem;display:flex;align-items:center;gap:.6rem}
  .hamburger{background:#222;border:1px solid var(--line);color:var(--ink);width:38px;height:38px;border-radius:.5rem;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.2rem;}
  .sidebar{position:fixed;left:0;top:0;bottom:0;width:280px;background:#0f0f0f;border-right:1px solid var(--line);transform:translateX(-100%);transition:transform .25s ease;z-index:30;padding:1rem .8rem;box-shadow:2px 0 12px rgba(0,0,0,.35);}
  .sidebar.open{transform:translateX(0);}
  .navbtn{width:100%;text-align:left;background:#1a1a1a;border:1px solid var(--line);margin-bottom:.6rem;padding:.6rem .7rem;border-radius:.6rem;cursor:pointer;}
  .navbtn.active{border-color:var(--accent);}
  .warning{background:#3b1f1f;color:#ffd6d6;border:1px solid #a33;padding:.6rem;border-radius:.6rem;margin-bottom:.8rem;display:none;}
  .secretGrid{display:grid;grid-template-columns:13rem 1fr;gap:.6rem;align-items:center;}
  .row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;}
  /* Scenes grid */
  #sceneGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.6rem}
  .sceneCard{background:#1a1a1a;border:1px solid #333;border-radius:.6rem;padding:.5rem}
  .sceneCard img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:.4rem;background:#0003}
</style>
</head>
<body>
  <div class="topbar">
    <button id="btnHamburger" class="hamburger" aria-label="Menu">‚ò∞</button>
    <h1>üìö Book Animator</h1>
  </div>

  <aside id="sidebar" class="sidebar" aria-hidden="true">
    <button class="navbtn" data-target="viewCharacters">Characters</button>
    <button class="navbtn" data-target="viewUploads">Uploads</button>
    <button class="navbtn" data-target="viewSecrets">Secrets</button>
    <button class="navbtn" data-target="viewSettings">Settings</button>
  </aside>

  <div class="wrap">
    <section id="viewCharacters" class="panel">
      <h2>Characters</h2>
      <div id="charList"></div>
      <button id="btnAddChar">+ Add Character</button>
      <div class="row" style="margin-top:.6rem">
        <button id="btnPreviewScenes">Preview Scenes</button>
        <button id="btnStartAnimation">Start Animation</button>
      </div>
      <div id="sceneGrid" style="margin-top:.8rem"></div>
      <div id="autosaveStatus">Autosave ready</div>
    </section>

    <section id="viewUploads" class="panel" style="display:none">
      <h2>Uploads</h2>
      <label class="item">
        <span>Music Uploads</span>
        <input id="fileMusic" type="file" accept="audio/*" multiple/>
      </label>
      <label class="item">
        <span>General Uploads</span>
        <input id="fileGeneral" type="file" accept="*/*" multiple/>
      </label>
      <div id="uploadList" class="status">No files uploaded yet.</div>
    </section>

    <section id="viewSecrets" class="panel" style="display:none">
      <h2>Secrets</h2>
      <div id="storageWarning" class="warning">Storage is blocked. Keys cannot be saved. Allow cookies/storage or disable ‚Äúclear on exit‚Äù.</div>
      <div class="secretGrid">
        <label for="secProxy">Cloudflare Proxy URL</label><input id="secProxy" type="text" placeholder="https://ai-proxydjs.blindart2020.workers.dev"/>
        <label for="secOpenAI">OpenAI API Key</label><input id="secOpenAI" type="password" placeholder="sk-..."/>
        <label for="secEleven">ElevenLabs API Key</label><input id="secEleven" type="password" placeholder="eleven-..."/>
        <label for="secFreesound">FreeSound API Key</label><input id="secFreesound" type="password" placeholder="freesound-..."/>
        <label for="secHF">Hugging Face Token</label><input id="secHF" type="password" placeholder="hf_..."/>
        <label for="secStability">Stability/DreamStudio</label><input id="secStability" type="password" placeholder="sk-stability-..."/>
        <label for="secCustom1">Custom Token 1</label><input id="secCustom1" type="password" placeholder="custom-1"/>
        <label for="secCustom2">Custom Token 2</label><input id="secCustom2" type="password" placeholder="custom-2"/>
        <label for="secCustom3">Custom Token 3</label><input id="secCustom3" type="password" placeholder="custom-3"/>
      </div>
      <div class="row" style="margin-top:.8rem">
        <button id="btnSaveSecrets">Save Secrets</button>
        <button id="btnClearSecrets" style="background:var(--warn)">Clear</button>
        <button id="btnExportSecrets">Export (.json)</button>
        <label class="item" style="margin:0">
          <input id="fileImportSecrets" type="file" accept="application/json" style="display:none"/>
          <button id="btnImportSecrets">Import (.json)</button>
        </label>
      </div>
      <p class="status">Keys are stored locally in <code>localStorage</code> and never uploaded by this page.</p>
    </section>

    <section id="viewSettings" class="panel" style="display:none">
      <h2>Settings</h2>
      <div class="secretGrid">
        <label for="setAutosave">Autosave Interval</label>
        <select id="setAutosave">
          <option value="5">Every 5 minutes</option>
          <option value="10" selected>Every 10 minutes</option>
          <option value="15">Every 15 minutes</option>
        </select>
        <label for="setAutoPreview">Auto-preview on open</label>
        <select id="setAutoPreview">
          <option value="off" selected>Off</option>
          <option value="on">On</option>
        </select>
      </div>
      <div class="row" style="margin-top:.8rem">
        <button id="btnSaveSettings">Save Settings</button>
        <button id="btnResetDefault" style="background:var(--warn)">Reset to Defaults</button>
      </div>
    </section>
  </div>

  <dialog id="charEditor" style="background:#111;border:1px solid var(--line);
    border-radius:1rem;padding:1.2rem;width:420px;max-width:92%;">
    <h3>Edit Character</h3>
    <label class="item"><span>Name</span><input id="ceName" type="text"/></label>
    <label class="item"><span>Notes</span><textarea id="ceNotes" rows="3"></textarea></label>
    <label class="item" style="display:grid;grid-template-columns:10rem 1fr;gap:.6rem">
      <span>Voice (OpenAI)</span>
      <select id="ceVoice">
        <option value="ember">Ember</option>
        <option value="maple">Maple</option>
        <option value="juniper">Juniper</option>
        <option value="sage">Sage</option>
        <option value="alloy">Alloy</option>
        <option value="verse">Verse</option>
        <option value="aria">Aria</option>
        <option value="amber">Amber</option>
        <option value="spruce">Spruce</option>
        <option value="breeze">Breeze</option>
        <option value="vale">Vale</option>
        <option value="shimmer">Shimmer</option>
        <option value="cove">Cove</option>
        <option value="sol">Sol</option>
      </select>
    </label>
    <label class="item"><span>Eleven Labs Voice ID (optional)</span><input id="ceEleven" type="text" placeholder="(optional)"/></label>
    <div style="text-align:right;margin-top:.8rem;"><button id="ceSave">Save</button><button id="ceCancel" style="background:var(--warn)">Cancel</button></div>
  </dialog>

  <footer>Book Animator ‚Ä¢ Auto SFX via FreeSound + Narration via TTS</footer>

<script>
/* ===== KEYS & STORAGE ===== */
const LS_DATA="bookAnimatorData",LS_SECRETS="bookAnimatorSecrets",LS_SETTINGS="bookAnimatorSettings";
function storageWritable(){try{const k="__ba_test__"+Math.random();localStorage.setItem(k,"1");const ok=localStorage.getItem(k)==="1";localStorage.removeItem(k);return !!ok;}catch(e){return false;}}
function getSecrets(){try{return JSON.parse(localStorage.getItem(LS_SECRETS)||"{}");}catch(e){return {};}}

/* ===== SIDEBAR ===== */
const sidebar=document.getElementById("sidebar");
document.getElementById("btnHamburger").onclick=()=>sidebar.classList.toggle("open");
[...document.querySelectorAll(".navbtn")].forEach(btn=>{
  btn.onclick=()=>{document.querySelectorAll("section.panel").forEach(s=>s.style.display="none");document.getElementById(btn.dataset.target).style.display="";[...document.querySelectorAll(".navbtn")].forEach(b=>b.classList.remove("active"));btn.classList.add("active");sidebar.classList.remove("open");};
});
document.querySelector('.navbtn[data-target="viewCharacters"]').classList.add("active");

/* ===== CHARACTERS ===== */
let characters=[];const charList=document.getElementById("charList");const editor=document.getElementById("charEditor");const autosaveStatus=document.getElementById("autosaveStatus");
function defaultCharacters(){const base=['Narrator','Sidetracked Sally','Darling Danielle','Dark Dan','Skater Skip','Creative Callie','Zen Zena','Grumpy Gus','Ambush Annie'];const map={'narrator':'ember','sidetracked sally':'maple','darling danielle':'juniper','dark dan':'spruce','skater skip':'breeze','creative callie':'vale','zen zena':'shimmer','grumpy gus':'cove','ambush annie':'sol'};return base.map(n=>({name:n,notes:'',voice:map[n.toLowerCase()]||'ember',eleven:''}));}
function renderCharacters(){charList.innerHTML="";characters.forEach((c,i)=>{const div=document.createElement("div");div.className="charCard";div.innerHTML=`<div>${c.name}</div><div class="charVoice">${c.voice}</div><button class="playBtn" title="Preview Voice">üîä</button>`;div.querySelector(".playBtn").onclick=(e)=>{e.stopPropagation();playVoicePreview(c.voice,c.name);};div.onclick=()=>openEditor(i);charList.appendChild(div);});autoSave();}
function openEditor(i){const c=characters[i];editor.dataset.index=i;document.getElementById("ceName").value=c.name;document.getElementById("ceNotes").value=c.notes;document.getElementById("ceVoice").value=c.voice;document.getElementById("ceEleven").value=c.eleven;editor.showModal();}
document.getElementById("ceCancel").onclick=()=>editor.close();
document.getElementById("ceSave").onclick=()=>{const i=editor.dataset.index|0;characters[i].name=document.getElementById("ceName").value;characters[i].notes=document.getElementById("ceNotes").value;characters[i].voice=document.getElementById("ceVoice").value;characters[i].eleven=document.getElementById("ceEleven").value;editor.close();renderCharacters();};
document.getElementById("btnAddChar").onclick=()=>{characters.push({name:"New Character",notes:"",voice:"ember",eleven:""});renderCharacters();};

/* ===== UPLOADS ===== */
const uploadList=document.getElementById("uploadList");
["fileMusic","fileGeneral"].forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener("change",()=>{const names=[...el.files].map(f=>f.name);const prev=uploadList.innerHTML;uploadList.innerHTML=(prev?prev+"<br>":"")+names.join("<br>");autoSave();});});

/* ===== AUTOSAVE ===== */
let autosaveTimer=null;
function autoSave(){if(!storageWritable())return;const data={characters,uploads:(uploadList?uploadList.innerHTML:"")};localStorage.setItem(LS_DATA,JSON.stringify(data));autosaveStatus.textContent="Autosaved ‚úì "+new Date().toLocaleTimeString();}
function autoLoad(){if(!storageWritable())return;const saved=localStorage.getItem(LS_DATA);if(saved){try{const d=JSON.parse(saved);if(d.characters)characters=d.characters;if(d.uploads&&uploadList)uploadList.innerHTML=d.uploads;autosaveStatus.textContent="Loaded saved data.";}catch(e){characters=defaultCharacters();}}else{characters=defaultCharacters();}}
function setAutosaveInterval(mins){if(autosaveTimer)clearInterval(autosaveTimer);autosaveTimer=setInterval(autoSave,Math.max(1,mins)*60000);}

/* ===== SECRETS PANEL ===== */
const fields={proxy:"secProxy",openai:"secOpenAI",eleven:"secEleven",freesound:"secFreesound",hf:"secHF",stability:"secStability",custom1:"secCustom1",custom2:"secCustom2",custom3:"secCustom3"};
function loadSecretsIntoForm(){const v=getSecrets();Object.entries(fields).forEach(([k,id])=>{const el=document.getElementById(id);if(!el)return;el.value=v[k]|| (k==="proxy"?"https://ai-proxydjs.blindart2020.workers.dev":"");});if(!storageWritable())document.getElementById("storageWarning").style.display="block";}
function saveSecrets(){if(!storageWritable()){alert("Storage blocked. Enable site storage or disable 'clear on exit'.");return;}const v={};Object.entries(fields).forEach(([k,id])=>{const el=document.getElementById(id);if(el)v[k]=(el.value||"").trim();});localStorage.setItem(LS_SECRETS,JSON.stringify(v));autosaveStatus.textContent="Secrets saved ‚úì";}
function clearSecrets(){if(!storageWritable())return;localStorage.removeItem(LS_SECRETS);loadSecretsIntoForm();autosaveStatus.textContent="Secrets cleared";}
document.getElementById("btnSaveSecrets").onclick=saveSecrets;
document.getElementById("btnClearSecrets").onclick=clearSecrets;
document.getElementById("btnExportSecrets").onclick=()=>{const blob=new Blob([JSON.stringify(getSecrets(),null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="book-animator-secrets.json";a.click();};
document.getElementById("btnImportSecrets").onclick=()=>document.getElementById("fileImportSecrets").click();
document.getElementById("fileImportSecrets").addEventListener("change",async(e)=>{const f=e.target.files?.[0];if(!f)return;const text=await f.text();try{JSON.parse(text);localStorage.setItem(LS_SECRETS,text);loadSecretsIntoForm();autosaveStatus.textContent="Secrets imported ‚úì";}catch{alert("Invalid JSON");}});

/* ===== SETTINGS ===== */
const setAutosave=document.getElementById("setAutosave");const setAutoPreview=document.getElementById("setAutoPreview");
function defaultSettings(){return {autosaveMinutes:10,autoPreviewOnOpen:false};}
function getSettings(){try{return Object.assign(defaultSettings(),JSON.parse(localStorage.getItem(LS_SETTINGS)||"{}"));}catch(e){return defaultSettings();}}
function saveSettingsObj(s){if(storageWritable())localStorage.setItem(LS_SETTINGS,JSON.stringify(s));}
function loadSettingsIntoForm(){const s=getSettings();setAutosave.value=String(s.autosaveMinutes);setAutoPreview.value=s.autoPreviewOnOpen?"on":"off";setAutosaveInterval(s.autosaveMinutes);}
document.getElementById("btnSaveSettings").onclick=()=>{const s={autosaveMinutes:parseInt(setAutosave.value,10)||10,autoPreviewOnOpen:(setAutoPreview.value==="on")};saveSettingsObj(s);setAutosaveInterval(s.autosaveMinutes);autosaveStatus.textContent="Settings saved ‚úì";};
document.getElementById("btnResetDefault").onclick=()=>{const s=defaultSettings();saveSettingsObj(s);loadSettingsIntoForm();autosaveStatus.textContent="Settings reset ‚úì";};

/* ===== VOICE PREVIEW (OpenAI TTS) ===== */
async function playVoicePreview(voice,name){const v=getSecrets();const base=(v.proxy||"https://ai-proxydjs.blindart2020.workers.dev").replace(/\/$/,"");const headers={"Content-Type":"application/json"};if(v.openai)headers["Authorization"]="Bearer "+v.openai;try{const res=await fetch(base+"/v1/audio/speech",{method:"POST",headers,body:JSON.stringify({model:"gpt-4o-mini-tts",voice,input:`Hello, I am ${name}. This is my voice.`})});if(!res.ok)throw new Error("TTS HTTP "+res.status);const blob=await res.blob();new Audio(URL.createObjectURL(blob)).play();autosaveStatus.textContent=`Playing ${name}'s voice`;}catch(e){console.error(e);autosaveStatus.textContent="Voice preview failed";}}

/* ===== SCENES: IMAGE + AUTO SFX + NARRATION ===== */
const sceneGrid=document.getElementById("sceneGrid");
function getScenesFromEditor(){// if you have a textarea editor, grab it; else create simple scenes
  const ta=document.querySelector("textarea"); if(!ta) return ["A calm forest with birds chirping.","A storm with thunder and heavy rain.","Footsteps in a quiet hallway."];
  return ta.value.split(/\n\s*\n/).map(s=>s.trim()).filter(Boolean);
}
function ensureSceneTiles(n){while(sceneGrid.children.length<n){const i=sceneGrid.children.length+1;const card=document.createElement("div");card.className="sceneCard";card.innerHTML=`<div class="muted" style="font-size:.8rem;margin-bottom:.3rem;">#${i}</div><img id="sceneThumb-${i}" alt="thumb ${i}"/><audio id="sceneNarr-${i}" controls style="width:100%;margin-top:.3rem"></audio><audio id="sceneSfx-${i}" controls style="width:100%;margin-top:.3rem"></audio>`;sceneGrid.appendChild(card);}}
async function generateImageForScene(promptText){const v=getSecrets();const base=(v.proxy||"https://ai-proxydjs.blindart2020.workers.dev").replace(/\/$/,"");const headers={"Content-Type":"application/json"};if(v.openai)headers["Authorization"]="Bearer "+v.openai;const res=await fetch(base+"/v1/images/generations",{method:"POST",headers,body:JSON.stringify({model:"gpt-image-1",prompt:promptText,size:"1024x1024"})});if(!res.ok)throw new Error("Image gen "+res.status);const json=await res.json();const b64=json?.data?.[0]?.b64_json;return b64?("data:image/png;base64,"+b64):"";}
function sfxKeywordFrom(text){const tag=(text.match(/\[sfx:\s*([^\]]+)\]/i)||[])[1];if(tag)return tag;const dict=[["thunder","thunder"],["rain","rain"],["ocean","ocean waves"],["sea","ocean waves"],["wind","wind"],["forest","forest birds"],["birds","birds"],["footsteps","footsteps"],["door","door close"],["crowd","crowd"],["city","city ambience"],["car","car engine"],["engine","engine"],["applause","applause"],["laugh","laughter"],["scream","scream"]];text=text.toLowerCase();for(const [k,q] of dict){if(text.includes(k))return q;}return "ambient background";}
async function findFreeSoundPreview(query){const v=getSecrets();if(!v.freesound)throw new Error("Missing FreeSound API key");const url=new URL("https://freesound.org/apiv2/search/text/");url.searchParams.set("query",query);url.searchParams.set("fields","id,name,previews,license,duration");url.searchParams.set("filter","duration:[0 TO 20]");url.searchParams.set("page_size","1");const res=await fetch(url.toString(),{headers:{}});if(!res.ok)throw new Error("FreeSound "+res.status);const js=await res.json();const item=js.results?.[0];const p=item?.previews?.["preview-hq-mp3"]||item?.previews?.["preview-lq-mp3"]||item?.previews?.["preview-hq-ogg"]||item?.previews?.["preview-lq-ogg"];return p||"";}
async function generateNarration(text,voice){const v=getSecrets();const base=(v.proxy||"https://ai-proxydjs.blindart2020.workers.dev").replace(/\/$/,"");const headers={"Content-Type":"application/json"};if(v.openai)headers["Authorization"]="Bearer "+v.openai;const res=await fetch(base+"/v1/audio/speech",{method:"POST",headers,body:JSON.stringify({model:"gpt-4o-mini-tts",voice,input:text})});if(!res.ok)throw new Error("TTS "+res.status);const blob=await res.blob();return URL.createObjectURL(blob);}

document.getElementById("btnPreviewScenes").onclick=()=>{const scenes=getScenesFromEditor();ensureSceneTiles(scenes.length);};
document.getElementById("btnStartAnimation").onclick=async()=>{
  const scenes=getScenesFromEditor(); if(!scenes.length){alert("No scenes found.");return;}
  ensureSceneTiles(scenes.length);
  for(let i=0;i<scenes.length;i++){
    const text=scenes[i]; const voice="ember";
    try{
      // Image
      const imgURL=await generateImageForScene(text);
      const imgEl=document.getElementById(`sceneThumb-${i+1}`); if(imgEl && imgURL) imgEl.src=imgURL;
      // Narration
      const narrURL=await generateNarration(text,voice);
      const narrEl=document.getElementById(`sceneNarr-${i+1}`); if(narrEl) narrEl.src=narrURL;
      // Auto SFX via FreeSound
      let sfxURL="";
      try{
        const q=sfxKeywordFrom(text);
        sfxURL=await findFreeSoundPreview(q);
      }catch(e){ console.warn("SFX search fallback:", e); }
      const sfxEl=document.getElementById(`sceneSfx-${i+1}`);
      if(sfxEl && sfxURL) sfxEl.src=sfxURL;
      if(sfxEl && !sfxURL) sfxEl.outerHTML = '<div class="status">No SFX found</div>';
    }catch(err){ console.error(err); }
  }
};

/* ===== STARTUP ===== */
function loadSecretsIntoForm(){const v=getSecrets();const map={proxy:"secProxy",openai:"secOpenAI",eleven:"secEleven",freesound:"secFreesound",hf:"secHF",stability:"secStability",custom1:"secCustom1",custom2:"secCustom2",custom3:"secCustom3"};Object.entries(map).forEach(([k,id])=>{const el=document.getElementById(id);if(el)el.value=v[k]|| (k==="proxy"?"https://ai-proxydjs.blindart2020.workers.dev":"");});if(!storageWritable())document.getElementById("storageWarning").style.display="block";}
function saveSecrets(){if(!storageWritable()){alert("Storage blocked. Enable site storage or disable 'clear on exit'.");return;}const map={proxy:"secProxy",openai:"secOpenAI",eleven:"secEleven",freesound:"secFreesound",hf:"secHF",stability:"secStability",custom1:"secCustom1",custom2:"secCustom2",custom3:"secCustom3"};const v={};Object.entries(map).forEach(([k,id])=>{const el=document.getElementById(id);if(el)v[k]=(el.value||"").trim();});localStorage.setItem(LS_SECRETS,JSON.stringify(v));autosaveStatus.textContent="Secrets saved ‚úì";}
function clearSecrets(){if(!storageWritable())return;localStorage.removeItem(LS_SECRETS);loadSecretsIntoForm();autosaveStatus.textContent="Secrets cleared";}
document.getElementById("btnSaveSecrets").onclick=saveSecrets;
document.getElementById("btnClearSecrets").onclick=clearSecrets;
document.getElementById("btnExportSecrets").onclick=()=>{const blob=new Blob([JSON.stringify(getSecrets(),null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="book-animator-secrets.json";a.click();};
document.getElementById("btnImportSecrets").onclick=()=>document.getElementById("fileImportSecrets").click();
document.getElementById("fileImportSecrets").addEventListener("change",async(e)=>{const f=e.target.files?.[0];if(!f)return;const text=await f.text();try{JSON.parse(text);localStorage.setItem(LS_SECRETS,text);loadSecretsIntoForm();autosaveStatus.textContent="Secrets imported ‚úì";}catch{alert("Invalid JSON");}});

autoLoad(); renderCharacters(); loadSecretsIntoForm(); loadSettingsIntoForm();
</script>
</body>
</html>
