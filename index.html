<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Book Animator</title>
<meta name="theme-color" content="#0b0b0b"/>
<style>
  :root{ --bg:#0b0b0b; --panel:#111; --ink:#fff; --muted:#cfcfcf; --line:#2a2a2a; --accent:#ef4444; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{font-size:2.2rem;text-align:center;margin:12px 0 18px}
  textarea{width:100%;min-height:280px;background:#0f0f0f;border:1px solid var(--line);border-radius:12px;color:#eee;font-size:1.05rem;line-height:1.5;padding:14px;outline:none}
  .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{background:#181818;border:1px solid var(--accent);color:#fff;padding:.75rem 1rem;border-radius:12px;cursor:pointer}
  .btn:hover{box-shadow:0 0 0 2px #ef44441a}
  .btn.small{padding:.42rem .6rem;border-radius:10px}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .hamb{width:62px;height:62px;border:2px solid #fff;border-radius:16px;display:grid;place-items:center;background:#000;cursor:pointer;box-shadow:0 2px 10px #0006}
  .hamb .line{width:30px;height:4px;background:#fff;margin:5px 0;border-radius:3px;box-shadow:0 0 6px #fff9}
  .badge{display:inline-block;background:#131313;color:#ddd;border:1px solid var(--line);padding:.25rem .6rem;border-radius:999px;margin:.15rem}
  .thumbs{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:16px 0 80px}
  .thumb-slot{height:120px;border:1px dashed #555;border-radius:12px;background:#0f0f0f;display:grid;place-items:center;color:#888;position:relative}
  .thumb-slot img{width:100%;height:100%;object-fit:cover;border-radius:12px}
  .thumb-slot .idx{position:absolute;top:6px;left:8px;font-size:.8rem;color:#fca5a5}
  .progress{position:fixed;left:0;right:0;bottom:0;background:#0d0d0d;border-top:1px solid #1a1a1a;padding:.6rem 1rem;display:flex;gap:1rem;align-items:center;z-index:1200}
  .meter{flex:1;height:12px;background:#1a1a1a;border-radius:999px;position:relative;overflow:hidden}
  .meter::after{content:"";position:absolute;inset:0;transform:scaleX(var(--pct,0));transform-origin:left;background:#fff;border-radius:999px;transition:transform .2s ease}
  .pct{min-width:48px;text-align:right;color:#bbb}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:flex-start;justify-content:center;padding-top:6vh;z-index:1100}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;max-width:960px;width:94vw;max-height:82vh;overflow:auto;box-shadow:0 12px 40px #000a}
  .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .tabs .btn{border-color:#444}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;justify-content:space-between;align-items:center;background:#101010;border:1px solid var(--line);padding:.75rem 1rem;border-radius:12px}
  .row{display:flex;gap:.6rem;align-items:center}
  .row>span{width:12rem;color:#e6e6e6}
  select,input[type="text"],input[type="password"],input[type="number"],input[type="file"]{flex:1;background:#0f0f0f;border:1px solid #333;color:#eee;padding:.55rem .6rem;border-radius:10px}
  small.muted{color:#bdbdbd}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <button class="hamb" id="btnLeft" aria-label="Open left menu"><div class="line"></div><div class="line"></div><div class="line"></div></button>
    <h1>Book Animator</h1>
    <button class="hamb" id="btnRight" aria-label="Open right menu"><div class="line"></div><div class="line"></div><div class="line"></div></button>
  </div>

  <div style="display:flex;gap:.6rem;justify-content:center;margin:.4rem 0 1rem">
    <span class="badge">Mode: <b id="modeBadge">Simple</b></span>
    <span class="badge">Scenes: <b id="scenesBadge">0</b></span>
  </div>

  <textarea id="bookText" placeholder="Paste your book text here…"></textarea>

  <div class="bar">
    <button class="btn" id="btnPreview">Preview Scenes</button>
    <button class="btn" id="btnStart" style="border-color:var(--accent);background:var(--accent)">Start Animation</button>
  </div>

  <div class="thumbs" id="thumbStrip" aria-live="polite"></div>
</div>

<div class="progress">
  <button class="btn small" id="btnSave">Save</button>
  <button class="btn small" id="btnZip">Export (ZIP)</button>
  <div class="meter" id="progressBar"></div>
  <div class="pct" id="progressPct">0%</div>
</div>

<!-- LEFT MENU -->
<div class="overlay" id="leftMenu">
  <div class="card" role="dialog" aria-label="Left menu">
    <div class="tabs">
      <button class="btn small" data-tab="tabChar">Characters</button>
      <button class="btn small" data-tab="tabSettings">Settings</button>
      <button class="btn small" data-tab="tabSecrets">Secrets (API Keys)</button>
      <button class="btn small" data-tab="tabHelp">Help</button>
      <button class="btn small" id="btnCloseLeft" style="margin-left:auto">Close</button>
    </div>

    <section id="tabChar">
      <h2>Characters</h2>
      <div id="charList" class="list"></div>
      <small class="muted">Tap <b>Edit</b> to set traits, voice and portrait.</small>
    </section>

    <section id="tabSettings" style="display:none">
      <h2>Settings</h2>
      <div class="list">
        <label class="row"><span>Render Mode</span>
          <select id="setRenderMode">
            <option value="offline">Offline (no AI)</option>
            <option value="online" selected>Online AI (use keys)</option>
          </select>
        </label>
        <label class="row"><span>Image Provider</span>
          <select id="setImageProvider">
            <option value="openai" selected>OpenAI (gpt-image-1)</option>
            <option value="stability">Stability (SDXL)</option>
          </select>
        </label>
        <label class="row"><span>Motion Mode</span>
          <select id="setMotion">
            <option value="kenburns">Ken Burns (single image)</option>
            <option value="multishot" selected>Multi-shot (N images)</option>
          </select>
        </label>
        <label class="row"><span>Frames per Scene</span>
          <input id="setFrames" type="number" min="2" max="8" value="4"/>
        </label>
        <label class="row"><span>Visual Style</span>
          <select id="setStylePreset">
            <option>Comic</option><option>Cartoon</option><option selected>Anime</option><option>Dark Fantasy</option>
            <option>Watercolor</option><option>Ink & Wash</option><option>Flat Toon</option><option>Retro Pixel</option>
          </select>
        </label>
        <label class="row"><span>FPS</span>
          <select id="setFps"><option>12</option><option selected>24</option><option>30</option></select>
        </label>
        <label class="row"><span>Auto SFX</span>
          <select id="setAutoSfx">
            <option value="off">Off</option>
            <option value="on" selected>On</option>
          </select>
        </label>
        <label class="row"><span>SFX Volume</span>
          <input id="setSfxVol" type="number" min="0" max="100" value="60"/>
        </label>
        <label class="row"><span>Online SFX Provider</span>
          <select id="setSfxProvider">
            <option value="off">Off</option>
            <option value="freesound">Freesound.org</option>
          </select>
        </label>
        <label class="row"><span>Online SFX Mode</span>
          <select id="setSfxMode">
            <option value="fallback" selected>Use only if local not found</option>
            <option value="always">Always prefer online</option>
          </select>
        </label>
      </div>
      <small class="muted">Theme: black background, white text, red buttons.</small>
    </section>

    <section id="tabSecrets" style="display:none">
      <h2>Secrets (API Keys)</h2>
      <div class="list">
        <label class="row"><span>OpenAI API Key</span><input id="keyOpenAI" type="password" placeholder="sk-..."/></label>
        <label class="row"><span>Stability API Key</span><input id="keyStability" type="password" placeholder="sk-..."/></label>
        <label class="row"><span>ElevenLabs API Key</span><input id="key11Labs" type="password" placeholder="eleven-..."/></label>
        <label class="row"><span>Freesound API Key</span><input id="keyFreesound" type="password" placeholder="fs-xxxxxxxxxxxxxxxx"/></label>
        <div class="row" style="justify-content:flex-end;gap:.5rem">
          <button class="btn" id="btnTestOpenAI">Test OpenAI</button>
          <button class="btn" id="btnSaveSettings" style="background:var(--accent);border-color:var(--accent)">Save</button>
        </div>
        <small class="muted">Stored only in your browser (localStorage). Not uploaded.</small>
      </div>
    </section>

    <section id="tabHelp" style="display:none">
      <h2>Help</h2>
      <p>1) Secrets → paste your OpenAI key (and Freesound if using online SFX). 2) Settings → Render Mode: “Online AI”. 3) Paste text → Start Animation. Multi-shot creates multiple images per scene for motion. SFX will auto-attach using local library and/or Freesound.</p>
    </section>
  </div>
</div>

<!-- RIGHT MENU -->
<div class="overlay" id="rightMenu">
  <div class="card" role="dialog" aria-label="Right menu">
    <div class="tabs">
      <button class="btn small" data-rtab="tabUploads">Uploads</button>
      <button class="btn small" data-rtab="tabProject">Project</button>
      <button class="btn small" id="btnCloseRight" style="margin-left:auto">Close</button>
    </div>

    <section id="tabUploads">
      <h2>Uploads</h2>
      <div class="list">
        <label class="row"><span>Music Bed</span><input id="fileMusic" type="file" accept="audio/*"/></label>
        <label class="row"><span>SFX (scene #)</span><input id="sfxIndex" type="text" placeholder="0"/></label>
        <label class="row"><span>Upload SFX</span><input id="fileSfx" type="file" accept="audio/*"/></label>
        <label class="row"><span>Add SFX Library</span><input id="fileSfxLib" type="file" accept="audio/*" multiple/></label>
        <label class="row"><span>Import Characters JSON</span><input id="fileChars" type="file" accept="application/json"/></label>
      </div>
      <small class="muted">Name SFX with tags: <i>rain_loop.mp3</i>, <i>door_close.wav</i>, <i>sword_clash.ogg</i>…</small>
    </section>

    <section id="tabProject" style="display:none">
      <h2>Project</h2>
      <div class="list">
        <button class="btn small" id="btnClearThumbs">Clear Thumbnails</button>
        <button class="btn small" id="btnWipe">Wipe Local Data</button>
      </div>
    </section>
  </div>
</div>

<!-- Character Edit Modal -->
<div class="overlay" id="charEdit">
  <div class="card" style="max-width:820px">
    <h2>Edit Character</h2>
    <div class="list">
      <label class="row"><span>Name</span><input id="ceName" type="text"/></label>
      <label class="row"><span>Traits / Notes</span><input id="ceNotes" type="text" placeholder="personality, role…"/></label>
      <label class="row"><span>Voice (OpenAI)</span>
        <select id="ceVoice">
          <option value="ember">Ember</option><option value="alloy">Alloy</option>
          <option value="verse">Verse</option><option value="aria">Aria</option>
          <option value="sage">Sage</option><option value="amber">Amber</option>
        </select>
      </label>
      <label class="row"><span>Voice (11Labs ID)</span><input id="ce11" type="text" placeholder="optional"/></label>
      <label class="row"><span>Portrait</span><input id="cePortrait" type="file" accept="image/*"/></label>
    </div>
    <div class="bar" style="justify-content:flex-end">
      <button class="btn" id="ceCancel">Cancel</button>
      <button class="btn" id="ceSave" style="background:var(--accent);border-color:var(--accent)">Save</button>
    </div>
  </div>
</div>

<script>
/* ========= ELEMENTS ========= */
const UI = {
  leftBtn: document.getElementById('btnLeft'),
  rightBtn: document.getElementById('btnRight'),
  leftMenu: document.getElementById('leftMenu'),
  rightMenu: document.getElementById('rightMenu'),
  closeLeft: document.getElementById('btnCloseLeft'),
  closeRight: document.getElementById('btnCloseRight'),

  tabButtons: document.querySelectorAll('[data-tab]'),
  rtabButtons: document.querySelectorAll('[data-rtab]'),

  txt: document.getElementById('bookText'),
  start: document.getElementById('btnStart'),
  preview: document.getElementById('btnPreview'),
  thumbs: document.getElementById('thumbStrip'),
  pct: document.getElementById('progressPct'),
  bar: document.getElementById('progressBar'),
  scenesBadge: document.getElementById('scenesBadge'),
  btnSave: document.getElementById('btnSave'),
  btnZip: document.getElementById('btnZip'),

  // settings/keys
  setRenderMode: document.getElementById('setRenderMode'),
  setImageProvider: document.getElementById('setImageProvider'),
  setMotion: document.getElementById('setMotion'),
  setFrames: document.getElementById('setFrames'),
  setStylePreset: document.getElementById('setStylePreset'),
  setFps: document.getElementById('setFps'),
  setAutoSfx: document.getElementById('setAutoSfx'),
  setSfxVol: document.getElementById('setSfxVol'),
  setSfxProvider: document.getElementById('setSfxProvider'),
  setSfxMode: document.getElementById('setSfxMode'),
  keyOpenAI: document.getElementById('keyOpenAI'),
  keyStab: document.getElementById('keyStability'),
  key11: document.getElementById('key11Labs'),
  keyFreesound: document.getElementById('keyFreesound'),
  btnSaveSettings: document.getElementById('btnSaveSettings'),
  btnTestOpenAI: document.getElementById('btnTestOpenAI'),

  // uploads
  fileMusic: document.getElementById('fileMusic'),
  fileSfx: document.getElementById('fileSfx'),
  sfxIndex: document.getElementById('sfxIndex'),
  fileChars: document.getElementById('fileChars'),
  fileSfxLib: document.getElementById('fileSfxLib'),

  // left/right tabs
  tabChar: document.getElementById('tabChar'),
  tabSettings: document.getElementById('tabSettings'),
  tabSecrets: document.getElementById('tabSecrets'),
  tabHelp: document.getElementById('tabHelp'),
  tabUploads: document.getElementById('tabUploads'),
  tabProject: document.getElementById('tabProject'),

  // character edit
  charList: document.getElementById('charList'),
  charEdit: document.getElementById('charEdit'),
  ceName: document.getElementById('ceName'),
  ceNotes: document.getElementById('ceNotes'),
  ceVoice: document.getElementById('ceVoice'),
  ce11: document.getElementById('ce11'),
  cePortrait: document.getElementById('cePortrait'),
  ceSave: document.getElementById('ceSave'),
  ceCancel: document.getElementById('ceCancel'),
};

/* ========= STATE ========= */
let SETTINGS = JSON.parse(localStorage.getItem('ba_settings') || '{}');
let SECRETS  = JSON.parse(localStorage.getItem('ba_secrets')  || '{}');
let CHARACTERS = JSON.parse(localStorage.getItem('ba_characters') || '[]');
let SFX_LIB = JSON.parse(localStorage.getItem('ba_sfxlib')||'[]');
let editingIndex = -1;

const DEFAULT_NAMES = [
 'Narrator','Sidetracked Sally','Darling Danielle','Dark Dan','Skater Skip',
 'Creative Callie','Zen Zena','Grumpy Gus','Journey Mark','Abby','Bear'
];
if (CHARACTERS.length===0){
  CHARACTERS = DEFAULT_NAMES.map(n => ({name:n, notes:'', voice:'ember', elevenId:'', portrait:''}));
  persist('ba_characters', CHARACTERS);
}

/* ========= MENUS ========= */
UI.leftBtn.addEventListener('click', ()=> UI.leftMenu.style.display='flex');
UI.rightBtn.addEventListener('click', ()=> UI.rightMenu.style.display='flex');
UI.closeLeft.addEventListener('click', ()=> UI.leftMenu.style.display='none');
UI.closeRight.addEventListener('click', ()=> UI.rightMenu.style.display='none');
UI.leftMenu.addEventListener('click', (e)=>{ if(e.target===UI.leftMenu) UI.leftMenu.style.display='none'; });
UI.rightMenu.addEventListener('click', (e)=>{ if(e.target===UI.rightMenu) UI.rightMenu.style.display='none'); });

UI.tabButtons.forEach(btn=>btn.addEventListener('click', ()=>{
  const id = btn.dataset.tab;
  ['tabChar','tabSettings','tabSecrets','tabHelp'].forEach(k=>{
    document.getElementById(k).style.display = (k===id?'block':'none');
  });
}));
UI.rtabButtons.forEach(btn=>btn.addEventListener('click', ()=>{
  const id = btn.dataset.rtab;
  ['tabUploads','tabProject'].forEach(k=>{
    document.getElementById(k).style.display = (k===id?'block':'none');
  });
}));

/* ========= SETTINGS / KEYS ========= */
function hydrateSettings(){
  UI.setRenderMode.value   = SETTINGS.renderMode || 'online';
  UI.setImageProvider.value= SETTINGS.imageProvider || 'openai';
  UI.setMotion.value       = SETTINGS.motion || 'multishot';
  UI.setFrames.value       = SETTINGS.framesPerScene || 4;
  UI.setStylePreset.value  = SETTINGS.stylePreset || 'Anime';
  UI.setFps.value          = SETTINGS.fps || '24';
  UI.setAutoSfx.value      = SETTINGS.autoSfx || 'on';
  UI.setSfxVol.value       = (SETTINGS.sfxVol ?? 60);
  UI.setSfxProvider.value  = SETTINGS.sfxProvider || 'off';
  UI.setSfxMode.value      = SETTINGS.sfxMode || 'fallback';
  UI.keyOpenAI.value       = (SECRETS.openai && SECRETS.openai.apiKey) || '';
  UI.keyStab.value         = (SECRETS.stability && SECRETS.stability.key) || '';
  UI.key11.value           = (SECRETS.eleven && SECRETS.eleven.key) || '';
  UI.keyFreesound.value    = (SECRETS.freesound && SECRETS.freesound.key) || '';
}
hydrateSettings();

UI.btnSaveSettings.addEventListener('click', ()=>{
  SETTINGS.renderMode    = UI.setRenderMode.value;
  SETTINGS.imageProvider = UI.setImageProvider.value;
  SETTINGS.motion        = UI.setMotion.value;
  SETTINGS.framesPerScene= Math.max(2, Math.min(8, parseInt(UI.setFrames.value||'4',10)));
  SETTINGS.stylePreset   = UI.setStylePreset.value;
  SETTINGS.fps           = UI.setFps.value;
  SETTINGS.autoSfx       = UI.setAutoSfx.value;
  SETTINGS.sfxVol        = Math.max(0, Math.min(100, parseInt(UI.setSfxVol.value||'60',10)));
  SETTINGS.sfxProvider   = UI.setSfxProvider.value;
  SETTINGS.sfxMode       = UI.setSfxMode.value;
  persist('ba_settings', SETTINGS);

  SECRETS.openai   = { apiKey: UI.keyOpenAI.value || '' };
  SECRETS.stability= { key: UI.keyStab.value || '' };
  SECRETS.eleven   = { key: UI.key11.value || '' };
  SECRETS.freesound= { key: UI.keyFreesound.value || '' };
  persist('ba_secrets', SECRETS);
  alert('Settings saved');
});
UI.btnTestOpenAI.addEventListener('click', ()=>{
  if ((UI.keyOpenAI.value || (SECRETS.openai||{}).apiKey)) alert('OpenAI key present.');
  else alert('Enter an OpenAI key first.');
});

/* ========= UPLOADS ========= */
UI.fileMusic?.addEventListener('change', async (e)=>{
  const url = await fileToDataURL(e.target.files[0]); persist('ba_music', url); alert('Music saved.');
});
UI.fileSfx?.addEventListener('change', async (e)=>{
  const idx = parseInt(UI.sfxIndex.value||'0',10)||0;
  const url = await fileToDataURL(e.target.files[0]); persist('sfx_'+idx, url); alert('SFX saved for scene '+idx);
});
UI.fileChars?.addEventListener('change', async (e)=>{
  const txt = await e.target.files[0].text();
  try{
    const data = JSON.parse(txt);
    if (Array.isArray(data)){ CHARACTERS = data; persist('ba_characters', CHARACTERS); renderCharList(); alert('Characters imported.'); }
    else alert('JSON must be an array of characters');
  }catch{ alert('Invalid JSON'); }
});
UI.fileSfxLib?.addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files || []);
  const added = [];
  for (const f of files) {
    const url = URL.createObjectURL(f);
    const base = (f.name||'').toLowerCase();
    const tags = base.replace(/\.[a-z0-9]+$/,'').split(/[_\-\s]+/g).filter(Boolean);
    SFX_LIB.push({ name: f.name, url, tags });
    added.push(f.name);
  }
  localStorage.setItem('ba_sfxlib', JSON.stringify(SFX_LIB));
  alert(`Added ${added.length} SFX file(s).`);
});

document.getElementById('btnWipe')?.addEventListener('click', ()=>{ if(confirm('Wipe all local data?')){ localStorage.clear(); location.reload(); }});
document.getElementById('btnClearThumbs')?.addEventListener('click', ()=>{ UI.thumbs.innerHTML=''; });

/* ========= CHARACTERS UI ========= */
function renderCharList(){
  UI.charList.innerHTML='';
  CHARACTERS.forEach((c,i)=>{
    const el = document.createElement('div');
    el.className='item';
    el.innerHTML = `
      <div><b>${escapeHtml(c.name)}</b><br/><small class="muted">${escapeHtml(c.voice||'ember')}</small></div>
      <div class="row">
        ${c.portrait?`<img src="${c.portrait}" style="width:44px;height:44px;border-radius:10px;object-fit:cover;border:1px solid #333;margin-right:.5rem">`:''}
        <button class="btn small" data-edit="${i}">Edit</button>
      </div>`;
    UI.charList.appendChild(el);
  });
  UI.charList.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click', ()=> openCharEdit(parseInt(b.dataset.edit,10))));
}
renderCharList();

function openCharEdit(i){
  editingIndex = i;
  const c = CHARACTERS[i];
  UI.ceName.value = c.name||'';
  UI.ceNotes.value = c.notes||'';
  UI.ceVoice.value = c.voice||'ember';
  UI.ce11.value = c.elevenId||'';
  UI.cePortrait.value = '';
  UI.charEdit.style.display='flex';
}
UI.ceCancel.addEventListener('click', ()=> UI.charEdit.style.display='none');
UI.ceSave.addEventListener('click', async ()=>{
  const c = CHARACTERS[editingIndex]; if(!c) return;
  c.name = UI.ceName.value.trim()||c.name;
  c.notes = UI.ceNotes.value.trim();
  c.voice = UI.ceVoice.value;
  c.elevenId = UI.ce11.value.trim();
  if (UI.cePortrait.files[0]) c.portrait = await fileToDataURL(UI.cePortrait.files[0]);
  persist('ba_characters', CHARACTERS); renderCharList();
  UI.charEdit.style.display='none';
});

/* ========= SAVE / LOAD ========= */
UI.btnSave.addEventListener('click', ()=>{ persist('ba_text', UI.txt.value||''); alert('Saved'); });
UI.txt.value = localStorage.getItem('ba_text') || '';

/* ========= SCENE SPLITTER ========= */
function splitScenes(t){
  const hard = /
\s*
|^#\s*scene:|^###/gmi;
  const chunks = t.split(hard).map(s=>s.trim()).filter(Boolean);
  const res=[]; const rx = /[^.!?]+[.!?]+/g;
  for (const ch of chunks){
    const sents = ch.match(rx) || [ch];
    let acc = '';
    for (const s of sents){
      const trial = (acc + ' ' + s).trim();
      if (trial.length > 260){ if (acc) res.push(acc); acc = s.trim(); } else acc = trial;
    }
    if (acc) res.push(acc);
  }
  return res;
}

/* ========= PREVIEW / START ========= */
UI.preview.addEventListener('click', ()=>{
  const scenes = splitScenes(UI.txt.value||''); UI.scenesBadge.textContent = scenes.length;
  UI.thumbs.innerHTML=''; scenes.slice(0,32).forEach((s,i)=>{ const d=document.createElement('div'); d.className='thumb-slot'; d.textContent='…'; d.id='slot_'+i; UI.thumbs.appendChild(d); });
});
UI.start.addEventListener('click', async ()=>{
  const scenes = splitScenes(UI.txt.value||''); UI.scenesBadge.textContent = scenes.length;
  UI.thumbs.innerHTML='';
  scenes.forEach((_,i)=>{ const ph=document.createElement('div'); ph.className='thumb-slot'; ph.id='slot_'+i; ph.innerHTML='<div class="idx">#'+(i+1)+'</div>…'; UI.thumbs.appendChild(ph); });
  await renderScenes(scenes);
});

/* ========= IMAGE GEN (OpenAI default) ========= */
async function aiImageOpenAI(prompt) {
  const key = (SECRETS.openai || {}).apiKey;
  if (!key) throw new Error('No OpenAI key');
  const res = await fetch('https://api.openai.com/v1/images/generations', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+key },
    body: JSON.stringify({ model:'gpt-image-1', prompt, size:'512x512', n:1 })
  });
  const j = await res.json();
  if (!res.ok) throw new Error(j?.error?.message || 'OpenAI image error');
  const b64 = j?.data?.[0]?.b64_json;
  return b64 ? `data:image/png;base64,${b64}` : null;
}

function offlinePoster(scene, idx, preset){
  const W=512,H=512, pad=22;
  const c=document.createElement('canvas'); c.width=W; c.height=H;
  const x=c.getContext('2d'); x.fillStyle='#111'; x.fillRect(0,0,W,H);
  x.strokeStyle='#ef4444'; x.lineWidth=5; x.strokeRect(8,8,W-16,H-16);
  x.fillStyle='#eee'; x.font='700 18px system-ui'; x.fillText(preset+' '+(idx+1), 16, 34);
  x.font='500 16px system-ui'; x.fillStyle='#ddd';
  wrapTextCanvas(x, scene.replace(/\s+/g,' ').slice(0,240), pad, 60, W-2*pad, 22);
  return c.toDataURL('image/png');
}

/* ========= RENDERER (Ken Burns or Multi-shot) ========= */
async function renderScenes(scenes){
  const fps = parseInt(SETTINGS.fps||'24',10);
  const framesPerScene = Math.max(2, Math.min(8, parseInt(SETTINGS.framesPerScene||4,10)));
  const motion = SETTINGS.motion || 'multishot';
  const provider = SETTINGS.imageProvider || 'openai';
  const online = (SETTINGS.renderMode||'online') === 'online';
  const style = SETTINGS.stylePreset || 'Anime';

  let done=0;
  for (let i=0;i<scenes.length;i++){
    const scene = scenes[i];
    let stills = [];

    if (online && provider==='openai'){
      if (motion==='multishot'){
        const variants = buildShotList(framesPerScene);
        for (const v of variants){
          const prompt = `${style} animation still, ${v}. Scene: ${scene}`.slice(0,900);
          try{ const img = await aiImageOpenAI(prompt); if (img) stills.push(img); } catch(e){ console.warn(e); }
        }
      }else{
        try{
          const prompt = `${style} illustration, cinematic, detailed, no text overlay. Scene: ${scene}`.slice(0,900);
          const img = await aiImageOpenAI(prompt); if (img) stills.push(img);
        }catch(e){ console.warn(e); }
      }
    }

    if (stills.length===0){
      if (motion==='multishot'){
        for (let k=0;k<framesPerScene;k++) stills.push( offlinePoster(scene, i, style) );
      } else {
        stills.push( offlinePoster(scene, i, style) );
      }
    }

    placeThumb(i, stills[0]);
    await attachSfxForScene(i, scene);

    done++; setProgress(Math.round(done*100/scenes.length));
    await sleep(50);
  }
}

/* ========= MULTI-SHOT HELPERS ========= */
function buildShotList(n){
  const presets = [
    'wide shot, establishing angle, camera slight left',
    'medium shot, two-thirds view, camera eye-level',
    'close-up, subject emphasis, camera slight right',
    'over-the-shoulder, dynamic framing',
    'low angle dramatic, depth of field',
    'high angle, tabletop, symmetrical frame',
    'profile view, motion blur hint',
    'three-quarter view, gentle perspective'
  ];
  return presets.slice(0,n);
}

/* ========= AUTO SFX: LOCAL + FREESOUND ========= */
const SFX_KEYWORDS = {
  rain: ['rain','storm','thunder','downpour'],
  wind: ['wind','breeze','gust','howl'],
  door: ['door','knock','hinge','gate'],
  steps:['step','footstep','sneak','walk','run'],
  sword:['sword','blade','steel','clash'],
  magic:['magic','spell','enchant','spark','arcane'],
  crowd:['crowd','cheer','many people','market','festival'],
  water:['river','ocean','sea','waves','splash'],
  fire: ['fire','flame','burn','campfire','torch'],
  bird: ['bird','sparrow','eagle','tweet','chirp'],
  animal:['wolf','bear','growl','roar','dog','cat'],
  car:  ['car','engine','drive','vehicle'],
  music:['music','song','sing','melody','lute','guitar','piano'],
};

function detectSfx(sceneText){
  const t = (sceneText||'').toLowerCase();
  let best = null, bestScore = 0;
  const buckets = [];
  for (const [k, words] of Object.entries(SFX_KEYWORDS)){
    if (words.some(w => t.includes(w))) buckets.push(k);
  }
  for (const sfx of SFX_LIB){
    let score = 0;
    for (const tag of (sfx.tags||[])) if (t.includes(tag)) score += 2;
    if (buckets.length) if (buckets.some(b => sfx.tags?.includes(b))) score += 3;
    if (score > bestScore) { bestScore = score; best = sfx; }
  }
  return best && bestScore > 0 ? best : null;
}

const SFX_QUERY_HINTS = [
  ['rain','storm','thunder','downpour'],
  ['wind','breeze','gust'],
  ['door','knock','hinge','gate'],
  ['footstep','footsteps','walk','run','sneak'],
  ['sword','blade','steel','clash'],
  ['magic','spell','arcane','spark'],
  ['crowd','cheer','market','festival'],
  ['river','ocean','sea','waves','water','splash'],
  ['fire','flame','burn','campfire','torch'],
  ['bird','birds','chirp','tweet'],
  ['wolf','bear','growl','animal','roar'],
  ['horse','neigh','gallop'],
  ['car','engine','vehicle'],
  ['forest','jungle','leaves'],
  ['wind chime','chime','bells']
];

function buildSfxQueryFromScene(sceneText){
  const t = (sceneText||'').toLowerCase();
  let best = null, bestHits = 0;
  for (const words of SFX_QUERY_HINTS){
    const hits = words.reduce((acc,w)=> acc + (t.includes(w) ? 1 : 0), 0);
    if (hits > bestHits){ bestHits = hits; best = words; }
  }
  if (best && bestHits>0){
    return best.slice(0,2).join(' ');
  }
  const nouns = (t.match(/[a-z]{4,}/g)||[]).slice(0,3);
  return nouns.join(' ') || 'ambience';
}

async function fetchFreesoundSfx(query){
  const key = (SECRETS.freesound||{}).key;
  if (!key) throw new Error('No Freesound API key');
  const url = `https://freesound.org/apiv2/search/text/?query=${encodeURIComponent(query)}&filter=duration:[0 TO 8]&fields=name,previews,license,username,duration&sort=rating_desc`;
  const res = await fetch(url, { headers: { 'Authorization': 'Token '+key }});
  const data = await res.json();
  if (!res.ok) throw new Error(data?.detail || 'Freesound error');
  const hit = data.results && data.results[0];
  if (!hit) return null;
  const urlMp3 = hit.previews['preview-hq-mp3'] || hit.previews['preview-lq-mp3'] || hit.previews['preview-lq-ogg'];
  if (!urlMp3) return null;
  return { name: hit.name, url: urlMp3, license: hit.license, duration: hit.duration, by: hit.username };
}

async function attachSfxForScene(i, sceneText){
  if ((SETTINGS.autoSfx||'on') !== 'on') return;
  const vol = (SETTINGS.sfxVol||60)/100;
  const mode = SETTINGS.sfxMode || 'fallback';
  const provider = SETTINGS.sfxProvider || 'off';

  let pick = null;
  if (mode==='fallback' || provider==='off'){
    pick = detectSfx(sceneText);
  }
  if ((!pick && provider==='freesound') || (mode==='always' && provider==='freesound')){
    try{
      const q = buildSfxQueryFromScene(sceneText);
      const online = await fetchFreesoundSfx(q);
      if (online) pick = { name: online.name + ' (FS)', url: online.url, license: online.license };
    }catch(e){ console.warn('Freesound:', e); }
  }

  if (!pick) return;
  SETTINGS.sceneSfx = SETTINGS.sceneSfx || {};
  SETTINGS.sceneSfx[i] = { name: pick.name, url: pick.url };
  persist('ba_settings', SETTINGS);

  const slot = document.getElementById('thumb-'+i) || document.getElementById('slot_'+i);
  if (slot && !slot.querySelector('audio')) {
    const audio = document.createElement('audio');
    audio.src = pick.url; audio.preload = 'metadata'; audio.volume = vol; audio.style.display='none'];
    slot.appendChild(audio);
    const btn = document.createElement('button');
    btn.textContent = '▶ SFX';
    btn.className = 'btn small';
    btn.style.position='absolute'; btn.style.right='8px'; btn.style.bottom='8px';
    btn.onclick = ()=>{ audio.currentTime = 0; audio.play(); };
    slot.appendChild(btn);
  }
}

/* ========= EXPORT ZIP ========= */
UI.btnZip.addEventListener('click', async ()=>{
  const files = [];
  const manifest = JSON.stringify({
    version: 3,
    generated: new Date().toISOString(),
    characters: CHARACTERS,
    settings: SETTINGS,
    text: UI.txt.value||'',
    sceneSfx: SETTINGS.sceneSfx || {}
  }, null, 2);
  files.push({name:'project.json', data:new TextEncoder().encode(manifest)});
  const imgs = document.querySelectorAll('#thumbStrip img'); let idx=1;
  for (const img of imgs){
    const bin = await (await fetch(img.src)).arrayBuffer();
    files.push({name:`thumb_${idx++}.png`, data:new Uint8Array(bin)});
  }
  const blob = zipStore(files);
  download(URL.createObjectURL(blob), 'BookAnimator_Finished.zip');
});

/* ========= ZIP (store-only) ========= */
function zipStore(files){
  function crc32(buf){ let c,t=new Uint32Array(256); for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++)c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1);t[n]=c>>>0;} let crc=0^(-1); let a=buf instanceof Uint8Array?buf:new Uint8Array(buf); for(let i=0;i<a.length;i++){crc=(crc>>>8)^t[(crc^a[i])&0xFF];} return (crc^(-1))>>>0; }
  const enc=new TextEncoder(); let recs=[],off=0,chunks=[];
  const push=u8=>{chunks.push(u8);off+=u8.length;};
  const le32=n=>{let b=new Uint8Array(4); new DataView(b.buffer).setUint32(0,n,true); return b;};
  const le16=n=>{let b=new Uint8Array(2); new DataView(b.buffer).setUint16(0,n,true); return b;};
  for(const f of files){
    const name=enc.encode(f.name); const data=f.data instanceof Uint8Array?f.data:new Uint8Array(f.data);
    const crc=crc32(data); const size=data.length;
    push(new Uint8Array([0x50,0x4b,0x03,0x04,20,0,0,0,0,0,0,0,0,0,0,0,0, size&255, size>>8&255, size>>16&255, size>>24&255, size&255, size>>8&255, size>>16&255, size>>24&255, name.length&255, name.length>>8&255, 0,0]));
    push(name); push(data);
    recs.push({name,crc,size,offStart:off-(30+name.length+size)});
  }
  const cdStart=off;
  for(const r of recs){
    push(new Uint8Array([0x50,0x4b,0x01,0x02,20,0,20,0,0,0,0,0,0,0,0,0, r.size&255, r.size>>8&255, r.size>>16&255, r.size>>24&255, r.size&255, r.size>>8&255, r.size>>16&255, r.size>>24&255, r.name.length&255, r.name.length>>8&255, 0,0,0,0,0,0,0,0, r.offStart&255, r.offStart>>8&255, r.offStart>>16&255, r.offStart>>24&255])); push(r.name);
  }
  const cdEnd=off; push(new Uint8Array([0x50,0x4b,0x05,0x06,0,0,0,0, recs.length&255, recs.length>>8&255, recs.length&255, recs.length>>8&255, (cdEnd-cdStart)&255,(cdEnd-cdStart)>>8&255,(cdEnd-cdStart)>>16&255,(cdEnd-cdStart)>>24&255, cdStart&255,cdStart>>8&255,cdStart>>16&255,cdStart>>24&255, 0,0]));
  return new Blob(chunks,{type:"application/zip"});
}

/* ========= UTILS ========= */
function persist(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function setProgress(p){ UI.pct.textContent = p+'%'; UI.bar.style.setProperty('--pct', p/100); }
function download(url,name){ const a=document.createElement('a'); a.href=url; a.download=name; a.click(); }
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function wrapTextCanvas(ctx, text, x, y, maxWidth, lineHeight){
  const words=text.split(' '); let line='';
  for (let n=0;n<words.length;n++){
    const test=line+words[n]+' '; const m=ctx.measureText(test).width;
    if (m>maxWidth && n>0){ ctx.fillText(line,x,y); line=words[n]+' '; y+=lineHeight; } else line=test;
  }
  ctx.fillText(line,x,y);
}
function placeThumb(i, url){
  const slot = document.getElementById('slot_'+i) || document.getElementById('thumb-'+i);
  if (!slot) return; slot.innerHTML=''; const img = document.createElement('img'); img.src=url; img.alt='scene '+(i+1); slot.appendChild(img);
  const idx = document.createElement('div'); idx.className='idx'; idx.textContent = '#'+(i+1); slot.appendChild(idx);
}
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ========= OFFLINE SW ========= */
(function registerSW(){
  if(!('serviceWorker' in navigator)) return;
  const swCode = `
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open('ba-cache-v5').then(c=>c.addAll(['./','index.html'])));
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>self.clients.claim());
    self.addEventListener('fetch', e=>{
      const u = new URL(e.request.url);
      if(u.origin===location.origin){
        e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(resp=>{
          const copy = resp.clone();
          caches.open('ba-cache-v5').then(c=>c.put(e.request, copy)).catch(()=>{});
          return resp;
        }).catch(()=>r)));
      }
    });
  `;
  const blob = new Blob([swCode],{type:'text/javascript'});
  const url = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url);
})();
</script>
</body>
</html>
