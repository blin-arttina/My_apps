<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Book Animator</title>
<style>
  :root{
    --bg:#0b0b0c; --fg:#f2f2f2; --muted:#c9c9c9;
    --red:#c7322b; --red-2:#8f1e19; --card:#141416; --border:#2a2a2e; --chip:#1b1b1f;
    --thumb:#101114; --accent:#fff; /* white progress */
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial}
  h1{font-size:2.2rem;text-align:center;margin:2.5rem 0 1rem}
  .wrap{max-width:980px;margin:0 auto;padding:0 1rem 6rem}
  label{display:block;font-weight:700;margin:.75rem 0 .35rem}
  textarea{width:100%;min-height:240px;padding:1rem;border-radius:10px;border:1px solid var(--border);background:#121214;color:#ddd;font-size:1.05rem}
  .row{display:flex;gap:.75rem;flex-wrap:wrap;margin:1rem 0}
  .btn{background:var(--red);border:1px solid var(--red-2);color:#fff;padding:.75rem 1rem;border-radius:12px;cursor:pointer}
  .btn.secondary{background:transparent;color:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .bar{position:fixed;left:0;right:0;bottom:0;background:#111;border-top:1px solid var(--border);padding:.4rem .75rem;z-index:6}
  .bar-in{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:.75rem}
  .pill{padding:.25rem .6rem;background:var(--chip);border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:.85rem}
  .progress{flex:1;height:10px;background:#222;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
  .progress>span{display:block;height:100%;width:0;background:var(--accent)}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(148px,1fr));gap:.75rem;margin:1rem 0}
  .thumb{background:var(--thumb);border:1px solid var(--border);border-radius:12px;padding:.5rem}
  .thumb canvas{width:100%;aspect-ratio:1/1;border-radius:10px;background:#0f0f11;display:block}
  .thumb .cap{font-size:.8rem;color:var(--muted);margin-top:.4rem}
  /* Menus */
  .hambox{position:fixed;top:18px;left:18px;z-index:20}
  .hamR{left:auto;right:18px}
  .ham{width:48px;height:48px;border-radius:14px;border:1px solid var(--border);background:#121214;display:grid;place-items:center;cursor:pointer}
  .ham i{width:22px;height:2px;background:#ddd;position:relative;display:block}
  .ham i:before,.ham i:after{content:"";position:absolute;left:0;right:0;height:2px;background:#ddd}
  .ham i:before{top:-7px}.ham i:after{top:7px}
  .dropdown{position:fixed;top:78px;left:18px;min-width:300px;max-width:92vw;background:var(--card);border:1px solid var(--border);
    border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:1rem;z-index:25}
  .dropdown.right{left:auto;right:18px}
  .item{padding:.65rem .75rem;border-radius:10px;cursor:pointer}
  .item:hover{background:#191a1d}
  .list{margin:.5rem 0;max-height:60vh;overflow:auto;border-top:1px solid var(--border)}
  .rowi{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding:.75rem .25rem}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:30}
  .card{width:min(720px,92vw);max-height:86vh;overflow:auto;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1rem 1.25rem}
  .g{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  .g3{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem}
  input[type=text],select,.input{width:100%;background:#121214;border:1px solid var(--border);border-radius:10px;color:#ddd;padding:.6rem .7rem}
  .help{color:#9aa0a6;font-size:.9rem}
  .chips{display:flex;flex-wrap:wrap;gap:.4rem}
  .chip{background:#18191c;border:1px solid var(--border);padding:.25rem .6rem;border-radius:999px}
  a.link{color:#fff;text-decoration:underline}
</style>
</head>
<body>

<!-- Left / Right menus -->
<div class="hambox"><button class="ham" id="btnLeft" aria-label="Open left menu"><i></i></button></div>
<div class="hambox hamR"><button class="ham" id="btnRight" aria-label="Open right menu"><i></i></button></div>

<h1>Book Animator</h1>
<div class="wrap">
  <div class="row">
    <span class="pill" id="modePill">Mode: Simple</span>
    <span class="pill" id="scenePill">Scenes: 0</span>
  </div>

  <label for="bookText">Paste your book text:</label>
  <textarea id="bookText" placeholder="Paste text here…"></textarea>

  <div class="row">
    <button class="btn" id="btnStart">Start Animation</button>
    <button class="btn secondary" id="btnPreview">Preview Scenes</button>
  </div>

  <div id="thumbs" class="thumbs" aria-live="polite"></div>
</div>

<!-- Bottom bar -->
<div class="bar">
  <div class="bar-in">
    <button class="btn secondary" id="btnSave">Save</button>
    <button class="btn secondary" id="btnExport">Export Finished (ZIP)</button>
    <div class="progress" title="Progress"><span id="progSpan"></span></div>
    <span class="pill" id="pct">0%</span>
  </div>
</div>

<!-- Left dropdown -->
<div class="dropdown" id="leftDrop" style="display:none">
  <div class="item" data-open="characters">Characters</div>
  <div class="item" data-open="voices">Voices</div>
  <div class="item" data-open="settings">Settings</div>
  <div class="item" data-open="secrets">Secrets (API keys)</div>
  <div class="item" data-open="help">Help</div>
  <div class="list" id="charQuick"></div>
</div>

<!-- Right dropdown -->
<div class="dropdown right" id="rightDrop" style="display:none">
  <div class="item" id="newProject">New Project</div>
  <div class="item" id="openProject">Open Project…</div>
  <div class="item" id="saveProject">Save Project</div>
  <div class="item" id="uploadAssets">Upload Files…</div>
  <div class="item" id="exportZip">Export Finished (ZIP)</div>
</div>

<!-- Modals -->
<div class="modal" id="modal">
  <div class="card" id="modalCard"></div>
</div>

<input type="file" id="hiddenFile" style="display:none" multiple/>

<script>
/* ========= STATE ========= */
const S = {
  version: 3,
  settings: {
    animationType: "Cartoon",
    artStyle: "Bold Lines",
    audience: "All Ages",
    aspect: "16:9",
    fps: 24,
    lineWeight: 2,
    texture: "Clean",
    palette: "Warm",
  },
  voices: { /* characterName -> voiceId */ },
  apiKeys: [], /* {provider, key} */
  characters: [], /* {id,name,age,traits,backstory,voice,thumb,files:[{name,href,type}]} */
  project: { title: "Untitled", scenes: [], thumbs: [] }
};

const STORAGE_KEY = "bookanim_v3";

/* ========= UTIL ========= */
const $ = sel => document.querySelector(sel);
function saveLocal() { localStorage.setItem(STORAGE_KEY, JSON.stringify(S)); }
function loadLocal() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) Object.assign(S, JSON.parse(raw));
  } catch(e){}
}
function modal(html){ $("#modalCard").innerHTML = html; $("#modal").style.display="flex"; }
function closeModal(){ $("#modal").style.display="none"; }
function pill(id, txt){ $(id).textContent = txt; }
function bytesToDataURL(file){
  return new Promise(res=>{
    const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file);
  });
}
function download(name, blob){ const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),2000); }

/* ========= INITIAL DATA (fallbacks) ========= */
const FALLBACK_CHARACTERS = [
  {id:"narrator", name:"Narrator", age:"—", traits:"Neutral guide", backstory:"", voice:"ember", thumb:"", files:[]},
  {id:"sidetrack_sally", name:"Sidetracked Sally", age:"10", traits:"Curious • easily distracted • kind", backstory:"Learns focus via adventures.", voice:"nova", thumb:"", files:[]},
  {id:"darling_danielle", name:"Darling Danielle", age:"12", traits:"Brave • noble", backstory:"Sworn to protect friends.", voice:"coral", thumb:"", files:[]},
  {id:"dark_dan", name:"Dark Dan", age:"13", traits:"Brooding • loyal", backstory:"Fights inner shadows.", voice:"canyon", thumb:"", files:[]},
  {id:"skater_skip", name:"Skater Skip", age:"11", traits:"Fast • witty", backstory:"Dimension-skating prodigy.", voice:"alloy", thumb:"", files:[]},
  {id:"creative_callie", name:"Creative Callie", age:"11", traits:"Inventive • artistic", backstory:"Paints portals.", voice:"shimmer", thumb:"", files:[]},
  {id:"zen_zena", name:"Zen Zena", age:"12", traits:"Calm • wise", backstory:"Guardian of whispering grove.", voice:"verse", thumb:"", files:[]}
];

const OPENAI_VOICES = ["alloy","ember","nova","shimmer","coral","verse","canyon","flux","mono"];

/* ========= BOOT ========= */
loadLocal();
if (!S.characters?.length) S.characters = FALLBACK_CHARACTERS;
S.characters.forEach(c=>{ if (c.voice && !S.voices[c.name]) S.voices[c.name]=c.voice; });
renderQuickList();

/* ========= MENU WIRES ========= */
$("#btnLeft").onclick = ()=> toggleDrop("#leftDrop");
$("#btnRight").onclick = ()=> toggleDrop("#rightDrop");
function toggleDrop(id){
  const el=$(id);
  el.style.display = (el.style.display==="none"||!el.style.display) ? "block" : "none";
}

/* Left dropdown actions */
$("#leftDrop").addEventListener("click", e=>{
  const t = e.target.closest(".item");
  if(!t) return;
  const which = t.dataset.open;
  if(which==="characters") openCharacters();
  if(which==="voices") openVoices();
  if(which==="settings") openSettings();
  if(which==="secrets") openSecrets();
  if(which==="help") openHelp();
});

/* Right dropdown actions */
$("#newProject").onclick = ()=>{ S.project={title:"Untitled",scenes:[],thumbs:[]}; $("#thumbs").innerHTML=""; saveLocal(); alert("New project started."); };
$("#openProject").onclick = ()=>{
  const f = $("#hiddenFile"); f.accept=".json"; f.onchange=async ()=>{
    const file=f.files[0]; if(!file) return;
    const txt = await file.text(); const data = JSON.parse(txt);
    if(data.characters) S.characters = data.characters;
    if(data.settings) S.settings = data.settings;
    if(data.project) S.project = data.project;
    if(data.voices) S.voices = data.voices;
    renderQuickList(); saveLocal(); alert("Project loaded.");
  }; f.click();
};
$("#saveProject").onclick = ()=> doSave();
$("#uploadAssets").onclick = ()=>{ const f=$("#hiddenFile"); f.accept="*/*"; f.onchange=()=>{ [...f.files].forEach(async file=>{
    const href = URL.createObjectURL(file);
    (S.project.assets ||= []).push({name:file.name,type:file.type,href});
  }); saveLocal(); alert("Files attached to project (local only)."); }; f.click(); };
$("#exportZip").onclick = ()=> exportZip();

/* ========= CORE UI ========= */
$("#btnPreview").onclick = ()=> splitScenes();
$("#btnStart").onclick = async ()=>{
  splitScenes();
  await illustrateAll();
};

/* Save bottom buttons */
$("#btnSave").onclick = ()=> doSave();
$("#btnExport").onclick = ()=> exportZip();

/* ========= Characters ========= */
function renderQuickList(){
  const box = $("#charQuick"); box.innerHTML="";
  const head = document.createElement("div"); head.className="rowi"; head.innerHTML="<b>Characters</b>";
  box.appendChild(head);
  S.characters.forEach(c=>{
    const r=document.createElement("div"); r.className="rowi";
    r.innerHTML=`<span>${c.name}</span> <button class="btn secondary" data-eid="${c.id}">Edit</button>`;
    r.querySelector("button").onclick = ()=> editCharacter(c.id);
    box.appendChild(r);
  });
}

/* Character modal list + editor */
function openCharacters(){
  const rows = S.characters.map(c=>`
    <div class="rowi">
      <span>${c.name}</span>
      <button class="btn secondary" onclick="editCharacter('${c.id}')">Edit</button>
    </div>`).join("");
  modal(`
    <h2 style="margin:0 0 .5rem">Characters</h2>
    <div class="list">${rows}</div>
    <div class="row" style="justify-content:flex-end;margin-top:.75rem">
      <button class="btn secondary" onclick="closeModal()">Close</button>
    </div>
  `);
}

window.editCharacter = function(id){
  const c = S.characters.find(x=>x.id===id) || {id, name:"", age:"", traits:"", backstory:"", thumb:"", files:[]};
  const voiceOptions = OPENAI_VOICES.map(v=>`<option value="${v}" ${ (S.voices[c.name]||c.voice)===v?"selected":""}>${v}</option>`).join("");
  const files = (c.files||[]).map(f=>`<li><a class="link" href="${f.href}" target="_blank">${f.name}</a></li>`).join("") || "<span class='help'>No attachments yet.</span>";
  modal(`
    <h2 style="margin:0 0 .75rem">Edit Character</h2>
    <div class="g">
      <div>
        <label>Name</label>
        <input id="ec_name" type="text" value="${c.name||""}">
      </div>
      <div>
        <label>Age</label>
        <input id="ec_age" type="text" value="${c.age||""}">
      </div>
      <div>
        <label>Voice</label>
        <select id="ec_voice">${voiceOptions}</select>
      </div>
      <div>
        <label>Thumbnail</label>
        <div class="row">
          <button class="btn secondary" onclick="pickThumb('${id}')">Upload Image…</button>
          ${c.thumb?`<a class="btn secondary" href="${c.thumb}" download="${c.name||"character"}.png">Download</a>`:""}
        </div>
      </div>
    </div>

    <label>Traits</label>
    <textarea id="ec_traits" style="min-height:80px">${c.traits||""}</textarea>
    <label>Backstory</label>
    <textarea id="ec_back" style="min-height:120px">${c.backstory||""}</textarea>

    <label>Attachments</label>
    <ul id="ec_files" class="help" style="margin:.25rem 0 1rem">${files}</ul>
    <button class="btn secondary" onclick="attachFiles('${id}')">Attach Files…</button>

    <div class="row" style="justify-content:flex-end;margin-top:1rem">
      <button class="btn secondary" onclick="closeModal()">Cancel</button>
      <button class="btn" onclick="saveCharacter('${id}')">Save</button>
    </div>
  `);
}

window.pickThumb = function(id){
  const f=$("#hiddenFile"); f.accept="image/*"; f.onchange=async ()=>{
    const file=f.files[0]; if(!file) return;
    const url=await bytesToDataURL(file);
    const c = S.characters.find(x=>x.id===id);
    if(c){ c.thumb=url; saveLocal(); editCharacter(id); }
  }; f.click();
};

window.attachFiles = function(id){
  const f=$("#hiddenFile"); f.accept="*/*"; f.onchange=async ()=>{
    const c=S.characters.find(x=>x.id===id); if(!c) return;
    c.files ||= [];
    for(const file of f.files){
      let href = URL.createObjectURL(file);
      /* also cache images as dataURL for long-term local */
      if(file.type.startsWith("image/")) href = await bytesToDataURL(file);
      c.files.push({name:file.name, href, type:file.type});
    }
    saveLocal(); editCharacter(id);
  }; f.click();
};

window.saveCharacter = function(id){
  const c = S.characters.find(x=>x.id===id) || {id};
  c.name = $("#ec_name").value.trim();
  c.age = $("#ec_age").value.trim();
  c.traits = $("#ec_traits").value.trim();
  c.backstory = $("#ec_back").value.trim();
  c.voice = $("#ec_voice").value;
  S.voices[c.name] = c.voice;
  if(!S.characters.find(x=>x.id===id)) S.characters.push(c);
  saveLocal(); renderQuickList(); closeModal();
};

/* ========= Voices ========= */
function openVoices(){
  const rows = S.characters.map(c=>{
    const cur = S.voices[c.name] || c.voice || "";
    const opts = OPENAI_VOICES.map(v=>`<option ${v===cur?"selected":""}>${v}</option>`).join("");
    return `<div class="rowi">
      <span>${c.name}</span>
      <select onchange="setVoice('${c.name}', this.value)">${opts}</select>
    </div>`;
  }).join("");
  modal(`
    <h2 style="margin:0 0 .5rem">Voices</h2>
    <div class="list">${rows}</div>
    <p class="help">These are local voice IDs for synthesis mapping. (OpenAI voice inference requires a backend.)</p>
    <div class="row" style="justify-content:flex-end"><button class="btn" onclick="closeModal()">Close</button></div>
  `);
}
window.setVoice = (name,val)=>{ S.voices[name]=val; const c=S.characters.find(x=>x.name===name); if(c) c.voice=val; saveLocal(); };

/* ========= Settings ========= */
function openSettings(){
  const s=S.settings;
  const anims = ["Cartoon","Anime","Dark Fantasy","Flip-book","Comic","Watercolor","Low-poly","3D Cel"];
  const arts = ["Bold Lines","Ink & Wash","Soft Pastel","Retro Comic","Noir","Vaporwave","Painterly"];
  modal(`
    <h2 style="margin:0 0 .75rem">Settings</h2>
    <div class="g">
      <div>
        <label>Animation type</label>
        <select id="st_anim">${anims.map(a=>`<option ${s.animationType===a?"selected":""}>${a}</option>`).join("")}</select>
      </div>
      <div>
        <label>Art style</label>
        <select id="st_art">${arts.map(a=>`<option ${s.artStyle===a?"selected":""}>${a}</option>`).join("")}</select>
      </div>
      <div>
        <label>Audience / Age</label>
        <input id="st_aud" type="text" value="${s.audience}">
      </div>
      <div>
        <label>Aspect</label>
        <select id="st_aspect">${["16:9","9:16","1:1"].map(a=>`<option ${s.aspect===a?"selected":""}>${a}</option>`).join("")}</select>
      </div>
      <div>
        <label>FPS</label>
        <select id="st_fps">${[12,24,30].map(n=>`<option ${s.fps==n?"selected":""}>${n}</option>`).join("")}</select>
      </div>
      <div>
        <label>Palette</label>
        <select id="st_pal">${["Warm","Cool","Mono","Neon"].map(p=>`<option ${s.palette===p?"selected":""}>${p}</option>`).join("")}</select>
      </div>
    </div>
    <div class="g">
      <div><label>Line weight</label><input id="st_line" type="text" value="${s.lineWeight}"></div>
      <div><label>Texture</label><input id="st_tex" type="text" value="${s.texture}"></div>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn secondary" onclick="closeModal()">Cancel</button>
      <button class="btn" onclick="saveSettings()">Save</button>
    </div>
  `);
}
window.saveSettings = ()=>{
  const s=S.settings;
  s.animationType=$("#st_anim").value;
  s.artStyle=$("#st_art").value;
  s.audience=$("#st_aud").value;
  s.aspect=$("#st_aspect").value;
  s.fps=+$("#st_fps").value;
  s.palette=$("#st_pal").value;
  s.lineWeight=$("#st_line").value;
  s.texture=$("#st_tex").value;
  saveLocal(); closeModal();
};

/* ========= Secrets (API Keys) ========= */
function openSecrets(){
  const rows = (S.apiKeys||[]).map((k,i)=>`
    <div class="rowi"><span>${k.provider}</span>
      <button class="btn secondary" onclick="delKey(${i})">Remove</button></div>`).join("") || "<p class='help'>No keys added.</p>";
  modal(`
    <h2 style="margin:0 0 .75rem">Secrets (API keys)</h2>
    <div class="help" style="margin-bottom:.5rem">Static pages store keys in your browser only. For production, use a server-side vault.</div>
    ${rows}
    <div class="g" style="margin-top:.75rem">
      <input id="secProv" type="text" placeholder="Provider (e.g., ElevenLabs)"/>
      <input id="secKey"  type="text" placeholder="API Key"/>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn secondary" onclick="closeModal()">Close</button>
      <button class="btn" onclick="addKey()">Add</button>
    </div>
  `);
}
window.addKey=()=>{ const p=$("#secProv").value.trim(), k=$("#secKey").value.trim(); if(!p||!k) return; (S.apiKeys ||= []).push({provider:p,key:k}); saveLocal(); openSecrets(); };
window.delKey=i=>{ S.apiKeys.splice(i,1); saveLocal(); openSecrets(); };

/* ========= Help ========= */
function openHelp(){
  modal(`
    <h2 style="margin:0 0 .5rem">Help</h2>
    <p>1) Paste text → Preview Scenes → Start Animation.<br>
       2) Use <b>Characters</b> to set traits, backstories, thumbnails & voices.<br>
       3) <b>Settings</b> chooses animation/art style and render options.<br>
       4) Use right ≡ to <b>Open/Save</b>, <b>Upload files</b>, or <b>Export ZIP</b>.</p>
    <div class="row" style="justify-content:flex-end"><button class="btn" onclick="closeModal()">Close</button></div>
  `);
}

/* ========= Scene split & illustration ========= */
function splitScenes(){
  const t=$("#bookText").value.trim();
  const chunks = t.split(/\n{2,}|(?<=[.!?])\s*\n/).map(s=>s.trim()).filter(Boolean);
  S.project.scenes = chunks.map((text, i)=>({i, text}));
  pill("#scenePill", `Scenes: ${chunks.length}`);
  saveLocal();
}

/* Simple offline “illustrator” → draws an abstract image from keywords */
function drawThumb(canvas, text){
  const ctx=canvas.getContext("2d");
  const {palette, artStyle} = S.settings;
  // Background gradient from palette
  const g=ctx.createLinearGradient(0,0,0,canvas.height);
  const pal = palette==="Warm" ? ["#3b1d1a","#6d2b22","#a63a2e"]
           : palette==="Cool" ? ["#152436","#1b3a5b","#2b5f7d"]
           : palette==="Neon" ? ["#1a1030","#2a0a5e","#5e0aa6"]
           : ["#111","#1a1a1a","#222"];
  pal.forEach((c,i)=>g.addColorStop(i/(pal.length-1), c));
  ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);

  // Extract nouns-ish keywords
  const words = (text.toLowerCase().match(/[a-z]{4,}/g)||[])
    .filter((w,i,a)=>a.indexOf(w)===i).slice(0,7);

  // Style overlays
  if(artStyle.includes("Lines")){
    ctx.globalAlpha=.2; ctx.strokeStyle="#fff"; ctx.lineWidth=1.5;
    for(let y=10;y<canvas.height;y+=14){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y-8); ctx.stroke(); }
    ctx.globalAlpha=1;
  } else if(artStyle.includes("Ink")){
    ctx.globalAlpha=.15; ctx.fillStyle="#000";
    for(let i=0;i<200;i++){ const x=Math.random()*canvas.width,y=Math.random()*canvas.height,r=Math.random()*3; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
    ctx.globalAlpha=1;
  }

  // Place glyphs for words
  ctx.fillStyle="#fff";
  ctx.font="bold 22px system-ui,Segoe UI";
  words.forEach((w,idx)=>{
    const x=20+ (idx%3)* (canvas.width/3) + (Math.random()*20-10);
    const y=40+ Math.floor(idx/3)*90 + (Math.random()*10-5);
    ctx.globalAlpha=.18; ctx.fillText("★", x-6, y-10);
    ctx.globalAlpha=.95; ctx.fillText(w, x, y);
  });

  // Frame
  ctx.globalAlpha=1; ctx.strokeStyle="rgba(255,255,255,.35)"; ctx.lineWidth=3; ctx.strokeRect(6,6,canvas.width-12,canvas.height-12);
}

async function illustrateAll(){
  const scenes=S.project.scenes; if(!scenes.length){ alert("No scenes yet. Paste text and Preview first."); return; }
  const thumbsDiv=$("#thumbs"); thumbsDiv.innerHTML="";
  const bar=$("#progSpan"), pct=$("#pct");
  for(let i=0;i<scenes.length;i++){
    const c=document.createElement("canvas"); c.width=512; c.height=512;
    drawThumb(c, scenes[i].text);
    const cell=document.createElement("div"); cell.className="thumb";
    cell.appendChild(c);
    const cap=document.createElement("div"); cap.className="cap"; cap.textContent=`Scene ${i+1}`;
    cell.appendChild(cap);
    thumbsDiv.appendChild(cell);
    // store dataURL
    S.project.thumbs[i]=c.toDataURL("image/png");
    const progress=Math.round(((i+1)/scenes.length)*100);
    bar.style.width=progress+"%"; pct.textContent=progress+"%";
    await new Promise(r=>setTimeout(r, 120)); // small yield for UI
  }
  saveLocal();
}

/* ========= Save / Export ========= */
function doSave(){
  const blob=new Blob([JSON.stringify(S,null,2)],{type:"application/json"});
  download("book-animator-project.json", blob);
}

async function exportZip(){
  // minimal in-browser zip (no deps): assemble as “store” using DataURL → this keeps it simple
  const files = [
    {name:"project.json", data: JSON.stringify(S,null,2)},
  ];
  (S.project.thumbs||[]).forEach((dataURL,i)=>files.push({name:`thumb_${i+1}.png`, data:dataURL}));

  // Build a RFC 2397 “bundle” HTML if true ZIP isn’t available without a lib.
  const html = `<!doctype html><meta charset="utf-8"><title>BookAnimator Export</title>
  <h1>BookAnimator Export</h1>
  <p>This page contains your files as downloadable links.</p>
  <ul>
    ${files.map(f=>{
      if(f.name.endsWith(".png")){
        return `<li><a download="${f.name}" href="${f.data}">${f.name}</a></li>`;
      }else{
        return `<li><a download="${f.name}" href="data:application/json;base64,${btoa(unescape(encodeURIComponent(f.data)))}">${f.name}</a></li>`;
      }
    }).join("")}
  </ul>`;
  const blob=new Blob([html],{type:"text/html"}); download("BookAnimator_Finished.html", blob);
}

/* ========= Load voices.txt if hosted nearby ========= */
fetch("Voices.txt").then(r=> r.ok? r.text():Promise.reject())
.then(txt=>{
  // expecting lines "Character = voiceId"
  txt.split(/\r?\n/).forEach(line=>{
    const m=line.match(/^\s*([^=]+?)\s*=\s*([a-z0-9_-]+)\s*$/i);
    if(m){ const name=m[1].trim(); const vid=m[2].trim(); S.voices[name]=vid;
      const c=S.characters.find(x=>x.name===name); if(c) c.voice=vid;
    }
  });
  saveLocal();
}).catch(()=>{/* ignore if missing */});

/* ========= Keyboard nicety ========= */
document.addEventListener("keydown", e=>{
  if(e.key==="Escape") closeModal();
});
</script>
</body>
</html>