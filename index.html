<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Book Animator</title>
<style>
:root{--bg:#0b0b0b;--panel:#111;--ink:#eee;--muted:#bbb;--line:#333;--accent:#ef4444}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif}
h1{font-size:2.2rem;margin:1rem 0;text-align:center}
.wrap{max-width:1200px;margin:0 auto;padding:1rem}
.topbar{display:flex;justify-content:space-between;align-items:center}
.hamb{width:48px;height:48px;border:1px solid #555;border-radius:12px;display:grid;place-items:center;background:#121212;cursor:pointer}
.hamb .line{width:24px;height:3px;background:#fff;margin:4px 0;border-radius:2px}
.badge{display:inline-block;background:#151515;border:1px solid #333;padding:.28rem .7rem;border-radius:999px;margin:.2rem .3rem;color:#ddd}
textarea{width:100%;min-height:260px;background:#0f0f0f;border:1px solid #333;border-radius:12px;color:#ddd;font-size:1.02rem;line-height:1.5;padding:1rem}
.bar{display:flex;gap:.8rem;flex-wrap:wrap;margin-top:1rem}
.btn{background:#151515;border:1px solid var(--accent);color:#eee;padding:.7rem 1rem;border-radius:12px;cursor:pointer}
.btn.ghost{border-color:#555}
.btn.small{padding:.45rem .7rem;border-radius:10px}
.thumbs{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem;margin:1.2rem 0}
.tile{height:160px;border:1px dashed #777;border-radius:12px;background:#0f0f0f;display:grid;place-items:center;position:relative}
.tile img{width:100%;height:100%;object-fit:cover;border-radius:12px}
.tile .num{position:absolute;top:6px;left:6px;font-size:.9rem;background:#000a;padding:.1rem .4rem;border-radius:7px;border:1px solid #333}
.progress{position:fixed;left:0;right:0;bottom:0;background:#0d0d0d;border-top:1px solid #1a1a1a;padding:.6rem 1rem;display:flex;gap:1rem;align-items:center;z-index:5}
.meter{flex:1;height:10px;background:#1a1a1a;border-radius:999px;overflow:hidden}
.meter>div{height:100%;width:0;background:#fff;transition:width .15s ease}
.pct{min-width:64px;text-align:right;color:#bbb}
/* menus & modals */
.menu,.modal{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;padding-top:5vh;background:#0009;z-index:40}
.card{background:#111;border:1px solid #333;border-radius:16px;box-shadow:0 6px 30px #0009;padding:1rem;max-width:980px;width:92vw;max-height:82vh;overflow:auto}
.tabs{display:flex;gap:.5rem;margin-bottom:1rem}
.tabs .btn{border-color:#444}
.list{display:flex;flex-direction:column;gap:.5rem}
.item{display:flex;justify-content:space-between;align-items:center;background:#101010;border:1px solid #333;padding:.75rem 1rem;border-radius:12px}
.grid{display:grid;gap:.75rem}
.two{grid-template-columns:1fr 1fr}
small.muted{color:#aaa}
/* segmented controls */
.seg{display:flex;gap:.5rem;flex-wrap:wrap}
.opt{background:#1a1a1a;border:1px solid #444;color:#eee;padding:.45rem .7rem;border-radius:10px;cursor:pointer}
.opt.active{border-color:var(--accent);box-shadow:0 0 0 2px #ef44441c}
/* canvas for video export */
#videoPreview{display:none}
</style>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
<div class="wrap" id="app">
  <div class="topbar">
    <button class="hamb" id="btnLeft" aria-label="Open left menu"><div class="line"></div><div class="line"></div><div class="line"></div></button>
    <h1>Book Animator</h1>
    <button class="hamb" id="btnRight" aria-label="Open right menu"><div class="line"></div><div class="line"></div><div class="line"></div></button>
  </div>

  <div style="display:flex;justify-content:center;gap:.4rem;margin-bottom:.6rem">
    <span class="badge">Mode: <b id="modeBadge">Simple</b></span>
    <span class="badge">Scenes: <b id="scenesBadge">0</b></span>
  </div>

  <h3>Paste your book text:</h3>
  <textarea id="bookText" placeholder="Paste text here…"></textarea>

  <div class="bar">
    <button class="btn" id="btnPreview">Preview Scenes</button>
    <button class="btn" style="background:var(--accent)" id="btnStart">Generate (Images + Voice + SFX)</button>
  </div>

  <div class="thumbs" id="thumbs"></div>
</div>

<!-- bottom toolbar -->
<div class="progress">
  <button class="btn small" id="btnSave">Save</button>
  <button class="btn small" id="btnZip">Export (ZIP)</button>
  <button class="btn small" id="btnVideo">Export Video (WebM beta)</button>
  <div class="meter"><div id="meterFill"></div></div>
  <div class="pct" id="pct">0%</div>
</div>

<!-- LEFT MENU -->
<div class="menu" id="leftMenu">
  <div class="card">
    <div class="tabs">
      <button class="btn small" data-tab="tChars">Characters</button>
      <button class="btn small" data-tab="tSettings">Settings</button>
      <button class="btn small" data-tab="tSecrets">Secrets</button>
      <button class="btn small" data-tab="tHelp">Help</button>
      <button class="btn small" style="margin-left:auto" id="closeLeft">Close</button>
    </div>

    <section id="tChars">
      <h2>Characters</h2>
      <div id="charList" class="list"></div>
      <small class="muted">Tap <b>Edit</b> to set voice (OpenAI or ElevenLabs), notes, and portrait. Use <b>Preview</b> to hear the voice.</small>
    </section>

    <section id="tSettings" style="display:none">
      <h2>Settings</h2>
      <div class="grid two">
        <label class="item" style="display:grid;grid-template-columns:12rem 1fr;gap:.6rem">
          <span>Render Mode</span>
          <select id="setRenderMode">
            <option value="offline">Offline (placeholders)</option>
            <option value="online">Online AI (use proxy)</option>
          </select>
        </label>

        <label class="item" style="display:grid;grid-template-columns:12rem 1fr;gap:.6rem">
          <span>Render Motion</span>
          <div id="renderMotions" class="seg"></div>
        </label>

        <label class="item" style="display:grid;grid-template-columns:12rem 1fr;gap:.6rem">
          <span>Art Style</span>
          <div id="artStyles" class="seg"></div>
        </label>

        <label class="item" style="display:grid;grid-template-columns:12rem 1fr;gap:.6rem">
          <span>Aspect</span>
          <select id="setAspect">
            <option>16:9</option><option>9:16</option><option>1:1</option>
          </select>
        </label>
      </div>
    </section>

    <section id="tSecrets" style="display:none">
      <h2>Secrets</h2>
      <div class="grid">
        <label class="item" style="display:grid;grid-template-columns:12rem 1fr;gap:.6rem">
          <span>Proxy URL</span>
          <input id="proxyBase" placeholder="https://ai-proxydjs.blindart2020.workers.dev"/>
        </label>
        <div style="display:flex;gap:.6rem;justify-content:flex-end">
          <button class="btn ghost" id="btnTestProxy">Test Proxy</button>
          <button class="btn" id="btnSaveSecrets">Save</button>
        </div>
        <small class="muted">Keys live in your Cloudflare Worker; this app stores only the URL locally.</small>
      </div>
    </section>

    <section id="tHelp" style="display:none">
      <h2>Help</h2>
      <p>Right menu → Uploads for JSON or reference files. In Settings pick Motion and Art Style. Put your Worker URL in Secrets, then switch Render Mode to Online. Use Export to get a ZIP or a beta WebM video.</p>
    </section>
  </div>
</div>

<!-- RIGHT MENU -->
<div class="menu" id="rightMenu">
  <div class="card">
    <div class="tabs">
      <button class="btn small" data-rtab="uUploads">Uploads</button>
      <button class="btn small" data-rtab="uProject">Project</button>
      <button class="btn small" style="margin-left:auto" id="closeRight">Close</button>
    </div>

    <section id="uUploads">
      <h2>Uploads</h2>
      <div class="grid two">
        <label class="item"><span>Import Characters JSON</span><input id="fileChars" type="file" accept="application/json"/></label>
        <label class="item"><span>General Uploads</span><input id="fileGeneral" type="file" multiple/></label>
      </div>
      <div id="uploadList" class="list"></div>
    </section>

    <section id="uProject" style="display:none">
      <h2>Project</h2>
      <div class="grid">
        <button class="btn small" id="btnClearThumbs">Clear Thumbnails</button>
        <button class="btn small" id="btnWipe">Wipe Local Data</button>
      </div>
    </section>
  </div>
</div>

<!-- Character editor -->
<div class="modal" id="charModal">
  <div class="card" style="max-width:860px">
    <h2>Edit Character</h2>
    <div class="grid">
      <label class="item" style="display:grid;grid-template-columns:10rem 1fr;gap:.6rem">
        <span>Name</span><input id="ceName"/>
      </label>
      <label class="item" style="display:grid;grid-template-columns:10rem 1fr;gap:.6rem">
        <span>Traits / Notes</span><input id="ceNotes" placeholder="personality, role…"/>
      </label>
      <label class="item" style="display:grid;grid-template-columns:10rem 1fr;gap:.6rem">
        <span>Voice (OpenAI)</span>
        <select id="ceVoice">
          <option value="ember">Ember</option><option value="maple">Maple</option>
          <option value="juniper">Juniper</option><option value="sage">Sage</option>
          <option value="alloy">Alloy</option><option value="verse">Verse</option>
          <option value="aria">Aria</option><option value="amber">Amber</option>
          <option value="spruce">Spruce</option><option value="breeze">Breeze</option>
          <option value="vale">Vale</option><option value="shimmer">Shimmer</option>
          <option value="cove">Cove</option><option value="sol">Sol</option>
        </select>
      </label>
      <label class="item" style="display:grid;grid-template-columns:10rem 1fr;gap:.6rem">
        <span>Voice (11Labs ID)</span><input id="ce11" placeholder="optional"/>
      </label>
      <label class="item" style="display:grid;grid-template-columns:10rem 1fr;gap:.6rem">
        <span>Portrait</span><input id="cePortrait" type="file" accept="image/*"/>
      </label>
    </div>
    <div class="bar" style="justify-content:flex-end">
      <button class="btn ghost" id="cePreview">Preview</button>
      <button class="btn ghost" id="ceCancel">Cancel</button>
      <button class="btn" id="ceSave">Save</button>
    </div>
  </div>
</div>

<!-- hidden canvas for video export -->
<canvas id="videoPreview" width="1280" height="720"></canvas>

<script>
/* ========== tiny utils ========== */
const $=id=>document.getElementById(id);
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))||d;}catch{return d;}};
const fileToDataURL=f=>new Promise(r=>{const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(f);});
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
function escapeHtml(s){const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};return (s||'').replace(/[&<>"']/g,ch=>map[ch]);}

/* ========== refs & state ========== */
const UI={
  leftBtn:$('btnLeft'), rightBtn:$('btnRight'),
  leftMenu:$('leftMenu'), rightMenu:$('rightMenu'),
  closeLeft:$('closeLeft'), closeRight:$('closeRight'),
  tabBtns:[...document.querySelectorAll('[data-tab]')],
  rtabBtns:[...document.querySelectorAll('[data-rtab]')],
  setRenderMode:$('setRenderMode'), setAspect:$('setAspect'),
  proxyBase:$('proxyBase'), btnSaveSecrets:$('btnSaveSecrets'), btnTestProxy:$('btnTestProxy'),
  fileChars:$('fileChars'), fileGeneral:$('fileGeneral'), uploadList:$('uploadList'),
  txt:$('bookText'), thumbs:$('thumbs'),
  preview:$('btnPreview'), start:$('btnStart'),
  scenesBadge:$('scenesBadge'), modeBadge:$('modeBadge'),
  meter:$('meterFill'), pct:$('pct'),
  btnZip:$('btnZip'), btnSave:$('btnSave'), btnVideo:$('btnVideo')
};
let SETTINGS=load('ba_settings',{renderMode:'offline',artStyle:'Comic',visualMotion:'Ken Burns',aspect:'16:9'});
let SECRETS=load('ba_secrets',{proxy:'https://ai-proxydjs.blindart2020.workers.dev'});
let CHARS=load('ba_chars',defaultCharacters());
let ASSETS={images:[],narration:[],sfx:[]};
let editingIx=-1;

/* ========== menus ========== */
if(UI.leftBtn)UI.leftBtn.addEventListener('click',()=>UI.leftMenu.style.display='flex');
if(UI.rightBtn)UI.rightBtn.addEventListener('click',()=>UI.rightMenu.style.display='flex');
if(UI.closeLeft)UI.closeLeft.addEventListener('click',()=>UI.leftMenu.style.display='none');
if(UI.closeRight)UI.closeRight.addEventListener('click',()=>UI.rightMenu.style.display='none');
UI.tabBtns.forEach(b=>b.addEventListener('click',()=>['tChars','tSettings','tSecrets','tHelp'].forEach(k=>$(k).style.display=k===b.dataset.tab?'block':'none')));
UI.rtabBtns.forEach(b=>b.addEventListener('click',()=>['uUploads','uProject'].forEach(k=>$(k).style.display=k===b.dataset.rtab?'block':'none')));

/* ========== segmented controls ========== */
const ART_STYLES=["Comic","Cartoon","Anime","Watercolor","Ink & Wash","Digital Paint","Flat Toon","Dark Fantasy","Low-Poly","Flip Book"];
const RENDER_MOTIONS=["Ken Burns","Pan Left","Pan Right","Zoom In","Zoom Out","Static"];
function buildSeg(id,opts,cur,onPick){
  const host=$(id); host.innerHTML='';
  opts.forEach(n=>{
    const b=document.createElement('button');
    b.type='button'; b.className='opt'+(n===cur?' active':''); b.textContent=n;
    b.onclick=()=>{host.querySelectorAll('.opt').forEach(x=>x.classList.remove('active')); b.classList.add('active'); onPick(n);};
    host.appendChild(b);
  });
}
UI.setRenderMode.value=SETTINGS.renderMode; UI.setAspect.value=SETTINGS.aspect;
buildSeg('artStyles',ART_STYLES,SETTINGS.artStyle,v=>{SETTINGS.artStyle=v;save('ba_settings',SETTINGS);});
buildSeg('renderMotions',RENDER_MOTIONS,SETTINGS.visualMotion,v=>{SETTINGS.visualMotion=v;save('ba_settings',SETTINGS);});
UI.modeBadge.textContent=SETTINGS.renderMode==='online'?'Online':'Simple';

/* ========== secrets/save ========== */
UI.btnSaveSecrets.onclick=()=>{
  SECRETS.proxy=(UI.proxyBase.value||'').trim();
  SETTINGS.renderMode=UI.setRenderMode.value;
  SETTINGS.aspect=UI.setAspect.value;
  save('ba_secrets',SECRETS); save('ba_settings',SETTINGS);
  UI.modeBadge.textContent=SETTINGS.renderMode==='online'?'Online':'Simple';
  alert('Saved.');
};
UI.btnTestProxy.onclick=async()=>{
  const base=(UI.proxyBase.value||'').replace(/\/$/,'');
  if(!base) return alert('Enter proxy URL first');
  try{const r=await fetch(base+'/health'); alert(r.ok?'✅ Proxy reachable':'❌ Proxy error');}catch{alert('❌ Proxy unreachable');}
};

/* ========== uploads ========== */
UI.fileGeneral.addEventListener('change',e=>{
  const files=[...e.target.files]; UI.uploadList.innerHTML='';
  files.forEach(f=>{const row=document.createElement('div'); row.className='item'; row.textContent=f.name+' ('+Math.round(f.size/1024)+' KB)'; UI.uploadList.appendChild(row);});
});
UI.fileChars.addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f)return;
  try{ CHARS=JSON.parse(await f.text()); save('ba_chars',CHARS); renderCharList(); alert('Characters imported'); }
  catch{ alert('Invalid Characters JSON'); }
});

/* ========== characters ========== */
function defaultCharacters(){
  const names=['Narrator','Sidetracked Sally','Darling Danielle','Dark Dan','Skater Skip','Creative Callie','Zen Zena','Grumpy Gus'];
  return names.map(n=>({name:n,notes:'',voice:'ember',eleven:'',portrait:''}));
}
function renderCharList(){
  const list=$('charList'); list.innerHTML='';
  CHARS.forEach((c,ix)=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML = '<div><div style="font-weight:700">'+escapeHtml(c.name)+'</div><div style="color:#bbb;font-size:.9rem">OpenAI: '+escapeHtml(c.voice||'ember')+(c.eleven?' · 11Labs:'+escapeHtml(c.eleven):'')+'</div></div><div><button class="btn small" data-edit="'+ix+'">Edit</button></div>';
    list.appendChild(el);
  });
  list.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>openChar(+b.dataset.edit));
}
renderCharList();

function openChar(ix){
  editingIx=ix; const c=CHARS[ix];
  showChar(true);
  $('ceName').value=c.name; $('ceNotes').value=c.notes||''; $('ceVoice').value=c.voice||'ember';
  $('ce11').value=c.eleven||''; $('cePortrait').value='';
}
function showChar(v){ $('charModal').style.display=v?'flex':'none'; }
$('ceCancel').onclick=()=>showChar(false);
$('ceSave').onclick=async()=>{
  const c=CHARS[editingIx];
  c.name=$('ceName').value.trim()||c.name;
  c.notes=$('ceNotes').value.trim();
  c.voice=$('ceVoice').value;
  c.eleven=$('ce11').value.trim();
  const f=$('cePortrait').files?.[0]; if(f) c.portrait=await fileToDataURL(f);
  save('ba_chars',CHARS); renderCharList(); showChar(false);
};
$('cePreview').onclick=async()=>{
  const name=$('ceName').value||'Friend';
  const voice=$('ceVoice').value||'ember';
  try{
    const url=await ttsOpenAI(`Hello, I'm ${name}. This is a short preview.`, voice);
    new Audio(url).play();
  }catch{ alert('Preview failed. Check proxy URL and Online mode.'); }
};

/* ========== scenes & generation ========== */
UI.preview.onclick=()=>updateSceneCount();
function updateSceneCount(){
  const scenes=splitScenes(UI.txt.value);
  UI.scenesBadge.textContent=scenes.length;
  UI.thumbs.innerHTML='';
  scenes.forEach((_,i)=> UI.thumbs.appendChild(makeTile(i+1)));
}
function splitScenes(t){return t.split(/\n{2,}/).map(s=>s.trim()).filter(Boolean);}
function makeTile(n){const t=document.createElement('div'); t.className='tile'; t.innerHTML=`<div class="num">#${n}</div><span style="color:#ccc">waiting…</span>`; return t;}

/* proxy helpers — assumes Cloudflare Worker implements /images, /voice/openai, /voice/11labs, /sfx/auto */
function getProxyBase(){ const base=(SECRETS.proxy||'').replace(/\/+$/,''); return base||'https://ai-proxydjs.YOURNAME.workers.dev'; }
async function callProxy(path,{method='POST',json=null,qs=null,expect='json'}={}){
  const base=getProxyBase(), q=qs?('?'+new URLSearchParams(qs).toString()):'', url=`${base}${path}${q}`;
  const res=await fetch(url,{method,headers:json?{'Content-Type':'application/json'}:undefined,body:json?JSON.stringify(json):undefined});
  if(!res.ok) throw new Error(`${path} ${res.status}`);
  if(expect==='blob') return await res.blob();
  return await res.json();
}
async function genImage(prompt,style,aspect){ const blob=await callProxy('/images',{json:{prompt,style,aspect}},null,'blob'); return URL.createObjectURL(blob); }
async function ttsOpenAI(text,voice='ember'){ const blob=await callProxy('/voice/openai',{json:{text,voice}},null,'blob'); return URL.createObjectURL(blob); }
async function ttsEleven(text,voice_id){ const blob=await callProxy('/voice/11labs',{json:{text,voice_id}},null,'blob'); return URL.createObjectURL(blob); }
async function autoSfx(text){ const blob=await callProxy('/sfx/auto',{json:{text}},null,'blob'); return URL.createObjectURL(blob); }

UI.start.onclick = async ()=>{
  const scenes=splitScenes(UI.txt.value);
  if(!scenes.length) return alert('Paste some text first.');
  const online=SETTINGS.renderMode==='online';
  UI.thumbs.innerHTML=''; scenes.forEach((_,i)=> UI.thumbs.appendChild(makeTile(i+1)));
  $('meterFill').style.width='0%'; $('pct').textContent='0%';
  ASSETS={images:[],narration:[],sfx:[]};

  const narrator = CHARS.find(c=>/^narrator$/i.test(c.name)) || CHARS[0] || {voice:'ember'};

  for(let i=0;i<scenes.length;i++){
    const tile = UI.thumbs.children[i];
    try{
      let imgUrl;
      if(online){
        const prompt = `Illustration, ${SETTINGS.artStyle}. Scene: ${scenes[i]}`;
        imgUrl = await genImage(prompt, SETTINGS.artStyle, SETTINGS.aspect);
      }else{
        imgUrl = await placeholderPNG(`Scene ${i+1}`, `${SETTINGS.artStyle} • ${SETTINGS.visualMotion}`);
      }
      ASSETS.images[i]=imgUrl;
      tile.innerHTML = `<div class="num">#${i+1}</div><img alt="scene ${i+1}" src="${imgUrl}"/>`;

      let voiceUrl=null;
      if(online){
        voiceUrl = narrator.eleven ? await ttsEleven(scenes[i], narrator.eleven)
                                   : await ttsOpenAI(scenes[i], narrator.voice||'ember');
      }
      ASSETS.narration[i]=voiceUrl;

      let sfxUrl=null;
      if(online){ try{ sfxUrl = await autoSfx(scenes[i]); } catch(e){ sfxUrl=null; } }
      ASSETS.sfx[i]=sfxUrl;

    }catch(err){
      const ph=await placeholderPNG(`Scene ${i+1}`,'Failed');
      ASSETS.images[i]=ph;
      tile.innerHTML=`<div class="num">#${i+1}</div><img src="${ph}"/>`;
    }
    const p=Math.round(((i+1)/scenes.length)*100);
    $('meterFill').style.width=p+'%'; $('pct').textContent=p+'%';
    await sleep(40);
  }
  alert('Scenes processed.');
};

/* placeholders */
async function placeholderPNG(title,subtitle=''){
  const w=640,h=360,pad=18,r=12;
  const c=document.createElement('canvas'); c.width=w;c.height=h;
  const x=c.getContext('2d');
  x.fillStyle='#0f0f0f'; x.fillRect(0,0,w,h);
  x.strokeStyle='#666'; x.lineWidth=2; roundRect(x,pad,pad,w-pad*2,h-pad*2,r); x.stroke();
  x.fillStyle='#fff'; x.font='bold 22px Inter, system-ui'; x.fillText(title,26,50);
  x.fillStyle='#bbb'; x.font='15px Inter, system-ui'; wrapText(x,subtitle,26,80,w-52,20);
  return c.toDataURL('image/png');
}
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
function wrapText(ctx,text,x,y,max,lh){const words=(text||'').split(/\s+/), line=[];for(const w of words){const test=[...line,w].join(' ');if(ctx.measureText(test).width>max){ctx.fillText(line.join(' '),x,y);line.length=0;y+=lh;}line.push(w);}ctx.fillText(line.join(' '),x,y);}

/* ========== export ZIP ========== */
$('btnZip').onclick = async ()=>{
  const zip=new JSZip();
  const manifest={settings:SETTINGS,characters:CHARS,scenes:[]};
  for(let i=0;i<ASSETS.images.length;i++){
    manifest.scenes[i]={
      image:`scene-${String(i+1).padStart(3,'0')}.png`,
      narration: ASSETS.narration[i] ? `scene-${String(i+1).padStart(3,'0')}.mp3` : null,
      sfx: ASSETS.sfx[i] ? `scene-${String(i+1).padStart(3,'0')}-sfx.mp3` : null
    };
    if(ASSETS.images[i]){ const b=await fetch(ASSETS.images[i]).then(r=>r.blob()); zip.file(manifest.scenes[i].image,b); }
    if(ASSETS.narration[i]){ const b=await fetch(ASSETS.narration[i]).then(r=>r.blob()); zip.file(manifest.scenes[i].narration,b); }
    if(ASSETS.sfx[i]){ const b=await fetch(ASSETS.sfx[i]).then(r=>r.blob()); zip.file(manifest.scenes[i].sfx,b); }
  }
  zip.file('manifest.json', JSON.stringify(manifest,null,2));
  const blob=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='BookAnimator_Project.zip'; a.click();
};

/* ========== export WebM (beta) ========== */
$('btnVideo').onclick = async ()=>{
  if(!ASSETS.images.length) return alert('Generate scenes first.');
  const fps=30, perSceneSec=4;
  const canvas=$('videoPreview'), ctx=canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;

  // audio mix
  const AC=new (window.AudioContext||window.webkitAudioContext)();
  const dest=AC.createMediaStreamDestination();
  const audios = ASSETS.narration.map((u,i)=>u || ASSETS.sfx[i] || null).map(u=>{
    if(!u) return null;
    const el=new Audio(u); el.crossOrigin='anonymous';
    const src=AC.createMediaElementSource(el);
    src.connect(dest); src.connect(AC.destination);
    return el;
  });

  const stream=canvas.captureStream(fps);
  const merged=new MediaStream([...stream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
  const rec = new MediaRecorder(merged, {mimeType:'video/webm'});
  const chunks=[]; rec.ondataavailable=e=>{ if(e.data.size) chunks.push(e.data); };
  rec.onstop=()=>{
    const blob=new Blob(chunks,{type:'video/webm'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='BookAnimator_Slideshow.webm'; a.click();
  };
  rec.start();

  function drawFit(img){
    const iw=img.width, ih=img.height;
    const s=Math.max(W/iw,H/ih); const nw=iw*s, nh=ih*s;
    const dx=(W-nw)/2, dy=(H-nh)/2;
    ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
    ctx.drawImage(img,dx,dy,nw,nh);
  }

  for(let i=0;i<ASSETS.images.length;i++){
    const img=new Image(); img.src=ASSETS.images[i];
    try{ await img.decode(); }catch{}
    drawFit(img);
    if(audios[i]){ try{ await audios[i].play(); }catch{} }
    const end=performance.now()+perSceneSec*1000;
    while(performance.now()<end){ await new Promise(r=>requestAnimationFrame(r)); }
    if(audios[i]){ audios[i].pause(); audios[i].currentTime=0; }
  }
  rec.stop();
};

/* ========== misc ========== */
$('btnSave').onclick=()=>{save('ba_settings',SETTINGS); save('ba_secrets',SECRETS); save('ba_chars',CHARS); alert('Saved to this browser.');};
$('btnClearThumbs').onclick=()=>{$('thumbs').innerHTML=''; ASSETS={images:[],narration:[],sfx:[]};};
$('btnWipe').onclick=()=>{localStorage.removeItem('ba_settings'); localStorage.removeItem('ba_secrets'); localStorage.removeItem('ba_chars'); alert('Cleared saved data. Reload the page.');};
</script>
</body>
</html>
