<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Book Animator</title>
<style>
  :root{
    --bg:#0b0b0b; --panel:#111; --ink:#eee; --muted:#bbb;
    --line:#333; --accent:#ef4444; --ok:#34d399; --warn:#f59e0b;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;}
  h1{font-size:2.6rem;margin:1.1rem 0;text-align:center}
  .wrap{max-width:1200px;margin:0 auto;padding:1rem;}
  .panel{background:var(--panel);border:1px solid var(--line);
    padding:1rem;border-radius:1rem;margin-bottom:1rem;}
  .item{margin-bottom:.8rem;display:flex;flex-direction:column;}
  .item span{font-weight:600;margin-bottom:.4rem;}
  button{background:var(--accent);border:none;color:var(--ink);
    padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;font-size:1rem;}
  button:hover{opacity:.85;}
  select,input,textarea{background:#222;color:var(--ink);border:1px solid var(--line);
    border-radius:.4rem;padding:.4rem;}
  textarea{resize:vertical;}
  #charList{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
    gap:.8rem;}
  .charCard{background:#1a1a1a;border:1px solid var(--line);
    border-radius:.8rem;padding:.6rem;text-align:center;cursor:pointer;position:relative;}
  .charCard:hover{border-color:var(--accent);}
  .charVoice{font-size:.9rem;color:var(--muted);}
  .playBtn{position:absolute;top:.4rem;right:.5rem;background:var(--ok);
    color:#000;border:none;border-radius:50%;width:26px;height:26px;cursor:pointer;font-weight:bold;}
  .playBtn:hover{opacity:.8;}
  .status{margin-top:.5rem;font-size:.9rem;color:var(--muted);}
  #autosaveStatus{font-size:.85rem;color:var(--muted);text-align:center;margin-top:.5rem;}
  footer{text-align:center;color:var(--muted);margin-top:1rem;font-size:.85rem;}
</style>
</head>
<body>
  <h1>ðŸ“š Book Animator</h1>

  <div class="wrap">
    <div class="panel">
      <h2>Characters</h2>
      <div id="charList"></div>
      <button id="btnAddChar">+ Add Character</button>
      <div id="autosaveStatus">Autosave ready</div>
    </div>

    <div class="panel">
      <h2>Uploads</h2>
      <label class="item">
        <span>Music Uploads</span>
        <input id="fileMusic" type="file" accept="audio/*" multiple/>
      </label>
      <label class="item">
        <span>General Uploads</span>
        <input id="fileGeneral" type="file" accept="*/*" multiple/>
      </label>
      <div id="uploadList" class="status">No files uploaded yet.</div>
    </div>
  </div>

  <dialog id="charEditor" style="background:#111;border:1px solid var(--line);
    border-radius:1rem;padding:1.2rem;width:400px;max-width:90%;">
    <h3>Edit Character</h3>

    <label class="item">
      <span>Name</span>
      <input id="ceName" type="text"/>
    </label>

    <label class="item">
      <span>Notes</span>
      <textarea id="ceNotes" rows="3"></textarea>
    </label>

    <label class="item" style="display:grid;grid-template-columns:10rem 1fr;gap:.6rem">
      <span>Voice (OpenAI)</span>
      <select id="ceVoice">
        <option value="ember">Ember</option>
        <option value="maple">Maple</option>
        <option value="juniper">Juniper</option>
        <option value="sage">Sage</option>
        <option value="alloy">Alloy</option>
        <option value="verse">Verse</option>
        <option value="aria">Aria</option>
        <option value="amber">Amber</option>
        <option value="spruce">Spruce</option>
        <option value="breeze">Breeze</option>
        <option value="vale">Vale</option>
        <option value="shimmer">Shimmer</option>
        <option value="cove">Cove</option>
        <option value="sol">Sol</option>
      </select>
    </label>

    <label class="item">
      <span>Eleven Labs Voice ID (optional)</span>
      <input id="ceEleven" type="text"/>
    </label>

    <label class="item">
      <span>Portrait (optional)</span>
      <input id="cePortrait" type="file" accept="image/*"/>
    </label>

    <div style="text-align:right;margin-top:.8rem;">
      <button id="ceSave">Save</button>
      <button id="ceCancel" style="background:var(--warn);">Cancel</button>
    </div>
  </dialog>

  <footer>Book Animator â€¢ Auto-Save + Voice Preview</footer>

<script>
let characters = [];
const charList = document.getElementById("charList");
const editor = document.getElementById("charEditor");
const uploadList = document.getElementById("uploadList");
const autosaveStatus = document.getElementById("autosaveStatus");

function defaultCharacters(){
  const base = [
    'Narrator','Sidetracked Sally','Darling Danielle','Dark Dan',
    'Skater Skip','Creative Callie','Zen Zena','Grumpy Gus','Ambush Annie'
  ];
  const voiceMap = {
    'narrator': 'ember','sidetracked sally': 'maple','sidetrack sally': 'maple',
    'darling danielle': 'juniper','dark dan': 'spruce','skater skip': 'breeze',
    'creative callie': 'vale','zen zena': 'shimmer','grumpy gus': 'cove','ambush annie': 'sol'
  };
  return base.map(n=>{
    const key = n.toLowerCase();
    return { name:n, notes:'', voice: voiceMap[key] || 'ember', eleven:'', portrait:'' };
  });
}

function renderCharacters(){
  charList.innerHTML = "";
  characters.forEach((c,i)=>{
    const div = document.createElement("div");
    div.className="charCard";
    div.innerHTML = `
      <div>${c.name}</div>
      <div class="charVoice">${c.voice}</div>
      <button class="playBtn" title="Preview Voice">ðŸ”Š</button>
    `;
    div.querySelector(".playBtn").onclick=(e)=>{
      e.stopPropagation();
      playVoicePreview(c.voice, c.name);
    };
    div.onclick=()=>openEditor(i);
    charList.appendChild(div);
  });
  autoSave();
}

async function playVoicePreview(voice, name){
  const proxyURL = "https://ai-proxydjs.8deaea231.workers.dev/v1/audio/speech";
  const text = `Hello, I am ${name}. This is my voice.`;
  autosaveStatus.textContent = "Generating voice preview...";
  try{
    const response = await fetch(proxyURL,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer OPENAI_API_KEY"
      },
      body:JSON.stringify({
        model:"gpt-4o-mini-tts",
        voice:voice,
        input:text
      })
    });
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const audio = new Audio(url);
    audio.play();
    autosaveStatus.textContent = `Playing ${name}'s voice`;
  }catch(err){
    console.error(err);
    autosaveStatus.textContent = "Voice preview failed.";
  }
}

function openEditor(index){
  const c = characters[index];
  editor.dataset.index=index;
  document.getElementById("ceName").value = c.name;
  document.getElementById("ceNotes").value = c.notes;
  document.getElementById("ceVoice").value = c.voice;
  document.getElementById("ceEleven").value = c.eleven;
  editor.showModal();
}

function saveEditor(){
  const i = editor.dataset.index;
  characters[i].name=document.getElementById("ceName").value;
  characters[i].notes=document.getElementById("ceNotes").value;
  characters[i].voice=document.getElementById("ceVoice").value;
  characters[i].eleven=document.getElementById("ceEleven").value;
  editor.close();
  renderCharacters();
}

function addCharacter(){
  characters.push({name:"New Character",notes:"",voice:"ember",eleven:"",portrait:""});
  renderCharacters();
}

const fileMusic = document.getElementById("fileMusic");
const fileGeneral = document.getElementById("fileGeneral");

function listFiles(input){
  if(!input.files.length){return;}
  const names=[...input.files].map(f=>f.name);
  uploadList.innerHTML = "Uploaded:<br>"+names.join("<br>");
  autoSave();
}
fileMusic.addEventListener("change",()=>listFiles(fileMusic));
fileGeneral.addEventListener("change",()=>listFiles(fileGeneral));

function autoSave(){
  const data = {characters, uploads: uploadList.innerHTML};
  localStorage.setItem("bookAnimatorData", JSON.stringify(data));
  autosaveStatus.textContent = "Autosaved âœ“ " + new Date().toLocaleTimeString();
}
function autoLoad(){
  const saved = localStorage.getItem("bookAnimatorData");
  if(saved){
    try{
      const data = JSON.parse(saved);
      if(data.characters){ characters = data.characters; }
      if(data.uploads){ uploadList.innerHTML = data.uploads; }
      autosaveStatus.textContent = "Loaded saved data.";
    }catch(e){ console.warn("Could not load saved data:", e); }
  } else {
    characters = defaultCharacters();
    autosaveStatus.textContent = "Default characters loaded.";
  }
}
setInterval(autoSave, 600000);

document.getElementById("btnAddChar").onclick=addCharacter;
document.getElementById("ceSave").onclick=saveEditor;
document.getElementById("ceCancel").onclick=()=>editor.close();

autoLoad();
renderCharacters();
</script>
</body>
</html>
