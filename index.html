<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Book Animator</title>

<!-- JSZip for ZIP export -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<!-- PDF.js (for importing character images from your PDFs) -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.min.js";
</script>

<style>
  :root{ --bg:#000; --fg:#fff; --muted:#cfcfcf; --panel:#0e0e0e; --border:#2a2a2a; --accent:#ff2d2d; --accent-hover:#ff4747; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  .wrap{max-width:900px;margin:4rem auto 6.5rem;padding:0 1rem}
  h1{margin:0 0 1rem;text-align:center;font-size:2rem;font-weight:800}
  label{display:block;margin:.5rem 0;font-weight:600;color:var(--muted)}
  textarea{width:100%;min-height:300px;padding:1rem;border-radius:10px;background:#0b0b0b;color:var(--fg);border:1px solid var(--border);font-size:1rem;line-height:1.5;resize:none;outline:none}
  textarea:focus{box-shadow:0 0 0 2px rgba(255,45,45,.35);border-color:var(--accent)}
  /* Buttons */
  .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:.7rem 1rem;cursor:pointer;font-weight:800}
  .btn:hover{background:var(--accent-hover)}
  .btn-outline{background:transparent;color:#fff;border:2px solid var(--accent);border-radius:10px;padding:.6rem 1rem;cursor:pointer;font-weight:800}
  .btn-outline:hover{background:rgba(255,45,45,.15)}
  .btn-danger{background:#b31313}
  .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:12px}
  .row{display:flex;gap:12px;align-items:center}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .input,.select,.area{background:#0f0f0f;color:#fff;border:1px solid var(--border);border-radius:8px;padding:.55rem .65rem}
  .area{min-height:90px}
  .list{border:1px solid var(--border);border-radius:10px;padding:.5rem;max-height:320px;overflow:auto}
  .thumb{width:48px;height:48px;border-radius:8px;object-fit:cover;border:1px solid var(--border);background:#111}
  /* Hamburgers & menus */
  .hambtn{position:fixed;top:.75rem;z-index:1000;width:46px;height:46px;display:grid;place-items:center;background:var(--panel);color:var(--fg);border:2px solid var(--accent);border-radius:12px;cursor:pointer;font-size:1.35rem;font-weight:800;box-shadow:0 4px 14px rgba(0,0,0,.45)}
  .hambtn.left{left:.75rem} .hambtn.right{right:.75rem}
  .menu{position:fixed;top:3.9rem;z-index:999;min-width:280px;background:var(--panel);color:var(--fg);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:0 14px 40px rgba(0,0,0,.55)}
  .menu.left{left:.75rem} .menu.right{right:.75rem}
  .item{padding:.75rem .95rem;cursor:pointer;border-bottom:1px solid var(--border)}
  .item:last-child{border-bottom:none}
  .item:hover{background:#111}
  /* Modal */
  .mask{position:fixed;inset:0;display:none;place-items:center;z-index:1100;background:rgba(0,0,0,.6)}
  .mask.show{display:grid}
  .modal{width:min(96vw,1000px);background:#0d0d0d;color:var(--fg);border:1px solid var(--border);border-radius:14px;box-shadow:0 24px 80px rgba(0,0,0,.7);padding:1rem 1.25rem}
  /* PDF grid */
  .pdfgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;max-height:60vh;overflow:auto;margin-top:.5rem}
  .pdfthumb{background:#111;border:1px solid var(--border);border-radius:10px;padding:6px;display:flex;flex-direction:column;gap:6px}
  .pdfthumb canvas{width:100%;height:auto;border-radius:6px;border:1px solid #222}
  .pdfthumb .cap{font-size:.9rem;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
  /* Progress bar (bottom) */
  .progress-wrap{position:fixed;left:0;right:0;bottom:0;background:#0a0a0a;border-top:1px solid var(--border);padding:.55rem 1rem;z-index:900}
  .progress-row{display:flex;gap:12px;align-items:center;max-width:900px;margin:0 auto;color:var(--muted)}
  .bar{flex:1;height:10px;background:#1a1a1a;border-radius:6px;overflow:hidden;border:1px solid #222}
  .fill{height:100%;background:var(--accent);width:0%}
</style>
</head>
<body>
  <!-- Hamburgers -->
  <button id="btnLeft"  class="hambtn left"  aria-label="Open left menu">≡</button>
  <button id="btnRight" class="hambtn right" aria-label="Open right menu">≡</button>

  <!-- Left menu -->
  <div id="menuLeft" class="menu left" hidden>
    <div class="item" data-left="settings">Settings</div>
    <div class="item" data-left="characters">Characters</div>
    <div class="item" data-left="importpdf">Import Images (PDF)</div>
    <div class="item" data-left="assets">Assets</div>
    <div class="item" data-left="secrets">Secrets (API Keys)</div>
    <div class="item" data-left="tutorial">Tutorial</div>
    <div class="item" data-left="about">About</div>
  </div>

  <!-- Right menu -->
  <div id="menuRight" class="menu right" hidden>
    <div class="item" data-right="new">New Project</div>
    <div class="item" data-right="save">Save Project</div>
    <div class="item" data-right="open">Open Project</div>
    <div class="item" data-right="exportZip">Export Finished (ZIP)</div>
    <div class="item" data-right="exit">Exit</div>
  </div>

  <!-- Main -->
  <div class="wrap">
    <h1>Book Animator</h1>
    <label for="bookText">Paste your book text:</label>
    <textarea id="bookText" placeholder="Paste text here…"></textarea>

    <div class="actions">
      <div class="row" style="gap:8px">
        <button class="btn" id="btnStart">Start Animation</button>
        <button class="btn-outline" id="btnPreviewScenes">Preview Scenes</button>
      </div>
      <div class="row" style="gap:8px">
        <button class="btn-outline" id="btnSave">Save</button>
        <button class="btn" id="btnExportZip">Export Finished (ZIP)</button>
      </div>
    </div>

    <div id="scenePreview" class="list" style="margin-top:12px;display:none"></div>
  </div>

  <!-- Progress (bottom) -->
  <div class="progress-wrap" id="progressWrap" hidden>
    <div class="progress-row">
      <div id="progressLabel">Idle</div>
      <div class="bar"><div class="fill" id="progressFill"></div></div>
      <button class="btn-outline" id="btnProgStop">Stop</button>
    </div>
  </div>

  <!-- Modal -->
  <div id="mask" class="mask" role="dialog" aria-modal="true" aria-hidden="true">
    <div id="modal" class="modal" role="document"></div>
  </div>

<script>
/* ===== Keys & storage ===== */
const KEY_TEXT="bookAnimator:text", KEY_CFG="bookAnimator:settings", KEY_CHARS="bookAnimator:characters", KEY_ASSETS="bookAnimator:assets", KEY_FRAMES="bookAnimator:frames", KEY_OPENAI="bookAnimator:openai";
function load(k,def){ try{ return JSON.parse(localStorage.getItem(k)) || def }catch{ return def } }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

/* ===== Default settings ===== */
const OPENAI_VOICES = ["Maple","Juniper","Spruce","Breeze","Vale","Shimmer","Cove","Sol","Ember","Nova","Alloy","Verse","Hikari","Ari","Mori","Sage","Amber","Copper","Pearl","Onyx"];
const ANIM_STYLES = ["Cartoon","Flipbook","Comic","Slideshow","Anime","Dark Fantasy","Lifelike","Stop-Motion","Motion-Comics","Pixar-Like","Minimalist Line-Art","Water-Ink","Claymation","Paper-Cut","Retro 8-bit","3D Toon"];
const ART_STYLES  = ["Fantasy","Anime","Noir","Watercolor","3D","Sketch","Oil Paint","Ink & Wash","Pixel Art","Low-Poly","Photoreal","Cel-shade","Vaporwave","Cyberpunk","Steampunk","Storybook"];
const ILLUST_MODES = ["OpenAI Images","Local Stub (no API)"]; // <— real mode is default now

const DEFAULT_SETTINGS={animationStyle:"Cartoon", artStyle:"Fantasy", aspect:"16:9", fps:24, audience:"Adults", illustrationMode:"OpenAI Images"};
let settings = load(KEY_CFG, DEFAULT_SETTINGS);

/* ===== Characters (your cast) ===== */
let characters = load(KEY_CHARS, [
  { id:"narrator", name:"Narrator", age:"", voice:"Ember", imageData:"", imageName:"", traits:"Neutral, clear, warm", backstory:"Default narrator voice." },
  { id:"c_sally", name:"Sidetracked Sally", age:"Teen/Young Adult", voice:"Maple", imageData:"", imageName:"", traits:"Blonde hair, blue eyes; easily distracted; notebook; flowing pink; dark-fantasy anime vibe", backstory:"Curious wanderer whose sidetracks uncover clues others miss." },
  { id:"c_zen", name:"Zen Zena", age:"Adult", voice:"Shimmer", imageData:"", imageName:"", traits:"Silver/white hair; calm strategist; blind; tea; flowing robes", backstory:"Serene mentor with patience and foresight." },
  { id:"c_skip", name:"Skater Skip (Chris)", age:"Teen/Young Adult", voice:"Breeze", imageData:"", imageName:"", traits:"Long blonde bun; skater gear; athletic; fantasy touches", backstory:"Adrenaline junkie; uses board skills for bold rescues." },
  { id:"c_dan", name:"Dark Dan (Darwin)", age:"Adult", voice:"Spruce", imageData:"", imageName:"", traits:"Dark hair; lip piercing; gauged ears; gothic armor", backstory:"Brooding protector with a strict code." },
  { id:"c_danielle", name:"Darling Danielle (Dakota)", age:"Adult", voice:"Juniper", imageData:"", imageName:"", traits:"Pregnant; blonde; warm, nurturing", backstory:"Heart of the crew; compassion in danger." },
  { id:"c_gus", name:"Grumpy Gus (Bob)", age:"Older Adult", voice:"Cove", imageData:"", imageName:"", traits:"Short military cut; long gray goatee; gruff but loyal", backstory:"Gruff veteran whose loyalty shows when it matters." },
  { id:"c_annie", name:"Ambush Annie (Amy)", age:"Adult", voice:"Sol", imageData:"", imageName:"", traits:"Dark hair; round face; tactical armor", backstory:"Ambush specialist executing precise strikes." },
  { id:"c_callie", name:"Creative Callie", age:"Young Adult", voice:"Vale", imageData:"", imageName:"", traits:"Inventive; quick with ideas and sketches", backstory:"Concept artist of the crew." },
  { id:"c_dominic", name:"Dominic (The Dominator)", age:"Teen", voice:"Verse", imageData:"", imageName:"", traits:"Farm kid; blonde; blue eyes; witty; slingshot; hero suit", backstory:"Teen hero protecting home and family." },
  { id:"c_naomi", name:"Naomi", age:"Younger Sister", voice:"Nova", imageData:"", imageName:"", traits:"Looks up to Dominic; loves animals", backstory:"Brings heart and levity to the farm." },
  { id:"c_oliver", name:"Oliver", age:"Teen (adopted)", voice:"Ari", imageData:"", imageName:"", traits:"Adopted; complex past; letters to grandmother", backstory:"Finding belonging while processing the past." },
  { id:"c_teddy", name:"Teddy", age:"Young Brother", voice:"Mori", imageData:"", imageName:"", traits:"Curious, playful, energetic", backstory:"Tiny sidekick sparking mini adventures." },
  { id:"c_journey", name:"Journey", age:"4–5", voice:"Pearl", imageData:"", imageName:"", traits:"Light brown hair; brown eyes; white dress; playful", backstory:"Imaginative child starting each adventure." },
  { id:"c_sophie", name:"Sophie", age:"6–7", voice:"Sage", imageData:"", imageName:"", traits:"Dirty-blonde; green eyes; big-sister energy", backstory:"Protective older sister." },
  { id:"c_abby", name:"Abby (Mom)", age:"Adult", voice:"Amber", imageData:"", imageName:"", traits:"Long dark hair; patient; loving", backstory:"Gentle guide anchoring the family." },
  { id:"c_mark", name:"Mark (Dad)", age:"Adult", voice:"Alloy", imageData:"", imageName:"", traits:"Light red hair; playful; fun", backstory:"Dad jokes keep spirits high." },
  { id:"c_bear", name:"Bear (Dog)", age:"Pup", voice:"Onyx", imageData:"", imageName:"", traits:"Faithful dog; senses trouble early", backstory:"Four-legged companion." }
]);

let assets = load(KEY_ASSETS, []);
let frames = load(KEY_FRAMES, []);
const ta = document.getElementById("bookText");
if(localStorage.getItem(KEY_TEXT)) ta.value = localStorage.getItem(KEY_TEXT);

/* ===== UI helpers ===== */
function val(id){ return document.getElementById(id).value }
function esc(s){return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]))}
const mask=document.getElementById("mask"), modal=document.getElementById("modal");
function openModal(html){ modal.innerHTML=html; mask.classList.add("show"); }
function closeModal(){ mask.classList.remove("show"); modal.innerHTML=""; }

/* ===== Menus ===== */
const btnLeft=document.getElementById("btnLeft"), btnRight=document.getElementById("btnRight");
const menuLeft=document.getElementById("menuLeft"), menuRight=document.getElementById("menuRight");
btnLeft.onclick=e=>{ menuLeft.hidden=!menuLeft.hidden; menuRight.hidden=true; };
btnRight.onclick=e=>{ menuRight.hidden=!menuRight.hidden; menuLeft.hidden=true; };
document.addEventListener("click", (e)=>{ if(!e.target.closest(".menu") && !e.target.closest(".hambtn")){ menuLeft.hidden=true; menuRight.hidden=true; }});
mask.onclick=e=>{ if(e.target===mask) closeModal(); };

/* ===== Buttons ===== */
document.getElementById("btnSave").onclick = ()=>{ save(KEY_TEXT, ta.value||""); alert("Saved."); };
document.getElementById("btnExportZip").onclick = exportZip;
document.getElementById("btnPreviewScenes").onclick = previewScenes;

/* ===== Right menu actions ===== */
menuRight.onclick = (e)=>{
  const a=e.target?.dataset?.right; if(!a) return; menuRight.hidden=true;
  if(a==="new"){ if(confirm("Clear text?")) ta.value = ""; }
  if(a==="save"){ save(KEY_TEXT, ta.value||""); alert("Saved to browser storage."); }
  if(a==="open") openProject();
  if(a==="exportZip") exportZip();
};

/* ===== Left menu actions ===== */
menuLeft.onclick = (e)=>{
  const a=e.target?.dataset?.left; if(!a) return; menuLeft.hidden=true;
  if(a==="settings") showSettings();
  if(a==="characters") showCharacters();
  if(a==="importpdf") showPdfImport();
  if(a==="assets") showAssets();
  if(a==="secrets") showSecrets();
  if(a==="tutorial") alert("Tutorial:\n1) Paste text\n2) Settings/Characters\n3) (Optional) Import PDF images\n4) START\n5) Export ZIP.");
  if(a==="about") alert("Book Animator — single-file app with OpenAI Images integration and Start button.");
};

/* ===== Settings (includes Illustration Mode) ===== */
function showSettings(){
  openModal(`
    <h2>Settings</h2>
    <div class="grid">
      <div class="field"><label>Animation style</label>
        <select id="stAnim" class="select">${ANIM_STYLES.map(o=>`<option ${o===settings.animationStyle?"selected":""}>${o}</option>`).join("")}</select>
      </div>
      <div class="field"><label>Art style</label>
        <select id="stArt" class="select">${ART_STYLES.map(o=>`<option ${o===settings.artStyle?"selected":""}>${o}</option>`).join("")}</select>
      </div>
      <div class="field"><label>Illustration Mode</label>
        <select id="stIll" class="select">${ILLUST_MODES.map(o=>`<option ${o===settings.illustrationMode?"selected":""}>${o}</option>`).join("")}</select>
      </div>
      <div class="field"><label>Aspect</label>
        <select id="stAspect" class="select">${["16:9","9:16","1:1","4:3","21:9"].map(o=>`<option ${o===settings.aspect?"selected":""}>${o}</option>`).join("")}</select>
      </div>
      <div class="field"><label>FPS</label><input id="stFps" class="input" type="number" min="12" max="60" value="${settings.fps}"/></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button class="btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn" onclick="(function(){
        settings.animationStyle=val('stAnim'); settings.artStyle=val('stArt');
        settings.illustrationMode=val('stIll'); settings.aspect=val('stAspect');
        settings.fps=parseInt(val('stFps'))||24; save(KEY_CFG,settings);
        closeModal(); alert('Settings saved.');
      })()">Save</button>
    </div>
  `);
}

/* ===== Secrets (API Keys) ===== */
function showSecrets(){
  const current = load(KEY_OPENAI, {apiKey:""});
  openModal(`
    <h2>Secrets (API Keys)</h2>
    <div class="field"><label>OpenAI API Key</label>
      <input id="openaiKey" class="input" placeholder="sk-..." value="${esc(current.apiKey||"")}"/>
      <small style="color:var(--muted)">Stored locally on this device. Used only to call OpenAI Images from your browser.</small>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button class="btn-outline" onclick="closeModal()">Close</button>
      <button class="btn" onclick="(function(){ const k=document.getElementById('openaiKey').value.trim(); save(KEY_OPENAI,{apiKey:k}); closeModal(); alert('Saved API key.'); })()">Save Key</button>
    </div>
  `);
}
function getOpenAIKey(){
  const s = load(KEY_OPENAI, {apiKey:""}); return (s && s.apiKey) ? s.apiKey.trim() : "";
}

/* ===== Characters (edit & image upload) ===== */
function showCharacters(){
  openModal(`
    <h2>Characters</h2>
    <div class="list" id="charList">
      ${characters.map(c=>`
        <div class="row" style="justify-content:space-between;border-bottom:1px solid var(--border);padding:.4rem 0">
          <div class="row" style="gap:10px;align-items:center">
            ${c.imageData?`<img class="thumb" src="${c.imageData}" alt="${esc(c.name)}"/>`:`<div class="thumb" title="No image"></div>`}
            <div><b>${esc(c.name)}</b><div class="small" style="color:var(--muted)">${esc(c.voice||"-")} · ${esc(c.age||"-")}</div></div>
          </div>
          <div class="row" style="gap:6px">
            <button class="btn-outline" onclick="editChar('${c.id}')">Edit</button>
            ${c.id!=="narrator"?`<button class="btn btn-danger" onclick="delChar('${c.id}')">Delete</button>`:""}
          </div>
        </div>
      `).join("")}
    </div>
    <h3 style="margin:.85rem 0 .5rem">Add Character</h3>
    <div class="grid">
      <div class="field"><label>Name</label><input class="input" id="cName"/></div>
      <div class="field"><label>Age</label><input class="input" id="cAge"/></div>
      <div class="field"><label>Voice</label>
        <select class="select" id="cVoice">${OPENAI_VOICES.map(v=>`<option>${v}</option>`).join("")}</select>
      </div>
      <div class="field"><label>Image</label><input class="input" type="file" id="cImg" accept="image/*"/></div>
      <div class="field"><label>Traits</label><input class="input" id="cTraits" placeholder="brave, sarcastic, loyal"/></div>
      <div class="field" style="grid-column:1/-1"><label>Backstory</label><textarea class="area" id="cBack"></textarea></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button class="btn-outline" onclick="closeModal()">Close</button>
      <button class="btn" onclick="saveNewCharacter()">Save Character</button>
    </div>
  `);
}
async function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
async function saveNewCharacter(){
  const name = (document.getElementById("cName").value||"").trim(); if(!name) return alert("Name is required.");
  const age = (document.getElementById("cAge").value||"").trim();
  const voice = document.getElementById("cVoice").value;
  const traits = (document.getElementById("cTraits").value||"").trim();
  const backstory = (document.getElementById("cBack").value||"").trim();
  let imageData="", imageName="";
  const f = document.getElementById("cImg").files?.[0]; if(f){ imageData=await readFileAsDataURL(f); imageName=f.name; }
  characters.push({ id:"c_"+Math.random().toString(36).slice(2,9), name, age, voice, imageData, imageName, traits, backstory });
  save(KEY_CHARS, characters); showCharacters();
}
function delChar(id){ if(!confirm("Delete this character?")) return; characters = characters.filter(x=>x.id!==id); save(KEY_CHARS, characters); showCharacters(); }
function editChar(id){
  const c = characters.find(x=>x.id===id); if(!c) return;
  openModal(`
    <h2>Edit Character</h2>
    <div class="grid">
      <div class="field"><label>Name</label><input class="input" id="eName" value="${esc(c.name)}"/></div>
      <div class="field"><label>Age</label><input class="input" id="eAge" value="${esc(c.age||"")}"/></div>
      <div class="field"><label>Voice</label>
        <select class="select" id="eVoice">${OPENAI_VOICES.map(v=>`<option ${v===c.voice?"selected":""}>${v}</option>`).join("")}</select>
      </div>
      <div class="field"><label>Replace Image</label><input class="input" type="file" id="eImg" accept="image/*"/></div>
      <div class="field"><label>Traits</label><input class="input" id="eTraits" value="${esc(c.traits||"")}"/></div>
      <div class="field" style="grid-column:1/-1"><label>Backstory</label><textarea class="area" id="eBack">${esc(c.backstory||"")}</textarea></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button class="btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn" onclick="saveCharEdit('${c.id}')">Save</button>
    </div>
  `);
}
async function saveCharEdit(id){
  const c = characters.find(x=>x.id===id); if(!c) return;
  c.name = document.getElementById("eName").value.trim();
  c.age = document.getElementById("eAge").value.trim();
  c.voice = document.getElementById("eVoice").value;
  c.traits = document.getElementById("eTraits").value.trim();
  c.backstory = document.getElementById("eBack").value.trim();
  const f = document.getElementById("eImg").files?.[0]; if(f){ c.imageData = await readFileAsDataURL(f); c.imageName=f.name; }
  save(KEY_CHARS, characters); showCharacters();
}

/* ===== PDF Importer ===== */
function showPdfImport(){
  openModal(`
    <h2>Import Images (PDF)</h2>
    <p class="small">Load your illustrated PDFs. Click a page to assign to a character.</p>
    <div class="row" style="gap:8px;flex-wrap:wrap">
      <input type="file" id="pdfFile" accept="application/pdf" class="input" />
      <button class="btn" id="btnLoadPdf">Load PDF</button>
      <button class="btn-outline" onclick="closeModal()">Close</button>
    </div>
    <div id="pdfName" class="small" style="margin-top:.5rem;color:var(--muted)"></div>
    <div id="pdfGrid" class="pdfgrid" style="margin-top:.5rem"></div>
  `);
  document.getElementById("btnLoadPdf").onclick = async ()=>{
    const f = document.getElementById("pdfFile").files?.[0];
    if(!f) return alert("Choose a PDF first.");
    document.getElementById("pdfName").textContent = f.name;
    const ab = await f.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:ab}).promise;
    const grid = document.getElementById("pdfGrid"); grid.innerHTML="";
    for(let p=1;p<=pdf.numPages;p++){
      const page = await pdf.getPage(p);
      const viewport = page.getViewport({scale:0.4});
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = Math.floor(viewport.width);
      canvas.height= Math.floor(viewport.height);
      await page.render({canvasContext:ctx, viewport}).promise;

      const card = document.createElement("div"); card.className = "pdfthumb";
      const cap = document.createElement("div"); cap.className = "cap";
      cap.innerHTML = `<span>Page ${p}</span> <button class="btn-outline" data-p="${p}">Assign…</button>`;
      card.appendChild(canvas); card.appendChild(cap); grid.appendChild(card);

      cap.querySelector("button").onclick = ()=>{
        const dataURL = canvas.toDataURL("image/jpeg", 0.9);
        pickCharacterAndAssign(dataURL, f.name + " - page " + p + ".jpg");
      };
    }
  };
}
function pickCharacterAndAssign(dataURL, suggestedName){
  const opts = characters.map((c)=>`<option value="${c.id}">${esc(c.name)}</option>`).join("");
  openModal(`
    <h2>Assign Image to Character</h2>
    <div class="row" style="align-items:flex-start;gap:16px">
      <img src="${dataURL}" style="max-width:240px;border:1px solid var(--border);border-radius:10px"/>
      <div class="field" style="flex:1">
        <label>Character</label>
        <select id="assignChar" class="select">${opts}</select>
        <label style="margin-top:.5rem">Image name</label>
        <input id="assignName" class="input" value="${esc(suggestedName)}"/>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button class="btn-outline" onclick="showCharacters()">Cancel</button>
      <button class="btn" onclick="(function(){
        const id = document.getElementById('assignChar').value;
        const nm = document.getElementById('assignName').value;
        const c = characters.find(x=>x.id===id);
        if(c){ c.imageData = dataURL; c.imageName = nm; save(KEY_CHARS, characters); }
        showCharacters();
      })()">Assign</button>
    </div>
  `);
}

/* ===== Scenes & Start Animation ===== */
function splitIntoScenes(text){
  return text.split(/\n\s*\n/g).map(s=>s.trim()).filter(Boolean).map((t,i)=>({index:i, text:t}));
}
function previewScenes(){
  const scenes = splitIntoScenes(ta.value||"");
  const box = document.getElementById("scenePreview");
  if(!scenes.length){ box.style.display="none"; alert("No scenes found. Add blank lines between paragraphs to create scenes."); return; }
  box.style.display="block";
  box.innerHTML = scenes.map(s=>`<div style="padding:.5rem;border-bottom:1px solid var(--border)"><b>Scene ${s.index+1}</b><div class="small" style="color:var(--muted)">${esc((s.text.slice(0,200)+'…').replace(/\n/g,' '))}</div></div>`).join("");
}

const progWrap  = document.getElementById("progressWrap");
const progFill  = document.getElementById("progressFill");
const progLabel = document.getElementById("progressLabel");
const btnProgStop = document.getElementById("btnProgStop");
btnProgStop.onclick = ()=> stopPipeline = true;
let stopPipeline = false;
function resetProgress(){ progWrap.hidden=false; progFill.style.width="0%"; progLabel.textContent="Starting…"; }
function setProgress(p,label){ progFill.style.width = Math.max(0,Math.min(100,p))+"%"; progLabel.textContent = label; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

document.getElementById("btnStart").onclick = startAnimation;

async function startAnimation(){
  const scenes = splitIntoScenes(ta.value||"");
  if(!scenes.length){ alert("No scenes found. Add blank lines between paragraphs, then press Start."); return; }
  stopPipeline=false; resetProgress(); frames = [];
  const mode = settings.illustrationMode || "OpenAI Images";

  for(let i=0;i<scenes.length;i++){
    if(stopPipeline){ setProgress(0,"Stopped"); return; }
    const sc = scenes[i];
    setProgress(Math.round((i/scenes.length)*80)+10, `Illustrating scene ${i+1}/${scenes.length}…`);
    let dataURL = "";
    try{
      if(mode==="OpenAI Images"){
        dataURL = await illustrateWithOpenAI(sc, settings);
      }else{
        dataURL = await illustrateSceneStub(sc, settings.animationStyle, settings.artStyle);
      }
    }catch(err){
      console.error(err);
      dataURL = await illustrateSceneStub(sc, settings.animationStyle, settings.artStyle);
    }
    frames.push({ index: sc.index, dataURL });
    await sleep(150);
  }

  setProgress(100,"Done. Export ZIP to save frames.");
  save(KEY_FRAMES, frames);

  const box = document.getElementById("scenePreview");
  box.style.display="block";
  box.innerHTML = frames.map(f=>`<div class="row" style="gap:8px;border-bottom:1px solid var(--border);padding:.4rem 0"><img src="${f.dataURL}" class="thumb"/><div>Scene ${f.index+1}</div></div>`).join("");
}

/* ===== Local stub (fallback) ===== */
async function illustrateSceneStub(scene, styleText, artText){
  const W = 960, H = 540;
  const canvas = document.createElement("canvas");
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext("2d");
  const bgMap = {"Cartoon":"#151515","Flipbook":"#111","Comic":"#120f0f","Slideshow":"#0f1112","Anime":"#10121a","Dark Fantasy":"#0b0b12","Lifelike":"#0f0f0f","Stop-Motion":"#101010","Motion-Comics":"#110f14","Pixar-Like":"#0f1210","Minimalist Line-Art":"#0e0e0e","Water-Ink":"#0c0f12","Claymation":"#100e0e","Paper-Cut":"#12100e","Retro 8-bit":"#0e1012","3D Toon":"#0e1010"};
  ctx.fillStyle = bgMap[styleText] || "#0d0d0d"; ctx.fillRect(0,0,W,H);
  ctx.fillStyle = "rgba(255,45,45,0.25)"; ctx.fillRect(0,H-140,W,140);
  ctx.fillStyle = "#fff"; ctx.font = "700 28px system-ui"; ctx.fillText(`${styleText} · ${artText}`, 24, 50);
  ctx.font = "16px system-ui"; wrapText(ctx, scene.text.replace(/\s+/g,' ').slice(0,180), 24, 90, W-48, 22);
  ctx.font = "700 36px system-ui"; ctx.fillStyle="#ff2d2d"; ctx.fillText(`Scene ${scene.index+1}`, 24, H-90);
  ctx.font = "14px system-ui"; ctx.fillStyle="#fff"; ctx.fillText("Ken Burns / Parallax (stub)", 24, H-56);
  return canvas.toDataURL("image/jpeg", 0.9);
}
function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  const words = text.split(' '); let line = '';
  for (let n=0;n<words.length;n++){
    const testLine = line + words[n] + ' '; if (ctx.measureText(testLine).width > maxWidth && n>0){ ctx.fillText(line, x, y); line = words[n] + ' '; y += lineHeight; } else { line = testLine; }
  } ctx.fillText(line, x, y);
}

/* ===== OpenAI Images integration ===== */
async function illustrateWithOpenAI(scene, settings){
  const apiKey = getOpenAIKey();
  if(!apiKey){ throw new Error("Missing OpenAI API key. Add it in Secrets (API Keys)."); }

  // Build a prompt that respects style & art choices
  const style = settings.animationStyle || "Cartoon";
  const art   = settings.artStyle || "Fantasy";
  const prompt = `Illustrate this scene in a ${style} animation look with ${art} art direction. Clear focal subject, cinematic composition, storybook clarity, vibrant but not noisy. Scene text: """${scene.text.slice(0,800)}"""`;

  // Prefer gpt-image-1 (b64) but also accept URL responses
  const resp = await fetch("https://api.openai.com/v1/images/generations", {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+apiKey
    },
    body: JSON.stringify({
      model: "gpt-image-1",
      prompt,
      size: "1024x1024",
      n: 1,
      response_format: "b64_json"
    })
  });

  if(!resp.ok){
    const t = await resp.text();
    throw new Error("OpenAI error: "+t);
  }

  const data = await resp.json();
  // If API returns b64_json:
  if(data?.data?.[0]?.b64_json){
    return "data:image/jpeg;base64,"+data.data[0].b64_json;
  }
  // If API returns URL:
  if(data?.data?.[0]?.url){
    const imgUrl = data.data[0].url;
    const imgBlob = await (await fetch(imgUrl)).blob();
    return await blobToDataURL(imgBlob);
  }
  throw new Error("No image in response.");
}
function blobToDataURL(blob){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); }); }

/* ===== Project Open / ZIP Export ===== */
function openProject(){
  const input=document.createElement("input");
  input.type="file"; input.accept=".bookanim.json,application/json";
  input.onchange=async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const txt=await f.text(); const p=JSON.parse(txt);
      if(p.text!=null) document.getElementById("bookText").value=p.text;
      if(p.settings) settings=p.settings, save(KEY_CFG,settings);
      if(Array.isArray(p.characters)) characters=p.characters, save(KEY_CHARS,characters);
      if(Array.isArray(p.assets)) assets=p.assets, save(KEY_ASSETS,assets);
      if(Array.isArray(p.frames)) frames=p.frames, save(KEY_FRAMES,frames);
      alert("Project loaded.");
    }catch{ alert("Invalid project file."); }
  };
  input.click();
}
async function exportZip(){
  const zip = new JSZip();
  const project = { version:1, text: document.getElementById("bookText").value||"", settings, characters, assets, frames };
  zip.file("book-animator.bookanim.json", JSON.stringify(project, null, 2));
  zip.file("book-text.txt", project.text);
  zip.file("characters.json", JSON.stringify(characters.map(c=>({...c, imageData:undefined})), null, 2));
  zip.file("assets.json", JSON.stringify(assets, null, 2));

  const cf = zip.folder("characters");
  for(const c of characters){
    if(c.imageData && c.imageData.startsWith("data:")){
      const {mime, base64} = splitDataUrl(c.imageData);
      const ext = mimeToExt(mime);
      const safe = (c.name||"character").replace(/[^a-z0-9]+/gi,"_").slice(0,40);
      cf.file(`${safe}${ext}`, base64, {base64:true});
    }
  }
  if(frames?.length){
    const rf = zip.folder("renders");
    frames.forEach((f,i)=>{ const {base64} = splitDataUrl(f.dataURL); rf.file(`scene-${String(i+1).padStart(3,'0')}.jpg`, base64, {base64:true}); });
  }

  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = "BookAnimator_Finished.zip"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
}
function splitDataUrl(d){ const m = d.match(/^data:(.+?);base64,(.*)$/); return { mime: m?m[1]:"image/jpeg", base64: m?m[2]:"" }; }
function mimeToExt(m){ return m.includes("jpeg")?".jpg": m.includes("png")?".png": m.includes("webp")?".webp": ".bin"; }

/* ===== Assets (simple) ===== */
function showAssets(){
  openModal(`
    <h2>Assets</h2>
    <div class="list">${assets.map(a=>`
      <div class="row" style="justify-content:space-between;border-bottom:1px solid var(--border);padding:.4rem 0">
        <div><b>${esc(a.name||'(unnamed)')}</b><div class="small" style="color:var(--muted)">${esc(a.url||'')}</div></div>
        <div class="row" style="gap:6px">
          <button class="btn-outline" onclick="window.open('${a.url}','_blank')">Open</button>
          <button class="btn btn-danger" onclick="(function(){assets=assets.filter(x=>x.id!=='${a.id}'); save(KEY_ASSETS,assets); showAssets();})()">Delete</button>
        </div>
      </div>`).join("")||"<div class='small'>No assets yet</div>"}
    </div>
    <h3 style="margin:.85rem 0 .5rem">Add Asset</h3>
    <div class="grid">
      <div class="field"><label>Name</label><input id="aName" class="input"/></div>
      <div class="field" style="grid-column:1/-1"><label>URL</label><input id="aUrl" class="input" placeholder="https://..."/></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button class="btn-outline" onclick="closeModal()">Close</button>
      <button class="btn" onclick="(function(){
        const n=(document.getElementById('aName').value||'').trim(), u=(document.getElementById('aUrl').value||'').trim();
        if(!u) return alert('URL required');
        assets.push({id:'a_'+Math.random().toString(36).slice(2,9), name:n, url:u}); save(KEY_ASSETS, assets); showAssets();
      })()">Save Asset</button>
    </div>
  `);
}
</script>
</body>
</html>