<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Book Animator</title>
<style>
  :root{
    --bg:#0b0b0b; --panel:#111; --ink:#fff; --muted:#cfcfcf;
    --line:#2a2a2a; --accent:#ef4444; --ok:#34d399;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:1.2rem}
  h1{font-size:2.4rem;text-align:center;margin:1rem 0 1.2rem}
  .badge{display:inline-block;background:#141414;color:var(--muted);
    border:1px solid var(--line);padding:.25rem .6rem;border-radius:999px;font-size:.95rem;margin-right:.5rem}
  textarea{width:100%;min-height:280px;background:#0f0f0f;border:1px solid var(--line);
    border-radius:12px;color:#e7e7e7;font-size:1.05rem;line-height:1.5;padding:1rem;outline:none}
  .bar{display:flex;gap:.8rem;flex-wrap:wrap;margin-top:1rem}
  .btn{background:#181818;border:2px solid var(--accent);color:#fff;padding:.8rem 1.1rem;border-radius:14px;cursor:pointer}
  .btn.ghost{border-color:#555;color:#eee}
  .btn.small{padding:.45rem .7rem;border-radius:10px}
  .btn:hover{filter:brightness(1.08)}
  .topbar{display:flex;justify-content:space-between;align-items:center}
  .hamb{width:56px;height:56px;border:2px solid #fff;border-radius:14px;display:grid;place-items:center;background:#111;cursor:pointer}
  .hamb .line{width:28px;height:3px;background:#fff;margin:4px 0;border-radius:2px}
  .menu,.right,.modal{position:fixed;inset:0;background:#000a;display:none;
    align-items:flex-start;justify-content:center;padding-top:6vh;z-index:100}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:1rem;
    width:min(940px,92vw);max-height:80vh;overflow:auto;box-shadow:0 10px 40px #0009}
  .tabs{display:flex;gap:.5rem;margin:.25rem 0 1rem}
  .tabs .btn{border-color:#555}
  .section{display:none}
  .section.active{display:block}
  .list{display:flex;flex-direction:column;gap:.5rem}
  .item{display:flex;justify-content:space-between;align-items:center;background:#101010;border:1px solid var(--line);padding:.75rem 1rem;border-radius:12px}
  .row{display:flex;gap:.7rem;align-items:center}
  .row>span{width:12rem;color:#eaeaea}
  select,input[type="text"],input[type="password"],input[type="file"]{
    flex:1;background:#0f0f0f;border:1px solid var(--line);color:#fff;padding:.6rem .7rem;border-radius:10px}
  .thumbs{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem;margin:1.2rem 0}
  .thumb{height:120px;border:2px dashed #666;border-radius:12px;background:#0f0f0f;display:grid;place-items:center;color:#aaa;font-size:.9rem}
  .thumb img{width:100%;height:100%;object-fit:cover;border-radius:10px}
  .progress{position:fixed;left:0;right:0;bottom:0;background:#0d0d0d;border-top:1px solid #1a1a1a;padding:.6rem 1rem;display:flex;gap:1rem;align-items:center;z-index:50}
  .meter{flex:1;height:12px;background:#1a1a1a;border-radius:999px;position:relative;overflow:hidden}
  .meter::after{content:"";position:absolute;inset:0;transform:scaleX(var(--pct,0));transform-origin:left;background:#fff;border-radius:999px;transition:transform .12s ease}
  .pct{min-width:52px;text-align:right;color:#ddd}
  .hint{color:#bbb;font-size:.92rem}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="hamb" id="btnLeft" title="Menu left"><div class="line"></div><div class="line"></div><div class="line"></div></div>
    <h1>Book Animator</h1>
    <div class="hamb" id="btnRight" title="Menu right"><div class="line"></div><div class="line"></div><div class="line"></div></div>
  </div>

  <div style="display:flex;gap:.6rem;justify-content:center;margin:.4rem 0 1rem">
    <span class="badge">Mode: <b id="modeBadge">Simple</b></span>
    <span class="badge">Scenes: <b id="scenesBadge">0</b></span>
  </div>

  <h3>Paste your book text:</h3>
  <textarea id="bookText" placeholder="Paste text here…"></textarea>

  <div class="bar">
    <button class="btn" id="btnPreview">Preview Scenes</button>
    <button class="btn" style="background:var(--accent)" id="btnStart">Start Animation</button>
  </div>

  <div class="thumbs" id="thumbs"></div>
</div>

<!-- Footer progress -->
<div class="progress">
  <button class="btn small" id="btnSave">Save</button>
  <button class="btn small" id="btnZip">Export (ZIP)</button>
  <div class="meter" id="meter"></div>
  <div class="pct" id="pct">0%</div>
</div>

<!-- LEFT MENU -->
<div class="menu" id="leftMenu" aria-modal="true" role="dialog">
  <div class="card">
    <div class="tabs">
      <button class="btn small tab" data-tab="chars">Characters</button>
      <button class="btn small tab" data-tab="settings">Settings</button>
      <button class="btn small tab" data-tab="secrets">Secrets (API Keys)</button>
      <button class="btn small tab" data-tab="help">Help</button>
      <button class="btn small" id="closeLeft" style="margin-left:auto">Close</button>
    </div>

    <section id="chars" class="section active">
      <h2>Characters</h2>
      <div id="charList" class="list"></div>
      <p class="hint">Tap <b>Edit</b> to change name, notes, voice, and portrait.</p>
    </section>

    <section id="settings" class="section">
      <h2>Settings</h2>
      <div class="row"><span>Render mode</span>
        <select id="setMode"><option value="offline">Offline (no AI)</option><option value="online">Online AI (use keys)</option></select>
      </div>
      <div class="row"><span>Visual style</span>
        <select id="setStyle"><option>Comic</option><option>Cartoon</option><option>Anime</option><option>Dark Fantasy</option><option>Watercolor</option><option>Ink & Wash</option><option>Flat Toon</option><option>Retro Pixel</option></select>
      </div>
      <div class="row"><span>Auto SFX (Freesound)</span>
        <select id="setSfx"><option value="on">On</option><option value="off">Off</option></select>
      </div>
    </section>

    <section id="secrets" class="section">
      <h2>Secrets (stored only in this browser)</h2>
      <div class="row"><span>OpenAI API Key</span><input id="keyOpenAI" type="password" placeholder="sk-..."/></div>
      <div class="row"><span>ElevenLabs API Key</span><input id="key11" type="password" placeholder="eleven-..."/></div>
      <div class="row"><span>Freesound API Key</span><input id="keyFS" type="password" placeholder="your-freesound-key"/></div>
      <div class="bar" style="justify-content:flex-end"><button class="btn small" id="saveSecrets">Save Keys</button></div>
      <p class="hint">Keys never leave your device; they’re saved in <code>localStorage</code>.</p>
    </section>

    <section id="help" class="section">
      <h2>Help</h2>
      <ol>
        <li>Paste your text.</li>
        <li>Open <b>Characters</b> and set voices/portraits.</li>
        <li>Add API keys in <b>Secrets</b> if you want AI images/voices.</li>
        <li>Click <b>Start Animation</b>. Thumbnails will fill as scenes render.</li>
      </ol>
    </section>
  </div>
</div>

<!-- RIGHT MENU -->
<div class="right" id="rightMenu" aria-modal="true" role="dialog">
  <div class="card">
    <div class="tabs">
      <button class="btn small rtab" data-rtab="uploads">Uploads</button>
      <button class="btn small rtab" data-rtab="project">Project</button>
      <button class="btn small" id="closeRight" style="margin-left:auto">Close</button>
    </div>

    <section id="uploads" class="section active">
      <h2>Uploads</h2>
      <div class="row"><span>Music (global)</span><input id="fileMusic" type="file" accept="audio/*"/></div>
      <div class="row"><span>SFX (scene #)</span><input id="sfxIdx" type="text" placeholder="0"/></div>
      <div class="row"><span>Upload SFX</span><input id="fileSfx" type="file" accept="audio/*"/></div>
      <div class="row"><span>Import Characters JSON</span><input id="fileChars" type="file" accept="application/json"/></div>
    </section>

    <section id="project" class="section">
      <h2>Project</h2>
      <div class="bar">
        <button class="btn small" id="clearThumbs">Clear Thumbnails</button>
        <button class="btn small" id="wipe">Wipe Local Data</button>
      </div>
    </section>
  </div>
</div>

<!-- Character modal -->
<div class="modal" id="charModal">
  <div class="card" style="width:min(780px,92vw)">
    <h2>Edit Character</h2>
    <div class="row"><span>Name</span><input id="ceName" type="text"/></div>
    <div class="row"><span>Traits / Notes</span><input id="ceNotes" type="text" placeholder="personality, role…"/></div>
    <div class="row"><span>Voice (OpenAI)</span>
      <select id="ceVoice">
        <option value="alloy">Alloy</option><option value="aria">Aria</option>
        <option value="sage">Sage</option><option value="verse">Verse</option>
        <option value="amber">Amber</option><option value="ember">Ember</option>
      </select>
    </div>
    <div class="row"><span>Voice (11Labs ID)</span><input id="ce11" type="text" placeholder="optional"/></div>
    <div class="row"><span>Portrait</span><input id="cePortrait" type="file" accept="image/*"/></div>
    <div class="bar" style="justify-content:flex-end">
      <button class="btn small" id="ceCancel">Cancel</button>
      <button class="btn small" style="background:var(--accent)" id="ceSave">Save</button>
    </div>
  </div>
</div>

<script>
/* ---------- state ---------- */
const qs = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];
const UI = {
  leftBtn: qs('#btnLeft'), rightBtn: qs('#btnRight'),
  leftMenu: qs('#leftMenu'), rightMenu: qs('#rightMenu'),
  closeLeft: qs('#closeLeft'), closeRight: qs('#closeRight'),
  tabs: qsa('.tab'), rtabs: qsa('.rtab'),
  sections: { chars: qs('#chars'), settings: qs('#settings'), secrets: qs('#secrets'), help: qs('#help') },
  rsections: { uploads: qs('#uploads'), project: qs('#project') },
  charList: qs('#charList'),
  bookText: qs('#bookText'), thumbs: qs('#thumbs'),
  btnPreview: qs('#btnPreview'), btnStart: qs('#btnStart'),
  scenesBadge: qs('#scenesBadge'),
  btnSave: qs('#btnSave'), btnZip: qs('#btnZip'),
  meter: qs('#meter'), pct: qs('#pct'),
  // settings
  setMode: qs('#setMode'), setStyle: qs('#setStyle'), setSfx: qs('#setSfx'),
  // secrets
  keyOpenAI: qs('#keyOpenAI'), key11: qs('#key11'), keyFS: qs('#keyFS'), saveSecrets: qs('#saveSecrets'),
  // uploads
  fileMusic: qs('#fileMusic'), fileSfx: qs('#fileSfx'), sfxIdx: qs('#sfxIdx'), fileChars: qs('#fileChars'),
  // character modal
  charModal: qs('#charModal'), ceName: qs('#ceName'), ceNotes: qs('#ceNotes'),
  ceVoice: qs('#ceVoice'), ce11: qs('#ce11'), cePortrait: qs('#cePortrait'),
  ceSave: qs('#ceSave'), ceCancel: qs('#ceCancel'),
};
let SETTINGS = JSON.parse(localStorage.getItem('ba_settings')||'{}');
let SECRETS  = JSON.parse(localStorage.getItem('ba_secrets')||'{}');
let CHARACTERS = JSON.parse(localStorage.getItem('ba_characters')||'[]');
const DEFAULT_NAMES = ['Narrator','Sidetracked Sally','Darling Danielle','Dark Dan','Skater Skip','Creative Callie','Zen Zena','Grumpy Gus','Journey Mark','Abby','Bear','Zenzina','Cali','Maple','Guitarist','Wise Elder','Hero','Villain','Guide','Companion'];
if(!CHARACTERS.length){ CHARACTERS = DEFAULT_NAMES.map(n=>({name:n,notes:'',voice:'alloy',elevenId:'',portrait:''})); save('ba_characters',CHARACTERS); }
UI.bookText.value = localStorage.getItem('ba_text')||'';
hydrate(); renderChars(); renderThumbs(0);

/* ---------- helpers ---------- */
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function dataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }
function setPct(p){ UI.meter.style.setProperty('--pct', String(p/100)); UI.pct.textContent = Math.round(p)+'%'; }

/* ---------- menus & tabs ---------- */
UI.leftBtn.onclick = () => UI.leftMenu.style.display='flex';
UI.rightBtn.onclick = () => UI.rightMenu.style.display='flex';
UI.closeLeft.onclick = () => UI.leftMenu.style.display='none';
UI.closeRight.onclick = () => UI.rightMenu.style.display='none';
UI.tabs.forEach(b=>b.onclick=()=>{ qsa('.section').forEach(s=>s.classList.remove('active')); UI.sections[b.dataset.tab].classList.add('active'); });
UI.rtabs.forEach(b=>b.onclick=()=>{ qsa('.right .section').forEach(s=>s.classList.remove('active')); UI.rsections[b.dataset.rtab].classList.add('active'); });

/* ---------- settings & secrets ---------- */
function hydrate(){
  UI.setMode.value = SETTINGS.mode || 'offline';
  UI.setStyle.value = SETTINGS.style || 'Comic';
  UI.setSfx.value   = SETTINGS.sfx   || 'off';
  UI.keyOpenAI.value = (SECRETS.openai||'');
  UI.key11.value     = (SECRETS.eleven||'');
  UI.keyFS.value     = (SECRETS.freesound||'');
}
UI.saveSecrets.onclick = () => {
  SETTINGS.mode  = UI.setMode.value;
  SETTINGS.style = UI.setStyle.value;
  SETTINGS.sfx   = UI.setSfx.value;
  save('ba_settings', SETTINGS);
  SECRETS.openai    = UI.keyOpenAI.value.trim();
  SECRETS.eleven    = UI.key11.value.trim();
  SECRETS.freesound = UI.keyFS.value.trim();
  save('ba_secrets', SECRETS);
  alert('Saved.');
};

/* ---------- characters ---------- */
let editing = -1;
function renderChars(){
  UI.charList.innerHTML = '';
  CHARACTERS.forEach((c,i)=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div><b>${c.name}</b> <small style="color:#aaa">${c.voice||''}</small><br/><small style="color:#bbb">${c.notes||''}</small></div>
      <div class="row">
        ${c.portrait ? `<img src="${c.portrait}" alt="" style="width:42px;height:42px;border-radius:8px;border:1px solid #333;object-fit:cover;margin-right:.6rem">` : `<div style="width:42px;height:42px;border:1px dashed #555;border-radius:8px;display:grid;place-items:center;color:#888;font-size:.75rem;margin-right:.6rem">img</div>`}
        <button class="btn small">Edit</button>
      </div>`;
    row.querySelector('button').onclick = ()=>openEditor(i);
    UI.charList.appendChild(row);
  });
}
function openEditor(i){
  editing = i;
  const c = CHARACTERS[i];
  UI.ceName.value = c.name||'';
  UI.ceNotes.value = c.notes||'';
  UI.ceVoice.value = c.voice||'alloy';
  UI.ce11.value = c.elevenId||'';
  UI.cePortrait.value = '';
  UI.charModal.style.display='flex';
}
UI.ceCancel.onclick = ()=> UI.charModal.style.display='none';
UI.ceSave.onclick = async ()=>{
  const c = CHARACTERS[editing];
  c.name = UI.ceName.value.trim()||c.name;
  c.notes = UI.ceNotes.value.trim();
  c.voice = UI.ceVoice.value;
  c.elevenId = UI.ce11.value.trim();
  if(UI.cePortrait.files[0]) c.portrait = await dataURL(UI.cePortrait.files[0]);
  save('ba_characters', CHARACTERS);
  UI.charModal.style.display='none';
  renderChars();
};

/* ---------- uploads & project ---------- */
UI.fileChars.onchange = async e=>{
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  try { const json = JSON.parse(text);
    if(Array.isArray(json)){ CHARACTERS = json; save('ba_characters', CHARACTERS); renderChars(); alert('Characters imported.'); }
    else alert('JSON must be an array of character objects.');
  } catch(err){ alert('Invalid JSON.'); }
};
qs('#clearThumbs').onclick = ()=>{ UI.thumbs.innerHTML=''; };
qs('#wipe').onclick = ()=>{
  if(confirm('Clear all local data?')){ localStorage.clear(); location.reload(); }
};

/* ---------- main actions ---------- */
UI.bookText.addEventListener('input', ()=>localStorage.setItem('ba_text', UI.bookText.value));

UI.btnPreview.onclick = ()=>{
  const scenes = splitScenes(UI.bookText.value);
  UI.scenesBadge.textContent = String(scenes.length);
  renderThumbs(scenes.length);
};
UI.btnStart.onclick = async ()=>{
  const scenes = splitScenes(UI.bookText.value);
  UI.scenesBadge.textContent = String(scenes.length);
  renderThumbs(scenes.length);
  // Placeholder: simulate image creation (white progress + thumbnails)
  for(let i=0;i<scenes.length;i++){
    setPct((i/scenes.length)*100);
    await sleep(120); // simulate work
    const cell = UI.thumbs.children[i];
    cell.textContent=''; // replace label
    const p = document.createElement('div');
    p.style.cssText='width:100%;height:100%;display:grid;place-items:center;color:#ddd;font-size:.8rem;border:1px solid #333;border-radius:10px';
    p.textContent = `Scene ${i+1}`;
    cell.appendChild(p);
  }
  setPct(100);
};

UI.btnSave.onclick = ()=>{
  const blob = new Blob([UI.bookText.value], {type:'text/plain'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'script.txt'; a.click(); URL.revokeObjectURL(a.href);
};
UI.btnZip.onclick = ()=>{
  alert('ZIP export is stubbed in this build. (Will package script + thumbnails on next pass.)');
};

/* ---------- helpers ---------- */
function splitScenes(text){
  // naive: split by blank lines or '#scene'
  return text.trim().length ? text.split(/\n\s*\n|^#scene/gi).filter(Boolean) : [];
}
function renderThumbs(n){
  UI.thumbs.innerHTML = '';
  for(let i=0;i<n;i++){
    const d = document.createElement('div'); d.className='thumb'; d.textContent = `scene ${i+1}`;
    UI.thumbs.appendChild(d);
  }
}
const sleep = ms => new Promise(r=>setTimeout(r,ms));
</script>
</body>
</html>